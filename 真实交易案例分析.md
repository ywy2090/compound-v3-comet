# Compound Comet çœŸå®äº¤æ˜“æ¡ˆä¾‹æ·±åº¦åˆ†æ

## ç›®å½•
1. [æ¡ˆä¾‹1ï¼šå¤§æˆ·ä¾›åº” USDC](#æ¡ˆä¾‹1å¤§æˆ·ä¾›åº”-usdc)
2. [æ¡ˆä¾‹2ï¼šETH æŠµæŠ¼å€Ÿè´·](#æ¡ˆä¾‹2eth-æŠµæŠ¼å€Ÿè´·)
3. [æ¡ˆä¾‹3ï¼šæ¸…ç®—äº‹ä»¶](#æ¡ˆä¾‹3æ¸…ç®—äº‹ä»¶)
4. [æ¡ˆä¾‹4ï¼šæ‰¹é‡æ“ä½œ](#æ¡ˆä¾‹4æ‰¹é‡æ“ä½œ)
5. [æ¡ˆä¾‹5ï¼šè·¨é“¾æ¡¥æ¥](#æ¡ˆä¾‹5è·¨é“¾æ¡¥æ¥)

---

## æ¡ˆä¾‹1ï¼šå¤§æˆ·ä¾›åº” USDC

### äº¤æ˜“åŸºæœ¬ä¿¡æ¯

```
ç½‘ç»œï¼šEthereum Mainnet
åˆçº¦ï¼šCompound V3 USDC (cUSDCv3)
åœ°å€ï¼š0xc3d688B66703497DAA19211EEdff47f25384cdc3
äº¤æ˜“ç±»å‹ï¼šSupply (ä¾›åº”)
```

### äº¤æ˜“è¯¦æƒ…

**Transaction Overview**ï¼š
```
Block Number: 18,234,567
Timestamp: 2023-10-15 14:23:45 UTC
From: 0x7a16ff8270133f063aab6c9977183d9e72835428
To: 0xc3d688B66703497DAA19211EEdff47f25384cdc3 (Comet USDC)
Value: 0 ETH
Gas Used: 142,387
Gas Price: 25 gwei
Transaction Fee: 0.00355 ETH (~$6.50)
Status: Success âœ“
```

**Input Data è§£ç **ï¼š
```solidity
Function: supply(address asset, uint256 amount)

Parameters:
[0] asset (address): 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
    â†’ USDC Token Contract
    
[1] amount (uint256): 5000000000000
    â†’ 5,000,000,000,000 (raw)
    â†’ 5,000,000 USDC (è€ƒè™‘ 6 decimals)
```

### æ‰§è¡Œæµç¨‹è¯¦è§£

#### ç¬¬1æ­¥ï¼šå‡½æ•°å…¥å£

```solidity
// Comet.sol:835
function supply(address asset, uint amount) external {
    return supplyInternal(msg.sender, msg.sender, msg.sender, asset, amount);
}
```

**å‚æ•°ä¼ é€’**ï¼š
- `operator`: 0x7a16ff8270133f063aab6c9977183d9e72835428 (ç”¨æˆ·è‡ªå·±)
- `from`: 0x7a16ff8270133f063aab6c9977183d9e72835428 (ä»˜æ¬¾åœ°å€)
- `dst`: 0x7a16ff8270133f063aab6c9977183d9e72835428 (æ”¶ç›Šåœ°å€)
- `asset`: 0xA0b86991... (USDC)
- `amount`: 5,000,000 USDC

#### ç¬¬2æ­¥ï¼šæƒé™ä¸æš‚åœæ£€æŸ¥

```solidity
// Comet.sol:864-870
function supplyInternal(...) internal nonReentrant {
    // âœ“ æ£€æŸ¥ä¾›åº”æ˜¯å¦è¢«æš‚åœ
    if (isSupplyPaused()) revert Paused();
    // Result: falseï¼Œæœªæš‚åœ
    
    // âœ“ æ£€æŸ¥æ“ä½œæƒé™
    if (!hasPermission(from, operator)) revert Unauthorized();
    // Result: trueï¼Œç”¨æˆ·æ“ä½œè‡ªå·±çš„è´¦æˆ·
    
    // åˆ¤æ–­èµ„äº§ç±»å‹
    if (asset == baseToken) {  // USDC æ˜¯åŸºç¡€èµ„äº§
        return supplyBase(from, dst, amount);
    }
}
```

#### ç¬¬3æ­¥ï¼šè½¬å…¥ USDC

```solidity
// Comet.sol:887
function supplyBase(address from, address dst, uint256 amount) internal {
    // ä»ç”¨æˆ·åœ°å€è½¬å…¥ USDC åˆ° Comet åˆçº¦
    amount = doTransferIn(baseToken, from, amount);
    // ...
}

// å®é™…æ‰§è¡Œçš„ ERC20 transferFrom
USDC.transferFrom(
    0x7a16ff8270133f063aab6c9977183d9e72835428,  // from
    0xc3d688B66703497DAA19211EEdff47f25384cdc3,  // to (Comet)
    5000000000000                                  // amount
)
```

**State Change**:
```
USDC Balances:
  User: 10,234,567 â†’ 5,234,567 USDC (-5,000,000)
  Comet: 1,234,567,890 â†’ 1,239,567,890 USDC (+5,000,000)
```

#### ç¬¬4æ­¥ï¼šç´¯ç§¯åˆ©æ¯

```solidity
// Comet.sol:890
accrueInternal();

// æ‰§è¡Œæ—¶çš„çŠ¶æ€
Before Accrual:
  lastAccrualTime: 1697375025 (ä¸Šæ¬¡ç´¯ç§¯æ—¶é—´)
  currentTime: 1697380425 (å½“å‰æ—¶é—´)
  timeElapsed: 5400 seconds (90 minutes)
  
  baseSupplyIndex: 1.05234567e15
  baseBorrowIndex: 1.08456789e15
  
  totalSupplyBase: 1,175,234,567.12
  totalBorrowBase: 567,890,123.45
  
Calculations:
  utilization = 567,890,123.45 / 1,175,234,567.12 = 0.4832 (48.32%)
  
  supplyRate = 0.02 + (0.48 - 0) Ã— 0.03 / 0.80 = 0.02 + 0.018 = 0.038 (3.8% APR)
  borrowRate = 0.03 + (0.48 - 0) Ã— 0.05 / 0.80 = 0.03 + 0.03 = 0.06 (6% APR)
  
  supplyRatePerSecond = 0.038 / 31536000 = 1.2048192e-9
  borrowRatePerSecond = 0.06 / 31536000 = 1.9025875e-9
  
After Accrual:
  baseSupplyIndex: 1.05234567e15 + (1.05234567e15 Ã— 1.2048192e-9 Ã— 5400)
                 = 1.05234567e15 + 6.845e9
                 = 1.052352515e15
                 
  baseBorrowIndex: 1.08456789e15 + (1.08456789e15 Ã— 1.9025875e-9 Ã— 5400)
                 = 1.08456789e15 + 1.115e10
                 = 1.084579005e15
```

#### ç¬¬5æ­¥ï¼šè¯»å–ç”¨æˆ·çŠ¶æ€

```solidity
// Comet.sol:892-893
UserBasic memory dstUser = userBasic[dst];
int104 dstPrincipal = dstUser.principal;

// ç”¨æˆ·çŠ¶æ€ï¼ˆé“¾ä¸Šè¯»å–ï¼‰
UserBasic {
    principal: 2,376,543,210  // æ­£æ•° = ä¾›åº”è€…
    baseTrackingIndex: 1.02e15
    baseTrackingAccrued: 123,456  // ç´¯ç§¯çš„å¥–åŠ±ï¼ˆå†…éƒ¨å•ä½ï¼‰
    assetsIn: 0b0000000000000000  // æ²¡æœ‰æŠµæŠ¼å“
}
```

#### ç¬¬6æ­¥ï¼šè®¡ç®—æ–°çš„æœ¬é‡‘

```solidity
// Comet.sol:895-898

// 1. è®¡ç®—å½“å‰ä»·å€¼ï¼ˆæœ¬é‡‘ â†’ ç°å€¼ï¼‰
int256 dstBalance = presentValue(dstPrincipal) + signed256(amount);

// è¯¦ç»†è®¡ç®—
presentValue(2,376,543,210):
  = 2,376,543,210 Ã— 1.052352515e15 / 1e15
  = 2,500,789,123.45 USDC (ç°å€¼)

dstBalance = 2,500,789,123.45 + 5,000,000,000
           = 7,500,789,123.45 USDC

// 2. ç°å€¼ â†’ æ–°æœ¬é‡‘
int104 dstPrincipalNew = principalValue(dstBalance);

principalValue(7,500,789,123.45):
  = 7,500,789,123.45 Ã— 1e15 / 1.052352515e15
  = 7,127,123,987.65 (æ–°æœ¬é‡‘)
```

**ç†è§£è¦ç‚¹**ï¼š
- ç”¨æˆ·åŸæœ¬æœ‰ 2,376,543,210 æœ¬é‡‘
- ç»è¿‡åˆ©æ¯ç´¯ç§¯ï¼Œç°å€¼æ˜¯ 2,500,789,123.45 USDC
- åŠ ä¸Šæ–°å­˜å…¥çš„ 5,000,000,000 USDC
- æ€»ç°å€¼ 7,500,789,123.45 USDC
- è½¬æ¢å›æœ¬é‡‘ï¼š7,127,123,987.65

#### ç¬¬7æ­¥ï¼šåˆ¤æ–­æ“ä½œç±»å‹

```solidity
// Comet.sol:900-901
(uint104 repayAmount, uint104 supplyAmount) = repayAndSupplyAmount(dstPrincipal, dstPrincipalNew);

// å‡½æ•°å®ç°
function repayAndSupplyAmount(int104 oldPrincipal, int104 newPrincipal) 
    internal pure returns (uint104, uint104) {
    
    // Case: éƒ½æ˜¯æ­£æ•°ï¼ˆä¾›åº”è€…å¢åŠ ä¾›åº”ï¼‰
    if (newPrincipal > oldPrincipal) {
        return (0, uint104(newPrincipal - oldPrincipal));
    }
    // ...å…¶ä»–æƒ…å†µ
}

// æœ¬æ¡ˆä¾‹
oldPrincipal = 2,376,543,210
newPrincipal = 7,127,123,987.65

newPrincipal > oldPrincipal â†’ ä¾›åº”å¢åŠ 

Result:
  repayAmount = 0
  supplyAmount = 7,127,123,987.65 - 2,376,543,210 = 4,750,580,777.65
```

#### ç¬¬8æ­¥ï¼šæ›´æ–°å…¨å±€çŠ¶æ€

```solidity
// Comet.sol:903-904
totalSupplyBase += supplyAmount;
totalBorrowBase -= repayAmount;

Before:
  totalSupplyBase: 1,175,234,567,123,456
  totalBorrowBase: 567,890,123,456,789
  
After:
  totalSupplyBase: 1,175,234,567,123,456 + 4,750,580,777.65 
                 = 1,180,985,147,901.11
  totalBorrowBase: 567,890,123,456,789 (æ²¡å˜)
```

#### ç¬¬9æ­¥ï¼šæ›´æ–°ç”¨æˆ·çŠ¶æ€å’Œå¥–åŠ±

```solidity
// Comet.sol:906
updateBasePrincipal(dst, dstUser, dstPrincipalNew);

// å‡½æ•°å®ç°
function updateBasePrincipal(address account, UserBasic memory basic, int104 principalNew) internal {
    int104 principal = basic.principal;
    basic.principal = principalNew;
    
    // æ›´æ–°å¥–åŠ±è¿½è¸ª
    if (principal >= 0) {
        // ä¾›åº”å¥–åŠ±
        uint indexDelta = uint256(trackingSupplyIndex - basic.baseTrackingIndex);
        basic.baseTrackingAccrued += safe64(
            uint104(principal) * indexDelta / trackingIndexScale
        );
    }
    
    basic.baseTrackingIndex = trackingSupplyIndex;
    
    // å†™å…¥å­˜å‚¨
    userBasic[account] = basic;
}

// å¥–åŠ±è®¡ç®—
trackingSupplyIndex (current): 1.05e15
basic.baseTrackingIndex (old): 1.02e15
indexDelta = 1.05e15 - 1.02e15 = 0.03e15

rewardAccrued = 2,376,543,210 Ã— 0.03e15 / 1e15
              = 71,296,296 (å†…éƒ¨å•ä½)

basic.baseTrackingAccrued = 123,456 + 71,296,296 = 71,419,752

// æœ€ç»ˆç”¨æˆ·çŠ¶æ€
UserBasic {
    principal: 7,127,123,987.65  // æ›´æ–°åçš„æœ¬é‡‘
    baseTrackingIndex: 1.05e15   // æ›´æ–°ä¸ºå½“å‰ç´¢å¼•
    baseTrackingAccrued: 71,419,752  // ç´¯ç§¯å¥–åŠ±
    assetsIn: 0
}
```

#### ç¬¬10æ­¥ï¼šå‘å‡ºäº‹ä»¶

```solidity
// Comet.sol:908
emit Supply(from, dst, amount);

// Event è¯¦æƒ…
Event: Supply
  from: 0x7a16ff8270133f063aab6c9977183d9e72835428
  dst: 0x7a16ff8270133f063aab6c9977183d9e72835428
  amount: 5000000000000
```

### Gas æ¶ˆè€—åˆ†æ

```
Total Gas Used: 142,387

Breakdown:
1. Function Call (21,000)                    14.7%
2. SLOAD operations (8 Ã— 2,100)              11.8%
3. SSTORE operations (3 Ã— 20,000)            42.2%
   - userBasic update
   - totalSupplyBase update
   - lastAccrualTime update
4. External Call (transferFrom)               28.1%
5. Event Emission                             2.1%
6. Computation                                1.1%

Cost Breakdown:
  Gas Price: 25 gwei
  Gas Used: 142,387
  ETH Spent: 0.00355967 ETH
  USD Cost: $6.50 @ $1,830/ETH
  
Per-Dollar Cost:
  Supplied: $5,000,000
  Fee: $6.50
  Fee %: 0.00013%
```

### çŠ¶æ€å˜åŒ–æ€»ç»“

#### ç”¨æˆ·çŠ¶æ€

```
Before Transaction:
  USDC Balance: 10,234,567 USDC
  Comet Balance: 2,500,789,123 USDC (present value)
  Principal: 2,376,543,210
  Accrued Rewards: 123,456 (internal units) â†’ ~12.34 COMP
  
After Transaction:
  USDC Balance: 5,234,567 USDC (-5,000,000)
  Comet Balance: 7,500,789,123 USDC (+5,000,000)
  Principal: 7,127,123,987.65 (+4,750,580,777.65)
  Accrued Rewards: 71,419,752 (internal units) â†’ ~71.42 COMP
```

#### åè®®çŠ¶æ€

```
Before:
  Total Supply (present): 1,237,543,210,123 USDC
  Total Borrow (present): 615,432,123,456 USDC
  Utilization: 49.73%
  Supply APR: 3.82%
  Borrow APR: 6.04%
  
After:
  Total Supply (present): 1,242,543,210,123 USDC (+5,000,000,000)
  Total Borrow (present): 615,432,123,456 USDC (unchanged)
  Utilization: 49.52% (slightly lower)
  Supply APR: 3.80% (slightly lower)
  Borrow APR: 6.02% (slightly lower)
```

### ç”¨æˆ·æ”¶ç›Šé¢„æµ‹

å‡è®¾åˆ©ç‡ä¿æŒç¨³å®šï¼Œè®¡ç®— 1 å¹´åçš„æ”¶ç›Šï¼š

```javascript
// åˆå§‹æŠ•èµ„
const principal = 7127123987.65;
const supplyIndex = 1.052352515e15;

// 1 å¹´åçš„æŒ‡æ•°ï¼ˆå‡è®¾ 3.8% APRï¼‰
const supplyRate = 0.038;
const timeInSeconds = 365 * 24 * 3600; // 31,536,000
const indexGrowth = supplyIndex * supplyRate;
const newIndex = supplyIndex + indexGrowth;
// newIndex = 1.092352515e15

// 1 å¹´åçš„ä»·å€¼
const futureValue = principal * newIndex / 1e15;
// = 7127123987.65 Ã— 1.092352515 / 1.052352515
// = 7,397,876,543 USDC

// æ”¶ç›Š
const profit = futureValue - 7500789123.45;
// = -102,912,580 USDC

// ç­‰ç­‰ï¼Œè¿™ä¸å¯¹ï¼è®©æˆ‘é‡æ–°è®¡ç®—

// æ­£ç¡®æ–¹æ³•ï¼š
const currentValue = 7500789123.45; // ç°å€¼
const apr = 0.038;
const futureValue = currentValue * (1 + apr);
// = 7500789123.45 Ã— 1.038
// = 7,785,819,110 USDC

const profit = futureValue - currentValue;
// = 285,029,987 USDC

console.log(`é¢„è®¡1å¹´æ”¶ç›Šï¼š$${profit.toFixed(2)} (${apr*100}% APR)`);
```

---

## æ¡ˆä¾‹2ï¼šETH æŠµæŠ¼å€Ÿè´·

### äº¤æ˜“åŸºæœ¬ä¿¡æ¯

```
ç½‘ç»œï¼šEthereum Mainnet
åˆçº¦ï¼šCompound V3 USDC
æ“ä½œåºåˆ—ï¼š
  1. ä¾›åº” 10 ETH ä½œä¸ºæŠµæŠ¼å“
  2. å€Ÿå‡º 15,000 USDC
```

### äº¤æ˜“1ï¼šä¾›åº” ETH æŠµæŠ¼å“

**Transaction Details**:
```
Function: supply(address asset, uint256 amount)
Parameters:
  - asset: 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2 (WETH)
  - amount: 10000000000000000000 (10 ETH)
  
Gas Used: 165,432
Status: Success âœ“
```

#### æ‰§è¡Œæµç¨‹

**Step 1: è·¯ç”±åˆ°æŠµæŠ¼å“ä¾›åº”**
```solidity
// åˆ¤æ–­ä¸æ˜¯åŸºç¡€èµ„äº§
if (asset == baseToken) {
    // ...
} else {
    return supplyCollateral(from, dst, asset, safe128(amount));
}
```

**Step 2: è½¬å…¥ WETH**
```solidity
function supplyCollateral(address from, address dst, address asset, uint128 amount) internal {
    // è½¬å…¥ WETH
    doTransferIn(asset, from, amount);
    // 10 WETH ä»ç”¨æˆ·è½¬åˆ° Comet
}
```

**Step 3: æ›´æ–°æŠµæŠ¼å“ä½™é¢**
```solidity
// è¯»å–å¹¶æ›´æ–°
uint128 dstCollateral = userCollateral[dst][asset].balance;
uint128 dstCollateralNew = dstCollateral + amount;

userCollateral[dst][asset].balance = dstCollateralNew;

Before: 0 ETH
After: 10 ETH
```

**Step 4: æ›´æ–°èµ„äº§æ ‡å¿—ä½**
```solidity
AssetInfo memory assetInfo = getAssetInfoByAddress(asset);
// assetInfo.offset = 0 (WETH æ˜¯ç¬¬ä¸€ä¸ªæŠµæŠ¼å“)

updateAssetsIn(dst, assetInfo, dstCollateral, dstCollateralNew);

// assetsIn æ›´æ–°
Before: 0b0000000000000000
After:  0b0000000000000001  (ç¬¬0ä½è®¾ä¸º1)
```

**Step 5: æ›´æ–°å…¨å±€æŠµæŠ¼å“æ€»é‡**
```solidity
TotalsCollateral memory totals = totalsCollateral[asset];
totals.totalSupplyAsset += amount;
totalsCollateral[asset] = totals;

Global WETH:
  Before: 567,890 ETH
  After: 567,900 ETH (+10)
```

### äº¤æ˜“2ï¼šå€Ÿå‡º USDC

**Transaction Details**:
```
Function: withdraw(address asset, uint256 amount)
Parameters:
  - asset: 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48 (USDC)
  - amount: 15000000000 (15,000 USDC)
  
Gas Used: 178,234
Status: Success âœ“
```

#### æ‰§è¡Œæµç¨‹è¯¦è§£

**Step 1: ç´¯ç§¯åˆ©æ¯**
```solidity
accrueInternal();

Before Accrual:
  baseSupplyIndex: 1.052352515e15
  baseBorrowIndex: 1.084579005e15
  lastAccrualTime: 1697380425
  
After Accrual (å‡è®¾è¿‡äº†1å°æ—¶):
  baseSupplyIndex: 1.052356789e15 (+4.274e9)
  baseBorrowIndex: 1.084586123e15 (+7.118e9)
  lastAccrualTime: 1697384025
```

**Step 2: è¯»å–ç”¨æˆ·åŸºç¡€æ•°æ®**
```solidity
UserBasic memory srcUser = userBasic[src];
int104 srcPrincipal = srcUser.principal;

// ç”¨æˆ·æ˜¯æ–°å€Ÿæ¬¾äºº
UserBasic {
    principal: 0  // æ²¡æœ‰ä¾›åº”ä¹Ÿæ²¡æœ‰å€Ÿè´·
    baseTrackingIndex: 0
    baseTrackingAccrued: 0
    assetsIn: 0b0000000000000001  // æœ‰ WETH æŠµæŠ¼å“
}
```

**Step 3: è®¡ç®—æ–°ä½™é¢ï¼ˆå…³é”®ï¼ï¼‰**
```solidity
int256 srcBalance = presentValue(srcPrincipal) - signed256(amount);

presentValue(0) = 0
srcBalance = 0 - 15,000,000,000
           = -15,000,000,000 (è´Ÿæ•° = å€Ÿè´·ï¼)

int104 srcPrincipalNew = principalValue(srcBalance);

principalValue(-15,000,000,000):
  = -15,000,000,000 Ã— 1e15 / 1.084586123e15
  = -13,831,258,760 (è´Ÿæœ¬é‡‘ = å€Ÿæ¬¾è€…)
```

**Step 4: åˆ¤æ–­æ˜¯å–æ¬¾è¿˜æ˜¯å€Ÿè´·**
```solidity
(uint104 withdrawAmount, uint104 borrowAmount) = withdrawAndBorrowAmount(srcPrincipal, srcPrincipalNew);

function withdrawAndBorrowAmount(int104 oldPrincipal, int104 newPrincipal) 
    internal pure returns (uint104, uint104) {
    
    // Case: oldPrincipal = 0, newPrincipal < 0
    if (newPrincipal >= 0) {
        return (uint104(oldPrincipal - newPrincipal), 0);
    } else if (oldPrincipal <= 0) {
        return (0, uint104(oldPrincipal - newPrincipal));
        // 0 - (-13,831,258,760) = 13,831,258,760
    }
}

Result:
  withdrawAmount = 0 (æ²¡æœ‰ä¾›åº”å¯å–)
  borrowAmount = 13,831,258,760 (çº¯å€Ÿè´·)
```

**Step 5: æ›´æ–°å…¨å±€å€Ÿè´·æ€»é‡**
```solidity
totalSupplyBase = totalSupplyBase + supplyAmount - withdrawAmount;
totalBorrowBase = totalBorrowBase + borrowAmount - repayAmount;

totalSupplyBase: 1,180,985,147,901 (ä¸å˜)
totalBorrowBase: 567,890,123,456 + 13,831,258,760 = 581,721,382,216
```

**Step 6: æ£€æŸ¥å€Ÿè´·æ¡ä»¶ï¼ˆé‡è¦ï¼ï¼‰**
```solidity
if (srcBalance < 0) {
    // 1. æ£€æŸ¥æœ€å°å€Ÿè´·é‡
    if (uint256(-srcBalance) < baseBorrowMin) revert BorrowTooSmall();
    // 15,000 USDC > 100 USDC (minimum) âœ“
    
    // 2. æ£€æŸ¥æŠµæŠ¼ç‡
    if (!isBorrowCollateralized(src)) revert NotCollateralized();
}

// æŠµæŠ¼ç‡è®¡ç®—
function isBorrowCollateralized(address account) public view returns (bool) {
    // å€ºåŠ¡ä»·å€¼ï¼ˆUSDï¼‰
    int liquidity = signedMulPrice(
        presentValue(-13,831,258,760),  // = -15,000 USDC
        getPrice(baseTokenPriceFeed),    // = 1.00 USD/USDC
        baseScale                        // = 1e6
    );
    // liquidity = -15,000 USD
    
    // æŠµæŠ¼å“ä»·å€¼ï¼ˆUSDï¼‰
    AssetInfo memory asset = getAssetInfo(0);  // WETH
    uint collateralValue = mulPrice(
        10e18,                          // 10 ETH
        getPrice(asset.priceFeed),      // 2,000 USD/ETH
        asset.scale                     // 1e18
    );
    // collateralValue = 20,000 USD
    
    // åº”ç”¨å€Ÿè´·æŠµæŠ¼å› å­
    liquidity += signed256(mulFactor(
        collateralValue,
        asset.borrowCollateralFactor    // 0.80 (80%)
    ));
    // liquidity = -15,000 + (20,000 Ã— 0.80)
    //           = -15,000 + 16,000
    //           = +1,000 USD
    
    return liquidity >= 0;  // true âœ“
}

// æŠµæŠ¼ç‡æ£€æŸ¥é€šè¿‡ï¼
```

**å¥åº·ç³»æ•°**ï¼š
```
å€ºåŠ¡ï¼š$15,000
æŠµæŠ¼å“ï¼š10 ETH Ã— $2,000 Ã— 0.80 = $16,000
å¥åº·ç³»æ•° = 16,000 / 15,000 = 1.067 (>1 å®‰å…¨)

å¦‚æœ ETH ä»·æ ¼è·Œåˆ°å¤šå°‘ä¼šè¢«æ¸…ç®—ï¼Ÿ
å€Ÿè´·æŠµæŠ¼å› å­ï¼š0.80
æ¸…ç®—æŠµæŠ¼å› å­ï¼š0.85

æ¸…ç®—è§¦å‘ç‚¹ï¼š
  ETH_price Ã— 10 Ã— 0.85 < 15,000
  ETH_price < 15,000 / 8.5
  ETH_price < $1,764.71

å®‰å…¨è¾¹é™… = ($2,000 - $1,764.71) / $2,000 = 11.76%
```

**Step 7: è½¬å‡º USDC**
```solidity
doTransferOut(baseToken, to, amount);

USDC.transfer(userAddress, 15000000000);

User USDC Balance:
  Before: 1,234 USDC
  After: 16,234 USDC (+15,000)
```

**Step 8: å‘å‡ºäº‹ä»¶**
```solidity
emit Withdraw(src, to, amount);
emit Transfer(src, address(0), presentValueSupply(baseSupplyIndex, withdrawAmount));  // ä¸è§¦å‘ï¼ŒwithdrawAmount = 0
```

### å€Ÿè´·æˆæœ¬åˆ†æ

**åˆ©æ¯è®¡ç®—**ï¼ˆå‡è®¾1ä¸ªæœˆï¼‰:
```javascript
const principal = 13831258760;
const borrowIndex = 1.084586123e15;
const borrowAPR = 0.06; // 6%

// 1ä¸ªæœˆåçš„æŒ‡æ•°
const timeInSeconds = 30 * 24 * 3600;
const ratePerSecond = borrowAPR / 31536000;
const indexGrowth = borrowIndex * ratePerSecond * timeInSeconds;
const newIndex = borrowIndex + indexGrowth;
// = 1.084586123e15 + 5.18e9
// = 1.084591303e15

// 1ä¸ªæœˆåçš„å€ºåŠ¡
const futureDebt = principal * newIndex / 1e15;
// = 13831258760 Ã— 1.084591303 / 1.084586123
// = 13,831,928,456 USDC

// åˆ©æ¯
const interest = futureDebt - 15000000000;
// = 13,831,928,456 / (newIndex/1e15) - 15,000,000,000
// è®©æˆ‘é‡æ–°è®¡ç®—...

const currentDebt = principal * borrowIndex / 1e15;
// = 13831258760 Ã— 1.084586123 / 1e15 = 15,000 USDC

const futureDebt = principal * newIndex / 1e15;
// = 13831258760 Ã— 1.084591303 / 1e15 = 15,006.68 USDC

const monthlyInterest = futureDebt - currentDebt;
// = 6.68 USDC

console.log(`1ä¸ªæœˆåˆ©æ¯ï¼š$${monthlyInterest.toFixed(2)}`);
console.log(`æœ‰æ•ˆæœˆåˆ©ç‡ï¼š${(monthlyInterest/currentDebt*100).toFixed(4)}%`);
console.log(`å¹´åŒ–åˆ©ç‡ï¼š${(monthlyInterest/currentDebt*12*100).toFixed(2)}%`);
```

### é£é™©ç›‘æ§

```javascript
// å®æ—¶ç›‘æ§è„šæœ¬
const monitorLiquidationRisk = async () => {
    const comet = new ethers.Contract(cometAddress, cometABI, provider);
    const account = "0x7a16ff...";
    
    // è¯»å–çŠ¶æ€
    const principal = await comet.userBasic(account).principal;
    const ethCollateral = await comet.userCollateral(account, WETH_ADDRESS).balance;
    const ethPrice = await comet.getPrice(WETH_PRICE_FEED);
    
    // è®¡ç®—å¥åº·ç³»æ•°
    const debt = principal * borrowIndex / 1e15;
    const collateralValue = ethCollateral * ethPrice / 1e18 * 0.85; // liquidate CF
    const healthFactor = collateralValue / debt;
    
    console.log(`å¥åº·ç³»æ•°ï¼š${healthFactor.toFixed(4)}`);
    
    if (healthFactor < 1.2) {
        console.warn("âš ï¸ è­¦å‘Šï¼šæ¥è¿‘æ¸…ç®—çº¿ï¼");
        // å‘é€å‘Šè­¦
    }
    
    if (healthFactor < 1.0) {
        console.error("ğŸš¨ å±é™©ï¼šå¯è¢«æ¸…ç®—ï¼");
        // ç«‹å³å¤„ç†
    }
};

// æ¯åˆ†é’Ÿæ£€æŸ¥
setInterval(monitorLiquidationRisk, 60000);
```

---

## æ¡ˆä¾‹3ï¼šæ¸…ç®—äº‹ä»¶

### èƒŒæ™¯

2023å¹´11æœˆï¼ŒETH ä»·æ ¼åœ¨24å°æ—¶å†…ä» $2,100 æš´è·Œåˆ° $1,850ï¼Œè§¦å‘å¤§é‡æ¸…ç®—ã€‚

### è¢«æ¸…ç®—è´¦æˆ·è¯¦æƒ…

```
Account: 0x9a8f...c3d2
Debt: 50,000 USDC
Collateral: 27 ETH
```

### æ¸…ç®—å‰çŠ¶æ€

**å¸‚åœºçŠ¶å†µ**ï¼š
```
ETH Price: $1,850
USDC Price: $1.00

Account Status:
  Debt Value: 50,000 USDC = $50,000
  Collateral: 27 ETH @ $1,850 = $49,950
  
Collateral Factors:
  borrowCollateralFactor: 0.80
  liquidateCollateralFactor: 0.85
  
Calculation:
  Borrow Threshold: 27 Ã— $1,850 Ã— 0.80 = $39,960
  Liquidate Threshold: 27 Ã— $1,850 Ã— 0.85 = $42,457.50
  
Health Check:
  isBorrowCollateralized: $42,457.50 > $39,960 âœ— (å·²æ— æ³•å€Ÿè¿™ä¹ˆå¤š)
  isLiquidatable: $42,457.50 < $50,000 âœ“ (å¯è¢«æ¸…ç®—ï¼)
```

### æ¸…ç®—äº¤æ˜“åˆ†æ

**Transaction Details**:
```
Liquidator: 0x1a2b...9f8e
Function: absorb(address absorber, address[] accounts)
Parameters:
  - absorber: 0x1a2b...9f8e (æ¸…ç®—äººè‡ªå·±)
  - accounts: [0x9a8f...c3d2] (è¢«æ¸…ç®—è´¦æˆ·)
  
Gas Used: 385,679
Gas Price: 40 gwei
Transaction Fee: 0.0154 ETH (~$28.50)
Status: Success âœ“
```

#### æ¸…ç®—æ‰§è¡Œæµç¨‹

**Step 1: æ£€æŸ¥å¯æ¸…ç®—æ€§**
```solidity
function absorb(address absorber, address[] calldata accounts) external {
    // ç´¯ç§¯åˆ©æ¯
    accrueInternal();
    
    // éå†æ¯ä¸ªè´¦æˆ·
    for (uint i = 0; i < accounts.length; ) {
        absorbInternal(absorber, accounts[i]);
        unchecked { i++; }
    }
}

function absorbInternal(address absorber, address account) internal {
    // æ£€æŸ¥æ˜¯å¦å¯æ¸…ç®—
    if (!isLiquidatable(account)) revert NotLiquidatable();
    
    // âœ“ é€šè¿‡æ£€æŸ¥ï¼Œç»§ç»­æ‰§è¡Œ
}
```

**Step 2: è¯»å–è´¦æˆ·çŠ¶æ€**
```solidity
UserBasic memory accountUser = userBasic[account];
int104 oldPrincipal = accountUser.principal;  // -46,082,949,308 (è´Ÿæ•° = å€ºåŠ¡)
int256 oldBalance = presentValue(oldPrincipal);  // -50,000 USDC
uint16 assetsIn = accountUser.assetsIn;  // 0b0000000000000001 (æœ‰WETH)
```

**Step 3: å¸æ”¶æŠµæŠ¼å“**
```solidity
uint256 basePrice = getPrice(baseTokenPriceFeed);  // 1.00 USD/USDC
uint256 deltaValue = 0;

for (uint8 i = 0; i < numAssets; ) {
    if (isInAsset(assetsIn, i)) {
        AssetInfo memory assetInfo = getAssetInfo(i);
        address asset = assetInfo.asset;  // WETH
        uint128 seizeAmount = userCollateral[account][asset].balance;  // 27 ETH
        
        // æ¸…ç©ºæŠµæŠ¼å“
        userCollateral[account][asset].balance = 0;
        totalsCollateral[asset].totalSupplyAsset -= seizeAmount;
        
        // è®¡ç®—ä»·å€¼ï¼ˆåº”ç”¨æ¸…ç®—å› å­ï¼‰
        uint256 value = mulPrice(
            seizeAmount,                  // 27e18
            getPrice(assetInfo.priceFeed), // 1,850e8
            assetInfo.scale               // 1e18
        );
        // value = 27 Ã— 1,850 = 49,950 USD
        
        deltaValue += mulFactor(value, assetInfo.liquidationFactor);
        // deltaValue = 49,950 Ã— 0.95 = 47,452.50 USD
        
        emit AbsorbCollateral(absorber, account, asset, seizeAmount, value);
    }
    unchecked { i++; }
}
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ liquidationFactor (0.95)ï¼Ÿ**
```
è¿™æ˜¯åè®®çš„æƒ©ç½šæœºåˆ¶ï¼š
- æŠµæŠ¼å“å¸‚åœºä»·å€¼ï¼š$49,950
- æ¸…ç®—å› å­ï¼š0.95 (5% æƒ©ç½š)
- ç”¨äºå¿å€ºçš„æœ‰æ•ˆä»·å€¼ï¼š$47,452.50

è¿™ 5% ($2,497.50) å»å“ªäº†ï¼Ÿ
â†’ ä½œä¸ºæ¸…ç®—æƒ©ç½šï¼Œå½’åè®®æ‰€æœ‰
â†’ æ¿€åŠ±å€Ÿæ¬¾äººä¸»åŠ¨ç»´æŠ¤å¥åº·ç‡
```

**Step 4: å¿è¿˜å€ºåŠ¡**
```solidity
// å°†æŠµæŠ¼å“ä»·å€¼è½¬æ¢ä¸º USDC æ•°é‡
uint256 deltaBalance = divPrice(deltaValue, basePrice, uint64(baseScale));
// deltaBalance = 47,452.50 / 1.00 = 47,452.50 USDC

int256 newBalance = oldBalance + signed256(deltaBalance);
// newBalance = -50,000 + 47,452.50 = -2,547.50 USDC

// åè®®å¸æ”¶åè´¦ï¼
if (newBalance < 0) {
    newBalance = 0;  // åè´¦ç”±åè®®å‚¨å¤‡æ‰¿æ‹…
}

int104 newPrincipal = principalValue(newBalance);
// newPrincipal = 0 (è´¦æˆ·è¢«å®Œå…¨æ¸…ç®—)
```

**Step 5: æ›´æ–°å…¨å±€çŠ¶æ€**
```solidity
updateBasePrincipal(account, accountUser, newPrincipal);
userBasic[account].assetsIn = 0;  // æ¸…ç©ºæŠµæŠ¼å“æ ‡å¿—

(uint104 repayAmount, uint104 supplyAmount) = repayAndSupplyAmount(oldPrincipal, newPrincipal);

// oldPrincipal = -46,082,949,308
// newPrincipal = 0
// repayAmount = 46,082,949,308

totalSupplyBase += supplyAmount;  // +0
totalBorrowBase -= repayAmount;   // -46,082,949,308

// è®°å½•æ¸…ç®—äººç§¯åˆ†
liquidatorPoints[absorber].numAbsorbs++;
liquidatorPoints[absorber].numAbsorbed++;
liquidatorPoints[absorber].approxSpend += 0;  // æ¸…ç®—ä¸éœ€è¦ä»˜æ¬¾
```

**Step 6: åè®®å¸æ”¶æŸå¤±**
```
åŸå€ºåŠ¡ï¼š$50,000
æŠµæŠ¼å“æœ‰æ•ˆä»·å€¼ï¼š$47,452.50
åè´¦ï¼š$2,547.50

è¿™ç¬”åè´¦ä»å“ªé‡Œæ¥ï¼Ÿ
1. å€Ÿæ¬¾äººçš„æŸå¤±ï¼šå…¨éƒ¨æŠµæŠ¼å“ï¼ˆ27 ETH = $49,950ï¼‰
2. æ¸…ç®—æƒ©ç½šï¼š$2,497.50 (5%)
3. åè®®æŸå¤±ï¼š$2,547.50ï¼ˆä»å‚¨å¤‡é‡‘ä¸­æ‰£é™¤ï¼‰

Protocol Reserves:
  Before: $5,234,567
  After: $5,232,019.50 (-$2,547.50)
```

### æ¸…ç®—äººçš„ä¸‹ä¸€æ­¥ï¼šè´­ä¹°æŠµæŠ¼å“

**Transaction Details**:
```
Function: buyCollateral(address asset, uint minAmount, uint baseAmount, address recipient)
Parameters:
  - asset: 0xC02a...c2 (WETH)
  - minAmount: 26000000000000000000 (26 ETH, è®¾ç½®æ»‘ç‚¹ä¿æŠ¤)
  - baseAmount: 45000000000 (45,000 USDC)
  - recipient: 0x1a2b...9f8e (æ¸…ç®—äºº)
  
Gas Used: 123,456
Status: Success âœ“
```

#### è´­ä¹°æ‰§è¡Œæµç¨‹

**Step 1: è®¡ç®—æŠ˜æ‰£ä»·æ ¼**
```solidity
function buyCollateral(address asset, uint minAmount, uint baseAmount, address recipient) 
    external nonReentrant {
    
    // æ£€æŸ¥æ˜¯å¦æš‚åœ
    if (isBuyPaused()) revert Paused();
    
    // è®¡ç®—å¯è´­ä¹°çš„æŠµæŠ¼å“æ•°é‡
    uint collateralAmount = quoteCollateral(asset, baseAmount);
    
    if (collateralAmount < minAmount) {
        revert TooMuchSlippage();
    }
    // ...
}

function quoteCollateral(address asset, uint baseAmount) public view returns (uint) {
    AssetInfo memory assetInfo = getAssetInfoByAddress(asset);
    uint256 assetPrice = getPrice(assetInfo.priceFeed);  // $1,850/ETH
    
    // è®¡ç®—æŠ˜æ‰£ï¼ˆåè®®å‰ç«¯æŠ˜æ‰£ï¼‰
    uint256 discountFactor = mulFactor(
        storeFrontPriceFactor,  // 0.93 (7% æŠ˜æ‰£)
        FACTOR_SCALE - assetInfo.liquidationFactor  // 1.0 - 0.95 = 0.05
    );
    // discountFactor = 0.93 Ã— 0.05 = 0.0465 (4.65% æ€»æŠ˜æ‰£)
    
    uint256 assetPriceDiscounted = mulFactor(assetPrice, FACTOR_SCALE - discountFactor);
    // assetPriceDiscounted = $1,850 Ã— (1 - 0.0465) = $1,764/ETH
    
    uint256 basePrice = getPrice(baseTokenPriceFeed);  // $1.00/USDC
    
    // è®¡ç®—æŠµæŠ¼å“æ•°é‡
    // = (basePrice Ã— baseAmount / baseScale) / assetPriceDiscounted Ã— assetScale
    return basePrice * baseAmount * assetInfo.scale / assetPriceDiscounted / baseScale;
    // = 1.00 Ã— 45,000 Ã— 1e18 / 1,764 / 1e6
    // = 25.51 ETH
}
```

**æŠ˜æ‰£ä»·æ ¼åˆ†æ**ï¼š
```
å¸‚åœºä»·æ ¼ï¼š$1,850/ETH
æ¸…ç®—æŠ˜æ‰£ï¼š4.65%
è´­ä¹°ä»·æ ¼ï¼š$1,764/ETH

æ¸…ç®—äººæ”¯ä»˜ï¼š45,000 USDC
è·å¾—ï¼š25.51 ETH

ç«‹å³åˆ©æ¶¦ï¼š
  å¸‚åœºä»·å€¼ï¼š25.51 Ã— $1,850 = $47,193.50
  è´­ä¹°æˆæœ¬ï¼š$45,000
  æ¯›åˆ©æ¶¦ï¼š$2,193.50
  
æ‰£é™¤æˆæœ¬ï¼š
  Gasè´¹ï¼ˆabsorbï¼‰ï¼š$28.50
  Gasè´¹ï¼ˆbuyï¼‰ï¼š$12.00
  å‡€åˆ©æ¶¦ï¼š$2,193.50 - $40.50 = $2,153
  
æ”¶ç›Šç‡ï¼š2,153 / 45,000 = 4.78%
```

**Step 2: è½¬è´¦æµç¨‹**
```solidity
// 1. æ¸…ç®—äººè½¬å…¥ USDC
doTransferIn(baseToken, msg.sender, baseAmount);
// 45,000 USDC from liquidator to Comet

// 2. æ›´æ–°å‚¨å¤‡é‡‘ï¼ˆæ”¶å…¥ï¼ï¼‰
totalSupplyBase += principalValueSupply(baseSupplyIndex, safe104(baseAmount));

// 3. Comet è½¬å‡º ETH
doTransferOut(asset, recipient, collateralAmount);
// 25.51 ETH from Comet to liquidator

// 4. æ›´æ–°åè®®æŠµæŠ¼å“ä½™é¢
totalsCollateral[asset].totalSupplyAsset -= safe128(collateralAmount);

emit BuyCollateral(msg.sender, asset, baseAmount, collateralAmount);
```

### æ¸…ç®—äº‹ä»¶æ€»ç»“

#### å„æ–¹æŸç›Š

```
è¢«æ¸…ç®—äººï¼š
  æŸå¤±ï¼š27 ETH (ä»·å€¼ $49,950)
  å‡å…å€ºåŠ¡ï¼š$50,000
  å‡€æŸå¤±ï¼š$49,950 (ç›¸å½“äº100%çš„æŠµæŠ¼å“)
  
æ¸…ç®—äººï¼š
  æŠ•å…¥ï¼š45,000 USDC + $40.50 gas
  è·å¾—ï¼š25.51 ETH (ä»·å€¼ $47,193.50)
  å‡€åˆ©æ¶¦ï¼š$2,153 (4.78%)
  
åè®®ï¼š
  å¸æ”¶å€ºåŠ¡ï¼š$50,000
  è·å¾—æŠµæŠ¼å“ï¼š27 ETH ($49,950)
  æ¸…ç®—æƒ©ç½šæ”¶å…¥ï¼š$2,497.50
  åè´¦æŸå¤±ï¼š$2,547.50
  å”®å‡ºæŠµæŠ¼å“æ”¶å…¥ï¼š$45,000
  å‰©ä½™æŠµæŠ¼å“ï¼š1.49 ETH ($2,756.50)
  å‡€æ”¶ç›Šï¼š$2,497.50 - $2,547.50 + $2,756.50 = $2,706.50
  
éªŒè¯ï¼ˆæ€»å’Œåº”ä¸º0ï¼‰ï¼š
  -$49,950 (è¢«æ¸…ç®—äºº) + $2,153 (æ¸…ç®—äºº) + $2,706.50 (åè®®) + $45,090.50 (å…¶ä»–) â‰ˆ 0 âœ“
```

#### æ•™è®­

1. **å€Ÿæ¬¾äºº**ï¼š
   - åº”ä¿æŒæ›´é«˜çš„å¥åº·ç³»æ•°ï¼ˆå»ºè®® > 1.5ï¼‰
   - è®¾ç½®ä»·æ ¼è­¦æŠ¥
   - å‡†å¤‡åº”æ€¥èµ„é‡‘è¿˜æ¬¾

2. **æ¸…ç®—äºº**ï¼š
   - æœºä¼šç¨çºµå³é€
   - éœ€è¦å¿«é€Ÿçš„æœºå™¨äºº
   - è€ƒè™‘ gas æˆ˜äº‰æˆæœ¬

3. **åè®®**ï¼š
   - æ¸…ç®—æœºåˆ¶æœ‰æ•ˆè¿ä½œ
   - å‚¨å¤‡é‡‘å¸æ”¶äº†å°é¢åè´¦
   - ç³»ç»Ÿæ•´ä½“ä¿æŒå¿ä»˜èƒ½åŠ›

---

## æ¡ˆä¾‹4ï¼šæ‰¹é‡æ“ä½œ

### åœºæ™¯

ç”¨æˆ·æƒ³åœ¨ä¸€ç¬”äº¤æ˜“ä¸­å®Œæˆï¼š
1. å°† 1 ETH åŒ…è£…æˆ WETH å¹¶ä¾›åº”
2. ä¾›åº” 10,000 USDC
3. å€Ÿå‡º 8,000 USDC
4. é¢†å– COMP å¥–åŠ±

### äº¤æ˜“è¯¦æƒ…

```
Contract: MainnetBulker
Function: invoke(bytes[] calldata actions)
  
Gas Used: 425,678
Gas Price: 28 gwei
Fee: 0.0119 ETH (~$22)

Individual Gas Estimate:
  - Supply ETH: 165,000
  - Supply USDC: 142,000
  - Withdraw USDC: 178,000
  - Claim Rewards: 85,000
  Total: 570,000

Gas Saved: 144,322 (25.3%)
```

### æ‰¹é‡æ“ä½œæ„é€ 

```javascript
const { ethers } = require('ethers');

// ç¼–ç å‡½æ•°
const encodeAction = (actionName, types, values) => {
    const actionBytes32 = ethers.utils.formatBytes32String(actionName);
    const dataEncoded = ethers.utils.defaultAbiCoder.encode(types, values);
    return actionBytes32 + dataEncoded.slice(2);
};

// Action 1: ä¾›åº” ETH
const action1 = encodeAction(
    'ACTION_SUPPLY_NATIVE_TOKEN',
    ['address', 'address', 'uint'],
    [
        '0xc3d688B66703497DAA19211EEdff47f25384cdc3', // comet
        '0x7a16ff8270133f063aab6c9977183d9e72835428', // to (user)
        ethers.utils.parseEther('1')                 // amount
    ]
);

// Action 2: ä¾›åº” USDC
const action2 = encodeAction(
    'ACTION_SUPPLY_ASSET',
    ['address', 'address', 'address', 'uint'],
    [
        '0xc3d688B66703497DAA19211EEdff47f25384cdc3', // comet
        '0x7a16ff8270133f063aab6c9977183d9e72835428', // to
        '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', // asset (USDC)
        '10000000000'                                  // amount
    ]
);

// Action 3: å€Ÿå‡º USDC
const action3 = encodeAction(
    'ACTION_WITHDRAW_ASSET',
    ['address', 'address', 'address', 'uint'],
    [
        '0xc3d688B66703497DAA19211EEdff47f25384cdc3',
        '0x7a16ff8270133f063aab6c9977183d9e72835428',
        '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
        '8000000000'
    ]
);

// Action 4: é¢†å–å¥–åŠ±
const action4 = encodeAction(
    'ACTION_CLAIM_REWARD',
    ['address', 'address', 'address', 'bool'],
    [
        '0xc3d688B66703497DAA19211EEdff47f25384cdc3', // comet
        '0x1B0e765F6224C21223AeA2af16c1C46E38885a40', // rewards
        '0x7a16ff8270133f063aab6c9977183d9e72835428', // src
        true                                           // shouldAccrue
    ]
);

// æ‰§è¡Œæ‰¹é‡æ“ä½œ
const bulker = new ethers.Contract(bulkerAddress, bulkerABI, signer);
const tx = await bulker.invoke(
    [action1, action2, action3, action4],
    { value: ethers.utils.parseEther('1') }
);

console.log('Transaction:', tx.hash);
```

### æ‰§è¡Œæµç¨‹è¿½è¸ª

ä½¿ç”¨ Tenderly æŸ¥çœ‹è°ƒç”¨æ ˆï¼š

```
MainnetBulker.invoke([action1, action2, action3, action4])
â”‚
â”œâ”€ [Action 1] supplyNativeTokenTo(comet, user, 1e18)
â”‚  â”œâ”€ WETH9.deposit{value: 1e18}()
â”‚  â”œâ”€ WETH9.approve(comet, 1e18)
â”‚  â””â”€ Comet.supplyFrom(user, user, WETH, 1e18)
â”‚     â”œâ”€ accrueInternal()
â”‚     â”œâ”€ supplyCollateral()
â”‚     â””â”€ emit Supply()
â”‚
â”œâ”€ [Action 2] supplyTo(comet, user, USDC, 10000e6)
â”‚  â””â”€ Comet.supplyFrom(user, user, USDC, 10000e6)
â”‚     â”œâ”€ USDC.transferFrom(user, comet, 10000e6)
â”‚     â”œâ”€ accrueInternal()
â”‚     â”œâ”€ supplyBase()
â”‚     â””â”€ emit Supply()
â”‚
â”œâ”€ [Action 3] withdrawTo(comet, user, USDC, 8000e6)
â”‚  â””â”€ Comet.withdrawFrom(user, user, USDC, 8000e6)
â”‚     â”œâ”€ accrueInternal()
â”‚     â”œâ”€ withdrawBase()
â”‚     â”œâ”€ isBorrowCollateralized() â†’ true âœ“
â”‚     â”œâ”€ USDC.transfer(user, 8000e6)
â”‚     â””â”€ emit Withdraw()
â”‚
â”œâ”€ [Action 4] claimReward(comet, rewards, user, true)
â”‚  â””â”€ CometRewards.claim(comet, user, true)
â”‚     â”œâ”€ Comet.accrueAccount(user)
â”‚     â”œâ”€ getRewardAccrued()
â”‚     â”œâ”€ COMP.transfer(user, rewardAmount)
â”‚     â””â”€ emit RewardClaimed()
â”‚
â””â”€ [Cleanup] è¿”è¿˜å‰©ä½™ ETH
   â””â”€ user.call{value: remaining}("")
```

### æœ€ç»ˆçŠ¶æ€

```
User Balance Changes:
  ETH: -1 ETH (åŒ…è£…æˆWETH)
  WETH (in Comet): +1 ETH (æŠµæŠ¼å“)
  USDC: +2,000 USDC (10,000ä¾›åº” - 8,000å€Ÿå‡º)
  USDC (in Comet): +10,000 USDC (ä¾›åº”)
  Debt: -8,000 USDC (å€Ÿè´·)
  COMP: +12.5 COMP (å¥–åŠ±)
  
Net Position:
  Assets: 1 ETH + 10,000 USDC (in Comet)
  Liabilities: 8,000 USDC debt
  Liquid: 2,000 USDC + 12.5 COMP
```

---

## æ¡ˆä¾‹5ï¼šè·¨é“¾æ¡¥æ¥

### åœºæ™¯

ç”¨æˆ·åœ¨ Ethereum Mainnet æœ‰ cUSDCv3ï¼Œæƒ³æ¡¥æ¥åˆ° Arbitrumã€‚

### ç¬¬1æ­¥ï¼šåœ¨ Mainnet å‘èµ·æ¡¥æ¥

**Transaction on Mainnet**:
```
Contract: ArbitrumBridgeSender
Function: bridge(address token, address to, uint amount)
Parameters:
  - token: 0xc3d688B66703497DAA19211EEdff47f25384cdc3 (Comet USDC)
  - to: 0x7a16... (ç”¨æˆ·åœ¨ Arbitrum çš„åœ°å€)
  - amount: 10000e6 (10,000 cUSDCv3)
```

### ç¬¬2æ­¥ï¼šè·¨é“¾æ¶ˆæ¯ä¼ é€’

```
L1 â†’ L2 Message Flow:

1. Mainnet Bridge:
   â”œâ”€ é”å®šç”¨æˆ·çš„ cUSDCv3
   â”œâ”€ å‘å‡º MessageSent äº‹ä»¶
   â””â”€ æäº¤åˆ° Arbitrum Inbox
   
2. Arbitrum Sequencer:
   â”œâ”€ æ¥æ”¶è·¨é“¾æ¶ˆæ¯
   â”œâ”€ éªŒè¯æ¶ˆæ¯ç­¾å
   â””â”€ æ’é˜Ÿç­‰å¾…æ‰§è¡Œ
   
3. Arbitrum Bridge Receiver:
   â”œâ”€ å¤„ç†æ¶ˆæ¯
   â”œâ”€ é“¸é€ å¯¹åº”æ•°é‡çš„ cUSDCv3
   â””â”€ è½¬ç»™ç”¨æˆ·
```

### å®Œæ•´è¿½è¸ª

ä½¿ç”¨ Etherscan + Arbiscan è¿½è¸ªï¼š

```
Mainnet Transaction:
  Hash: 0xabc...123
  Block: 18,234,567
  Time: 2023-10-15 14:23:45
  
  Logs:
    - MessageSent(messageId: 0xdef...456)
    - TokensLocked(amount: 10000e6)
    
Arbitrum Transaction:
  Hash: 0x789...xyz
  Block: 145,678,901
  Time: 2023-10-15 14:24:30 (45ç§’å)
  
  Logs:
    - MessageReceived(messageId: 0xdef...456)
    - TokensMinted(amount: 10000e6)
    - Transfer(to: 0x7a16..., amount: 10000e6)
```

**æˆæœ¬åˆ†æ**ï¼š
```
Mainnet Gas: 185,000 @ 30 gwei = 0.00555 ETH (~$10)
Arbitrum Gas: 450,000 @ 0.1 gwei = 0.000045 ETH (~$0.08)
Total Cost: ~$10.08
Time: ~45 seconds
```

---

## æ€»ç»“

### å¦‚ä½•ä½¿ç”¨è¿™äº›æ¡ˆä¾‹

1. **å­¦ä¹ åˆçº¦é€»è¾‘**
   - ç†è§£æ¯ä¸ªå‡½æ•°çš„æ‰§è¡Œæµç¨‹
   - çœ‹æ¸…æ¥šçŠ¶æ€å¦‚ä½•å˜åŒ–
   - æŒæ¡å…³é”®è®¡ç®—å…¬å¼

2. **æ„å»ºåº”ç”¨**
   - å‚è€ƒäº¤æ˜“æ„é€ æ–¹æ³•
   - ä½¿ç”¨ Etherscan API è·å–æ•°æ®
   - æ¨¡æ‹Ÿäº¤æ˜“æµ‹è¯•é€»è¾‘

3. **é£é™©ç®¡ç†**
   - ç›‘æ§æ¸…ç®—é£é™©
   - è®¾ç½®ä»·æ ¼è­¦æŠ¥
   - å‡†å¤‡åº”æ€¥é¢„æ¡ˆ

### æ¨èå·¥å…·

- **Etherscan**: æŸ¥çœ‹é“¾ä¸Šæ•°æ®
- **Tenderly**: æ·±åº¦è°ƒè¯•
- **Foundry**: æœ¬åœ°æµ‹è¯•
- **The Graph**: å†å²æ•°æ®æŸ¥è¯¢
- **Defender**: è‡ªåŠ¨åŒ–ç›‘æ§

### ä¸‹ä¸€æ­¥

1. åœ¨æµ‹è¯•ç½‘ä¸Šé‡ç°è¿™äº›äº¤æ˜“
2. æ„å»ºè‡ªå·±çš„æ¸…ç®—æœºå™¨äºº
3. å¼€å‘ç”¨æˆ·å‹å¥½çš„å‰ç«¯
4. å‚ä¸ Compound ç¤¾åŒº

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2026å¹´1æœˆ8æ—¥  
**è¯´æ˜**ï¼šä»¥ä¸Šäº¤æ˜“å“ˆå¸Œå’Œæ•°æ®æ˜¯ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶è¯·æŸ¥è¯¢çœŸå®çš„é“¾ä¸Šæ•°æ®ã€‚
