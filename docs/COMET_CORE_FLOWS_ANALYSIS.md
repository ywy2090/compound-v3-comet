# Compound Comet æ ¸å¿ƒæµç¨‹åˆ†æ

> æ·±åº¦è§£æ Compound V3 çš„æ ¸å¿ƒæ“ä½œæµç¨‹

## ç›®å½•

### ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€æ“ä½œæµç¨‹

1. [ç”¨æˆ·å­˜æ¬¾ä¸å–æ¬¾æµç¨‹](#ä¸€ç”¨æˆ·å­˜æ¬¾ä¸å–æ¬¾æµç¨‹)
   - 1.1 [å­˜æ¬¾æµç¨‹è¯¦è§£](#11-å­˜æ¬¾æµç¨‹è¯¦è§£)
   - 1.2 [å–æ¬¾æµç¨‹è¯¦è§£](#12-å–æ¬¾æµç¨‹è¯¦è§£)
2. [ç”¨æˆ·è´·æ¬¾ä¸è¿˜æ¬¾æµç¨‹](#äºŒç”¨æˆ·è´·æ¬¾ä¸è¿˜æ¬¾æµç¨‹)
   - 2.1 [è´·æ¬¾æœºåˆ¶](#21-è´·æ¬¾æœºåˆ¶)
   - 2.2 [è¿˜æ¬¾æœºåˆ¶](#22-è¿˜æ¬¾æœºåˆ¶)
3. [è®¡æ¯è®¡ç®—æœºåˆ¶](#ä¸‰è®¡æ¯è®¡ç®—æœºåˆ¶)
   - 3.1 [åˆ©ç‡æ¨¡å‹](#31-åˆ©ç‡æ¨¡å‹)
   - 3.2 [åˆ©æ¯ç´¯ç§¯æœºåˆ¶](#32-åˆ©æ¯ç´¯ç§¯æœºåˆ¶)
   - 3.3 [æœ¬é‡‘ä¸å½“å‰ä»·å€¼è½¬æ¢](#33-æœ¬é‡‘ä¸å½“å‰ä»·å€¼è½¬æ¢)
   - 3.4 [è®¡æ¯ç¤ºä¾‹è®¡ç®—](#34-è®¡æ¯ç¤ºä¾‹è®¡ç®—)
4. [æ¸…ç®—æµç¨‹](#å››æ¸…ç®—æµç¨‹)
   - 4.1 [æ¸…ç®—è§¦å‘æ¡ä»¶](#41-æ¸…ç®—è§¦å‘æ¡ä»¶)
   - 4.2 [æ¸…ç®—æ‰§è¡Œæµç¨‹](#42-æ¸…ç®—æ‰§è¡Œæµç¨‹)
   - 4.3 [è´­ä¹°æŠµæŠ¼å“](#43-è´­ä¹°æŠµæŠ¼å“)
   - 4.4 [æ¸…ç®—ç¤ºä¾‹åœºæ™¯](#44-æ¸…ç®—ç¤ºä¾‹åœºæ™¯)
   - 4.5 [æ¸…ç®—å®Œæ•´æ—¶åºå›¾](#45-æ¸…ç®—å®Œæ•´æ—¶åºå›¾)

### ç¬¬äºŒéƒ¨åˆ†ï¼šé«˜çº§æ“ä½œæµç¨‹

1. [è½¬è´¦æµç¨‹](#äº”è½¬è´¦æµç¨‹)
   - 5.1 [æ ¸å¿ƒæ¦‚å¿µ](#51-æ ¸å¿ƒæ¦‚å¿µ)
   - 5.2 [è½¬è´¦æ ¸å¿ƒä»£ç ](#52-è½¬è´¦æ ¸å¿ƒä»£ç )
   - 5.3 [è½¬è´¦åœºæ™¯ç¤ºä¾‹](#53-è½¬è´¦åœºæ™¯ç¤ºä¾‹)
   - 5.4 [è½¬è´¦æ—¶åºå›¾](#54-è½¬è´¦æ—¶åºå›¾)
2. [æˆæƒæœºåˆ¶](#å…­æˆæƒæœºåˆ¶)
   - 6.1 [æˆæƒç±»å‹](#61-æˆæƒç±»å‹)
   - 6.2 [æˆæƒæ ¸å¿ƒä»£ç ](#62-æˆæƒæ ¸å¿ƒä»£ç )
   - 6.3 [EIP-712 ç­¾åæµç¨‹](#63-eip-712-ç­¾åæµç¨‹)
   - 6.4 [æˆæƒæ—¶åºå›¾](#64-æˆæƒæ—¶åºå›¾)
3. [å¥–åŠ±é¢†å–æµç¨‹](#ä¸ƒå¥–åŠ±é¢†å–æµç¨‹)
   - 7.1 [å¥–åŠ±æœºåˆ¶æ¦‚è¿°](#71-å¥–åŠ±æœºåˆ¶æ¦‚è¿°)
   - 7.2 [å¥–åŠ±é…ç½®](#72-å¥–åŠ±é…ç½®)
   - 7.3 [å¥–åŠ±è®¡ç®—](#73-å¥–åŠ±è®¡ç®—)
   - 7.4 [å¥–åŠ±é¢†å–](#74-å¥–åŠ±é¢†å–)
   - 7.5 [å¥–åŠ±é¢†å–æ—¶åºå›¾](#75-å¥–åŠ±é¢†å–æ—¶åºå›¾)
4. [å‚¨å¤‡é‡‘æå–æµç¨‹](#å…«å‚¨å¤‡é‡‘æå–æµç¨‹)
   - 8.1 [å‚¨å¤‡é‡‘æœºåˆ¶](#81-å‚¨å¤‡é‡‘æœºåˆ¶)
   - 8.2 [æå–å‚¨å¤‡é‡‘](#82-æå–å‚¨å¤‡é‡‘)
   - 8.3 [å‚¨å¤‡é‡‘ç¤ºä¾‹](#83-å‚¨å¤‡é‡‘ç¤ºä¾‹)
   - 8.4 [å‚¨å¤‡é‡‘æå–æ—¶åºå›¾](#84-å‚¨å¤‡é‡‘æå–æ—¶åºå›¾)

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ²»ç†ä¸ç®¡ç†

1. [æš‚åœä¸æ¢å¤æœºåˆ¶](#ä¹æš‚åœä¸æ¢å¤æœºåˆ¶)
   - 9.1 [æš‚åœæœºåˆ¶è®¾è®¡](#91-æš‚åœæœºåˆ¶è®¾è®¡)
   - 9.2 [æš‚åœ/æ¢å¤æ“ä½œ](#92-æš‚åœæ¢å¤æ“ä½œ)
   - 9.3 [æš‚åœåœºæ™¯](#93-æš‚åœåœºæ™¯)
   - 9.4 [æš‚åœæ—¶åºå›¾](#94-æš‚åœæ—¶åºå›¾)
2. [åˆå§‹åŒ–æµç¨‹](#ååˆå§‹åŒ–æµç¨‹)
    - 10.1 [åˆå§‹åŒ–è®¾è®¡](#101-åˆå§‹åŒ–è®¾è®¡)
    - 10.2 [æ„é€ å‡½æ•°](#102-æ„é€ å‡½æ•°)
    - 10.3 [å­˜å‚¨åˆå§‹åŒ–](#103-å­˜å‚¨åˆå§‹åŒ–)
    - 10.4 [åˆå§‹åŒ–æ—¶åºå›¾](#104-åˆå§‹åŒ–æ—¶åºå›¾)
3. [æ‰¹é‡æ“ä½œï¼ˆBulkerï¼‰](#åä¸€æ‰¹é‡æ“ä½œbulker)
    - 11.1 [Bulker æ¦‚è¿°](#111-bulker-æ¦‚è¿°)
    - 11.2 [Bulker æ ¸å¿ƒä»£ç ](#112-bulker-æ ¸å¿ƒä»£ç )
    - 11.3 [ä½¿ç”¨ç¤ºä¾‹](#113-ä½¿ç”¨ç¤ºä¾‹)
    - 11.4 [Bulker æ—¶åºå›¾](#114-bulker-æ—¶åºå›¾)

### ç¬¬å››éƒ¨åˆ†ï¼šæ€»ç»“

1. [æ ¸å¿ƒæµç¨‹æ€»ç»“](#åäºŒæ ¸å¿ƒæµç¨‹æ€»ç»“)
    - 12.1 [æ‰€æœ‰æ ¸å¿ƒæµç¨‹æ¦‚è§ˆ](#121-æ‰€æœ‰æ ¸å¿ƒæµç¨‹æ¦‚è§ˆ)
    - 12.2 [æµç¨‹é—´å…³ç³»](#122-æµç¨‹é—´å…³ç³»)
    - 12.3 [å…³é”®è®¾è®¡æ¨¡å¼](#123-å…³é”®è®¾è®¡æ¨¡å¼)
    - 12.4 [å®‰å…¨æœºåˆ¶æ±‡æ€»](#124-å®‰å…¨æœºåˆ¶æ±‡æ€»)
2. [å…³é”®ç‚¹æ€»ç»“](#åä¸‰å…³é”®ç‚¹æ€»ç»“)
    - 13.1 [æ ¸å¿ƒæµç¨‹å…³é”®ç‚¹](#131-æ ¸å¿ƒæµç¨‹å…³é”®ç‚¹)
    - 13.2 [Gas ä¼˜åŒ–æŠ€å·§](#132-gas-ä¼˜åŒ–æŠ€å·§)
    - 13.3 [å®‰å…¨æœºåˆ¶](#133-å®‰å…¨æœºåˆ¶)
    - 13.4 [æ•°å­¦ç²¾åº¦](#134-æ•°å­¦ç²¾åº¦)
3. [å®é™…åº”ç”¨å»ºè®®](#åå››å®é™…åº”ç”¨å»ºè®®)
    - 14.1 [ç”¨æˆ·æ“ä½œå»ºè®®](#141-ç”¨æˆ·æ“ä½œå»ºè®®)
    - 14.2 [æ¸…ç®—æœºå™¨äººå»ºè®®](#142-æ¸…ç®—æœºå™¨äººå»ºè®®)

---

## ä¸€ã€ç”¨æˆ·å­˜æ¬¾ä¸å–æ¬¾æµç¨‹

### 1.1 å­˜æ¬¾æµç¨‹è¯¦è§£

#### æ ¸å¿ƒæ¦‚å¿µ

Comet åè®®ä¸­çš„"å­˜æ¬¾"åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š

- **åŸºç¡€èµ„äº§å­˜æ¬¾**ï¼šå­˜å…¥åŸºç¡€å€Ÿè´·èµ„äº§ï¼ˆå¦‚ USDCï¼‰ï¼Œè·å¾—åˆ©æ¯æ”¶ç›Š
- **æŠµæŠ¼å“å­˜æ¬¾**ï¼šå­˜å…¥æŠµæŠ¼å“èµ„äº§ï¼ˆå¦‚ ETHã€WBTCï¼‰ï¼Œä¸è·å¾—åˆ©æ¯ï¼Œä½†å¯ç”¨äºå€Ÿè´·

#### å­˜æ¬¾æ ¸å¿ƒä»£ç 

**å…¥å£å‡½æ•°** ([ğŸ“„ Comet.sol:835-876](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L835-L876)):

```solidity
function supply(address asset, uint amount) override external {
    return supplyInternal(msg.sender, msg.sender, msg.sender, asset, amount);
}

function supplyInternal(address operator, address from, address dst, address asset, uint amount) 
    internal nonReentrant {
    if (isSupplyPaused()) revert Paused();
    if (!hasPermission(from, operator)) revert Unauthorized();

    if (asset == baseToken) {
        // å­˜å…¥åŸºç¡€èµ„äº§
        if (amount == type(uint256).max) {
            amount = borrowBalanceOf(dst);  // è¿˜æ¸…å…¨éƒ¨å€ºåŠ¡
        }
        return supplyBase(from, dst, amount);
    } else {
        // å­˜å…¥æŠµæŠ¼å“
        return supplyCollateral(from, dst, asset, safe128(amount));
    }
}
```

**åŸºç¡€èµ„äº§å­˜æ¬¾** ([ğŸ“„ Comet.sol:881-903](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L881-L903)):

```solidity
function supplyBase(address from, address dst, uint256 amount) internal {
    // 1. è½¬å…¥ä»£å¸ï¼ˆå¤„ç†æ‰‹ç»­è´¹ä»£å¸ï¼‰
    amount = doTransferIn(baseToken, from, amount);

    // 2. ç´¯ç§¯åˆ©æ¯å’Œå¥–åŠ±
    accrueInternal();

    // 3. è¯»å–ç”¨æˆ·æ•°æ®
    UserBasic memory dstUser = userBasic[dst];
    int104 dstPrincipal = dstUser.principal;
    
    // 4. è®¡ç®—æ–°çš„ä½™é¢å’Œæœ¬é‡‘
    int256 dstBalance = presentValue(dstPrincipal) + signed256(amount);
    int104 dstPrincipalNew = principalValue(dstBalance);

    // 5. åŒºåˆ†è¿˜æ¬¾å’Œä¾›åº”
    (uint104 repayAmount, uint104 supplyAmount) = repayAndSupplyAmount(dstPrincipal, dstPrincipalNew);

    // 6. æ›´æ–°å…¨å±€çŠ¶æ€
    totalSupplyBase += supplyAmount;
    totalBorrowBase -= repayAmount;

    // 7. æ›´æ–°ç”¨æˆ·çŠ¶æ€å’Œå¥–åŠ±
    updateBasePrincipal(dst, dstUser, dstPrincipalNew);

    // 8. å‘å‡ºäº‹ä»¶
    emit Supply(from, dst, amount);
}
```

**æŠµæŠ¼å“å­˜æ¬¾** ([ğŸ“„ Comet.sol:908-928](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L908-L928)):

```solidity
function supplyCollateral(address from, address dst, address asset, uint128 amount) internal {
    // 1. è½¬å…¥ä»£å¸
    amount = safe128(doTransferIn(asset, from, amount));

    // 2. è·å–èµ„äº§ä¿¡æ¯
    AssetInfo memory assetInfo = getAssetInfoByAddress(asset);
    
    // 3. è¯»å–ç”¨æˆ·æŠµæŠ¼å“ä½™é¢
    TotalsCollateral memory totals = totalsCollateral[asset];
    uint128 totalSupplyAsset = totals.totalSupplyAsset;
    uint128 currBalance = userCollateral[dst][asset].balance;
    uint128 newBalance = currBalance + amount;

    // 4. æ£€æŸ¥ä¾›åº”ä¸Šé™
    if (totalSupplyAsset + amount > assetInfo.supplyCap) revert SupplyCapExceeded();

    // 5. æ›´æ–°çŠ¶æ€
    totalsCollateral[asset].totalSupplyAsset = totalSupplyAsset + amount;
    userCollateral[dst][asset].balance = newBalance;

    // 6. æ›´æ–°ç”¨æˆ·æŒæœ‰çš„èµ„äº§æ ‡å¿—ä½
    updateAssetsIn(dst, assetInfo, currBalance, newBalance);

    emit SupplyCollateral(from, dst, asset, amount);
}
```

#### å­˜æ¬¾æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant Contract as Cometåˆçº¦
    participant Token as ERC20ä»£å¸
    participant Storage as å­˜å‚¨å±‚

    User->>Contract: supply(asset, amount)
    activate Contract
    
    Contract->>Contract: æ£€æŸ¥æ˜¯å¦æš‚åœ
    Contract->>Contract: æ£€æŸ¥æƒé™
    
    alt å­˜å…¥åŸºç¡€èµ„äº§
        Contract->>Token: transferFrom(user, comet, amount)
        activate Token
        Token-->>Contract: è½¬è´¦æˆåŠŸ
        deactivate Token
        
        Contract->>Contract: accrueInternal()
        Note over Contract: ç´¯ç§¯åˆ©æ¯å’Œå¥–åŠ±
        
        Contract->>Storage: è¯»å–ç”¨æˆ·æœ¬é‡‘
        Storage-->>Contract: principal (å¯èƒ½ä¸ºæ­£æˆ–è´Ÿ)
        
        Contract->>Contract: è®¡ç®—æ–°ä½™é¢
        Note over Contract: presentValue(principal) + amount
        
        Contract->>Contract: åŒºåˆ†è¿˜æ¬¾æˆ–ä¾›åº”
        
        alt ç”¨æˆ·æœ‰å€ºåŠ¡ (principal < 0)
            Contract->>Storage: totalBorrowBase -= repayAmount
            Note over Contract: ä¼˜å…ˆè¿˜æ¬¾
        end
        
        Contract->>Storage: totalSupplyBase += supplyAmount
        Contract->>Storage: æ›´æ–°ç”¨æˆ·æœ¬é‡‘å’Œå¥–åŠ±
        
        Contract->>User: emit Supply(from, dst, amount)
        
    else å­˜å…¥æŠµæŠ¼å“
        Contract->>Token: transferFrom(user, comet, amount)
        Token-->>Contract: è½¬è´¦æˆåŠŸ
        
        Contract->>Contract: è·å–èµ„äº§ä¿¡æ¯
        Contract->>Contract: æ£€æŸ¥ä¾›åº”ä¸Šé™
        
        Contract->>Storage: totalsCollateral[asset] += amount
        Contract->>Storage: userCollateral[user][asset] += amount
        Contract->>Storage: æ›´æ–° assetsIn ä½æ ‡å¿—
        
        Contract->>User: emit SupplyCollateral(from, dst, asset, amount)
    end
    
    deactivate Contract
```

### 1.2 å–æ¬¾æµç¨‹è¯¦è§£

#### æ ¸å¿ƒæ¦‚å¿µ

- **å–æ¬¾**ï¼šæå–å­˜å…¥çš„åŸºç¡€èµ„äº§æˆ–æŠµæŠ¼å“
- **å€Ÿè´·**ï¼šå½“å–æ¬¾è¶…è¿‡ä¾›åº”é‡æ—¶ï¼Œè‡ªåŠ¨è¿›å…¥å€Ÿè´·æ¨¡å¼
- **æŠµæŠ¼æ£€æŸ¥**ï¼šå–æ¬¾å’Œå€Ÿè´·éƒ½éœ€è¦æ£€æŸ¥æŠµæŠ¼ç‡

#### å–æ¬¾æ ¸å¿ƒä»£ç 

**å…¥å£å‡½æ•°** ([ğŸ“„ Comet.sol:1057-1098](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L1057-L1098)):

```solidity
function withdraw(address asset, uint amount) override external {
    return withdrawInternal(msg.sender, msg.sender, msg.sender, asset, amount);
}

function withdrawInternal(address operator, address src, address to, address asset, uint amount) 
    internal nonReentrant {
    if (isWithdrawPaused()) revert Paused();
    if (!hasPermission(src, operator)) revert Unauthorized();

    if (asset == baseToken) {
        if (amount == type(uint256).max) {
            amount = balanceOf(src);  // æå–å…¨éƒ¨ä½™é¢
        }
        return withdrawBase(src, to, amount);
    } else {
        return withdrawCollateral(src, to, asset, safe128(amount));
    }
}
```

**åŸºç¡€èµ„äº§å–æ¬¾/å€Ÿè´·** ([ğŸ“„ Comet.sol:1103-1130](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L1103-L1130)):

```solidity
function withdrawBase(address src, address to, uint256 amount) internal {
    accrueInternal();  // å…ˆç´¯ç§¯åˆ©æ¯

    // 1. è¯»å–ç”¨æˆ·æ•°æ®
    UserBasic memory srcUser = userBasic[src];
    int104 srcPrincipal = srcUser.principal;
    
    // 2. è®¡ç®—æ–°ä½™é¢ï¼ˆå‡å»å–æ¬¾é‡ï¼‰
    int256 srcBalance = presentValue(srcPrincipal) - signed256(amount);
    int104 srcPrincipalNew = principalValue(srcBalance);

    // 3. åŒºåˆ†å–æ¬¾å’Œå€Ÿè´·
    (uint104 withdrawAmount, uint104 borrowAmount) = withdrawAndBorrowAmount(srcPrincipal, srcPrincipalNew);

    // 4. æ›´æ–°å…¨å±€çŠ¶æ€
    totalSupplyBase -= withdrawAmount;
    totalBorrowBase += borrowAmount;

    // 5. æ›´æ–°ç”¨æˆ·çŠ¶æ€
    updateBasePrincipal(src, srcUser, srcPrincipalNew);

    // 6. å€Ÿè´·æ£€æŸ¥
    if (srcBalance < 0) {
        // æ£€æŸ¥æœ€å°å€Ÿè´·é‡
        if (uint256(-srcBalance) < baseBorrowMin) revert BorrowTooSmall();
        // æ£€æŸ¥æŠµæŠ¼ç‡
        if (!isBorrowCollateralized(src)) revert NotCollateralized();
    }

    // 7. è½¬å‡ºä»£å¸
    doTransferOut(baseToken, to, amount);

    emit Withdraw(src, to, amount);
}
```

**æŠµæŠ¼ç‡æ£€æŸ¥** ([ğŸ“„ Comet.sol:524-559](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L524-L559)):

```solidity
function isBorrowCollateralized(address account) override public view returns (bool) {
    int104 principal = userBasic[account].principal;
    
    // å¦‚æœæ²¡æœ‰å€Ÿè´·ï¼Œæ€»æ˜¯é€šè¿‡
    if (principal >= 0) {
        return true;
    }

    uint16 assetsIn = userBasic[account].assetsIn;
    
    // è®¡ç®—å€ºåŠ¡ä»·å€¼ï¼ˆè´Ÿå€¼ï¼‰
    int liquidity = signedMulPrice(
        presentValue(principal),
        getPrice(baseTokenPriceFeed),
        uint64(baseScale)
    );

    // éå†æ‰€æœ‰æŠµæŠ¼å“
    for (uint8 i = 0; i < numAssets; ) {
        if (isInAsset(assetsIn, i)) {
            if (liquidity >= 0) {
                return true;  // å·²ç»è¶³å¤ŸæŠµæŠ¼
            }

            AssetInfo memory asset = getAssetInfo(i);
            
            // è®¡ç®—æŠµæŠ¼å“ä»·å€¼
            uint newAmount = mulPrice(
                userCollateral[account][asset.asset].balance,
                getPrice(asset.priceFeed),
                asset.scale
            );
            
            // åº”ç”¨å€Ÿè´·æŠµæŠ¼å› å­
            liquidity += signed256(mulFactor(
                newAmount,
                asset.borrowCollateralFactor
            ));
        }
        unchecked { i++; }
    }

    return liquidity >= 0;
}
```

**åŒºåˆ†å–æ¬¾å’Œå€Ÿè´·** ([ğŸ“„ Comet.sol:622-633](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L622-L633)):

```solidity
function withdrawAndBorrowAmount(int104 oldPrincipal, int104 newPrincipal) 
    internal pure returns (uint104, uint104) {
    // å¦‚æœæ–°æœ¬é‡‘æ›´å¤§ï¼Œè¯´æ˜æ²¡æœ‰å–æ¬¾æˆ–å€Ÿè´·
    if (newPrincipal > oldPrincipal) return (0, 0);

    if (newPrincipal >= 0) {
        // åªæ˜¯å–æ¬¾ï¼ˆä»æ­£åˆ°æ­£ï¼‰
        return (uint104(oldPrincipal - newPrincipal), 0);
    } else if (oldPrincipal <= 0) {
        // åªæ˜¯å€Ÿè´·ï¼ˆä»è´Ÿåˆ°è´Ÿï¼‰
        return (0, uint104(oldPrincipal - newPrincipal));
    } else {
        // å…ˆå–æ¬¾å†å€Ÿè´·ï¼ˆä»æ­£åˆ°è´Ÿï¼‰
        return (uint104(oldPrincipal), uint104(-newPrincipal));
    }
}
```

#### å–æ¬¾/å€Ÿè´·æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant Contract as Cometåˆçº¦
    participant Token as ERC20ä»£å¸
    participant PriceFeed as ä»·æ ¼é¢„è¨€æœº
    participant Storage as å­˜å‚¨å±‚

    User->>Contract: withdraw(asset, amount)
    activate Contract
    
    Contract->>Contract: æ£€æŸ¥æ˜¯å¦æš‚åœ
    Contract->>Contract: æ£€æŸ¥æƒé™
    
    alt å–æ¬¾åŸºç¡€èµ„äº§
        Contract->>Contract: accrueInternal()
        Note over Contract: ç´¯ç§¯åˆ©æ¯å’Œå¥–åŠ±
        
        Contract->>Storage: è¯»å–ç”¨æˆ·æœ¬é‡‘
        Storage-->>Contract: principal (å¯èƒ½ä¸ºæ­£æˆ–è´Ÿ)
        
        Contract->>Contract: è®¡ç®—æ–°ä½™é¢
        Note over Contract: presentValue(principal) - amount
        
        alt æ–°ä½™é¢ >= 0 (çº¯å–æ¬¾)
            Contract->>Storage: totalSupplyBase -= withdrawAmount
            Note over Contract: åªæ˜¯æ™®é€šå–æ¬¾
            
        else æ–°ä½™é¢ < 0 (è¿›å…¥å€Ÿè´·)
            alt åŸä½™é¢ > 0
                Contract->>Storage: totalSupplyBase -= åŸä½™é¢
                Contract->>Storage: totalBorrowBase += |æ–°ä½™é¢|
                Note over Contract: å…ˆå–å…‰å­˜æ¬¾ï¼Œå†å€Ÿè´·
            else åŸä½™é¢ <= 0
                Contract->>Storage: totalBorrowBase += å€Ÿè´·å¢é‡
                Note over Contract: å¢åŠ å€Ÿè´·
            end
            
            Contract->>Contract: æ£€æŸ¥æœ€å°å€Ÿè´·é‡
            
            Contract->>Contract: isBorrowCollateralized()
            activate Contract
            Note over Contract: æŠµæŠ¼ç‡æ£€æŸ¥
            
            loop éå†æ‰€æœ‰æŠµæŠ¼å“
                Contract->>Storage: è¯»å–æŠµæŠ¼å“ä½™é¢
                Storage-->>Contract: collateral balance
                
                Contract->>PriceFeed: getPrice(priceFeed)
                PriceFeed-->>Contract: price
                
                Contract->>Contract: è®¡ç®—æŠµæŠ¼å“ä»·å€¼
                Note over Contract: balance Ã— price Ã— borrowCF
            end
            
            Contract->>Contract: æ£€æŸ¥: æŠµæŠ¼å“ä»·å€¼ >= å€ºåŠ¡ä»·å€¼
            
            alt æŠµæŠ¼ä¸è¶³
                Contract-->>User: revert NotCollateralized()
            end
            deactivate Contract
        end
        
        Contract->>Storage: æ›´æ–°ç”¨æˆ·æœ¬é‡‘å’Œå¥–åŠ±
        
        Contract->>Token: transfer(to, amount)
        activate Token
        Token-->>Contract: è½¬è´¦æˆåŠŸ
        deactivate Token
        
        Contract->>User: emit Withdraw(src, to, amount)
        
    else å–æ¬¾æŠµæŠ¼å“
        Contract->>Storage: è¯»å–æŠµæŠ¼å“ä½™é¢
        Contract->>Storage: userCollateral[user][asset] -= amount
        Contract->>Storage: totalsCollateral[asset] -= amount
        Contract->>Storage: æ›´æ–° assetsIn ä½æ ‡å¿—
        
        Contract->>Contract: isBorrowCollateralized()
        Note over Contract: æ£€æŸ¥å–æ¬¾åæŠµæŠ¼ç‡
        
        Contract->>Token: transfer(to, amount)
        Token-->>Contract: è½¬è´¦æˆåŠŸ
        
        Contract->>User: emit WithdrawCollateral(src, to, asset, amount)
    end
    
    deactivate Contract
```

---

## äºŒã€ç”¨æˆ·è´·æ¬¾ä¸è¿˜æ¬¾æµç¨‹

### 2.1 è´·æ¬¾æœºåˆ¶

#### æ ¸å¿ƒæ¦‚å¿µ

Comet çš„è´·æ¬¾**ä¸æ˜¯ç‹¬ç«‹çš„æ“ä½œ**ï¼Œè€Œæ˜¯é€šè¿‡**å–æ¬¾è¶…è¿‡ä¾›åº”é‡**è‡ªåŠ¨è§¦å‘ï¼š

- ç”¨æˆ· principal > 0ï¼šæœ‰ä¾›åº”ä½™é¢
- ç”¨æˆ· principal = 0ï¼šæ—¢æ— ä¾›åº”ä¹Ÿæ— å€Ÿè´·
- ç”¨æˆ· principal < 0ï¼šæœ‰å€Ÿè´·ï¼ˆè´Ÿçš„ principal è¡¨ç¤ºå€ºåŠ¡ï¼‰

#### è´·æ¬¾ç¤ºä¾‹åœºæ™¯

```
åœºæ™¯1ï¼šç”¨æˆ·é¦–æ¬¡å€Ÿè´·
- åˆå§‹çŠ¶æ€ï¼šprincipal = 0ï¼ŒæŠµæŠ¼å“ = 10 ETH
- æ“ä½œï¼šwithdraw(USDC, 5000)
- ç»“æœï¼šprincipal = -5000ï¼ˆè½¬ä¸ºå€ºåŠ¡ï¼‰ï¼Œå–å¾— 5000 USDC

åœºæ™¯2ï¼šç”¨æˆ·å·²æœ‰å­˜æ¬¾åå€Ÿè´·
- åˆå§‹çŠ¶æ€ï¼šprincipal = +3000 USDCï¼ŒæŠµæŠ¼å“ = 10 ETH
- æ“ä½œï¼šwithdraw(USDC, 8000)
- ç»“æœï¼š
  - å…ˆå–å‡º 3000 ä¾›åº”
  - å†å€Ÿå…¥ 5000
  - æœ€ç»ˆ principal = -5000

åœºæ™¯3ï¼šå€Ÿè´·é™åˆ¶
- æœ€å°å€Ÿè´·é‡ï¼šbaseBorrowMin (å¦‚ 100 USDC)
- ä¸èƒ½å€Ÿå¤ªå°çš„é‡‘é¢ï¼Œé¿å…ç°å°˜æ”»å‡»
```

#### å€Ÿè´·èƒ½åŠ›è®¡ç®—

**å…¬å¼**ï¼š

```
å€Ÿè´·èƒ½åŠ› = Î£ (æŠµæŠ¼å“ä»·å€¼ Ã— borrowCollateralFactor)

å…¶ä¸­ï¼š
- æŠµæŠ¼å“ä»·å€¼ = æŠµæŠ¼å“ä½™é¢ Ã— ä»·æ ¼
- borrowCollateralFactor: é€šå¸¸ 0.70 ~ 0.85 (70% ~ 85%)
```

**ä»£ç å®ç°** (è§ä¸Šæ–‡ `isBorrowCollateralized`)

### 2.2 è¿˜æ¬¾æœºåˆ¶

#### æ ¸å¿ƒæ¦‚å¿µ

è¿˜æ¬¾ä¹Ÿ**ä¸æ˜¯ç‹¬ç«‹çš„æ“ä½œ**ï¼Œè€Œæ˜¯é€šè¿‡**å­˜å…¥åŸºç¡€èµ„äº§**è‡ªåŠ¨è¿˜æ¬¾ï¼š

- å¦‚æœç”¨æˆ·æœ‰å€ºåŠ¡ï¼ˆprincipal < 0ï¼‰ï¼Œå­˜å…¥ä¼šä¼˜å…ˆå¿è¿˜å€ºåŠ¡
- å€ºåŠ¡è¿˜æ¸…åï¼Œå‰©ä½™éƒ¨åˆ†æˆä¸ºä¾›åº”

#### è¿˜æ¬¾ç¤ºä¾‹åœºæ™¯

```
åœºæ™¯1ï¼šéƒ¨åˆ†è¿˜æ¬¾
- åˆå§‹çŠ¶æ€ï¼šprincipal = -5000 USDCï¼ˆå€ºåŠ¡ï¼‰
- æ“ä½œï¼šsupply(USDC, 2000)
- ç»“æœï¼šprincipal = -3000 USDCï¼ˆè¿˜å‰© 3000 å€ºåŠ¡ï¼‰

åœºæ™¯2ï¼šå®Œå…¨è¿˜æ¬¾
- åˆå§‹çŠ¶æ€ï¼šprincipal = -5000 USDC
- æ“ä½œï¼šsupply(USDC, 5000)
- ç»“æœï¼šprincipal = 0ï¼ˆå€ºåŠ¡è¿˜æ¸…ï¼‰

åœºæ™¯3ï¼šè¿˜æ¬¾å¹¶è½¬ä¸ºä¾›åº”
- åˆå§‹çŠ¶æ€ï¼šprincipal = -3000 USDC
- æ“ä½œï¼šsupply(USDC, 8000)
- ç»“æœï¼š
  - å…ˆè¿˜ 3000 å€ºåŠ¡
  - å‰©ä½™ 5000 æˆä¸ºä¾›åº”
  - æœ€ç»ˆ principal = +5000

åœºæ™¯4ï¼šä¸€é”®è¿˜æ¸…
- æ“ä½œï¼šsupply(baseToken, type(uint256).max)
- ä¼šè‡ªåŠ¨è®¡ç®—å€ºåŠ¡å¹¶è¿˜æ¸…å…¨éƒ¨
```

#### è¿˜æ¬¾åŒºåˆ†é€»è¾‘

**ä»£ç ** ([ğŸ“„ Comet.sol:606-617](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L606-L617)):

```solidity
function repayAndSupplyAmount(int104 oldPrincipal, int104 newPrincipal) 
    internal pure returns (uint104, uint104) {
    // å¦‚æœæ–°æœ¬é‡‘æ›´å°ï¼Œè¯´æ˜æ²¡æœ‰è¿˜æ¬¾æˆ–ä¾›åº”
    if (newPrincipal < oldPrincipal) return (0, 0);

    if (newPrincipal <= 0) {
        // åªæ˜¯è¿˜æ¬¾ï¼ˆä»è´Ÿåˆ°è´Ÿï¼Œæˆ–åˆ°0ï¼‰
        return (uint104(newPrincipal - oldPrincipal), 0);
    } else if (oldPrincipal >= 0) {
        // åªæ˜¯ä¾›åº”ï¼ˆä»æ­£åˆ°æ­£ï¼‰
        return (0, uint104(newPrincipal - oldPrincipal));
    } else {
        // å…ˆè¿˜æ¬¾å†ä¾›åº”ï¼ˆä»è´Ÿåˆ°æ­£ï¼‰
        return (uint104(-oldPrincipal), uint104(newPrincipal));
    }
}
```

#### è´·æ¬¾/è¿˜æ¬¾æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant Contract as Cometåˆçº¦
    participant Storage as å­˜å‚¨å±‚
    participant PriceFeed as ä»·æ ¼é¢„è¨€æœº

    Note over User,PriceFeed: === åœºæ™¯1ï¼šå€Ÿè´·æµç¨‹ ===
    
    User->>Contract: withdraw(USDC, 5000)
    activate Contract
    
    Contract->>Contract: accrueInternal()
    Contract->>Storage: è¯»å– principal = 0
    
    Contract->>Contract: æ–°ä½™é¢ = 0 - 5000 = -5000
    Note over Contract: principalè½¬ä¸ºè´Ÿå€¼ï¼ˆå€ºåŠ¡ï¼‰
    
    Contract->>Contract: withdrawAndBorrowAmount()
    Note over Contract: borrowAmount = 5000
    
    Contract->>Storage: totalBorrowBase += 5000
    Contract->>Storage: principal = -5000
    
    Contract->>Contract: æ£€æŸ¥: |balance| >= baseBorrowMin
    
    Contract->>Contract: isBorrowCollateralized()
    activate Contract
    
    loop è®¡ç®—æŠµæŠ¼å“ä»·å€¼
        Contract->>Storage: è¯»å–å„æŠµæŠ¼å“ä½™é¢
        Contract->>PriceFeed: è·å–ä»·æ ¼
        Contract->>Contract: ç´¯åŠ æŠµæŠ¼ä»·å€¼
    end
    
    Contract->>Contract: éªŒè¯: æŠµæŠ¼ä»·å€¼ >= å€ºåŠ¡ä»·å€¼
    deactivate Contract
    
    Contract->>User: è½¬å‡º 5000 USDC
    Contract->>User: emit Withdraw(user, user, 5000)
    deactivate Contract
    
    Note over User,PriceFeed: === åœºæ™¯2ï¼šè¿˜æ¬¾æµç¨‹ ===
    
    User->>Contract: supply(USDC, 3000)
    activate Contract
    
    Contract->>User: transferFrom 3000 USDC
    Contract->>Contract: accrueInternal()
    Contract->>Storage: è¯»å– principal = -5000
    
    Contract->>Contract: æ–°ä½™é¢ = -5000 + 3000 = -2000
    Note over Contract: éƒ¨åˆ†è¿˜æ¬¾ï¼Œä»æœ‰å€ºåŠ¡
    
    Contract->>Contract: repayAndSupplyAmount()
    Note over Contract: repayAmount = 3000, supplyAmount = 0
    
    Contract->>Storage: totalBorrowBase -= 3000
    Contract->>Storage: principal = -2000
    
    Contract->>User: emit Supply(user, user, 3000)
    deactivate Contract
    
    Note over User,PriceFeed: === åœºæ™¯3ï¼šè¿˜æ¸…å¹¶ä¾›åº” ===
    
    User->>Contract: supply(USDC, 8000)
    activate Contract
    
    Contract->>User: transferFrom 8000 USDC
    Contract->>Contract: accrueInternal()
    Contract->>Storage: è¯»å– principal = -2000
    
    Contract->>Contract: æ–°ä½™é¢ = -2000 + 8000 = +6000
    Note over Contract: å…ˆè¿˜æ¸…å€ºåŠ¡ï¼Œå†æˆä¸ºä¾›åº”
    
    Contract->>Contract: repayAndSupplyAmount()
    Note over Contract: repayAmount = 2000, supplyAmount = 6000
    
    Contract->>Storage: totalBorrowBase -= 2000
    Contract->>Storage: totalSupplyBase += 6000
    Contract->>Storage: principal = +6000
    
    Contract->>User: emit Supply(user, user, 8000)
    deactivate Contract
```

---

## ä¸‰ã€è®¡æ¯è®¡ç®—æœºåˆ¶

### 3.1 åˆ©ç‡æ¨¡å‹

Comet ä½¿ç”¨**åŒæ–œç‡ï¼ˆKinkï¼‰åˆ©ç‡æ¨¡å‹**ï¼š

#### åˆ©ç‡å…¬å¼

**ä¾›åº”åˆ©ç‡**ï¼š

```
if utilization <= supplyKink:
    supplyRate = supplyRateBase + supplyRateSlopeLow Ã— utilization
else:
    supplyRate = supplyRateBase 
                + supplyRateSlopeLow Ã— supplyKink
                + supplyRateSlopeHigh Ã— (utilization - supplyKink)
```

**å€Ÿè´·åˆ©ç‡**ï¼š

```
if utilization <= borrowKink:
    borrowRate = borrowRateBase + borrowRateSlopeLow Ã— utilization
else:
    borrowRate = borrowRateBase 
                + borrowRateSlopeLow Ã— borrowKink
                + borrowRateSlopeHigh Ã— (utilization - borrowKink)
```

**èµ„é‡‘åˆ©ç”¨ç‡**ï¼š

```
utilization = totalBorrow / totalSupply
```

#### åˆ©ç‡è®¡ç®—ä»£ç 

**åˆ©ç”¨ç‡** ([ğŸ“„ Comet.sol:478-486](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L478-L486)):

```solidity
function getUtilization() override public view returns (uint) {
    uint totalSupply_ = presentValueSupply(baseSupplyIndex, totalSupplyBase);
    uint totalBorrow_ = presentValueBorrow(baseBorrowIndex, totalBorrowBase);
    if (totalSupply_ == 0) {
        return 0;
    } else {
        return totalBorrow_ * FACTOR_SCALE / totalSupply_;
    }
}
```

**ä¾›åº”åˆ©ç‡** ([ğŸ“„ Comet.sol:449-457](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L449-L457)):

```solidity
function getSupplyRate(uint utilization) override public view returns (uint64) {
    if (utilization <= supplyKink) {
        // ä½äºæ‹ç‚¹
        return safe64(supplyPerSecondInterestRateBase + 
                     mulFactor(supplyPerSecondInterestRateSlopeLow, utilization));
    } else {
        // é«˜äºæ‹ç‚¹
        return safe64(supplyPerSecondInterestRateBase + 
                     mulFactor(supplyPerSecondInterestRateSlopeLow, supplyKink) + 
                     mulFactor(supplyPerSecondInterestRateSlopeHigh, (utilization - supplyKink)));
    }
}
```

**å€Ÿè´·åˆ©ç‡** ([ğŸ“„ Comet.sol:464-472](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L464-L472)):

```solidity
function getBorrowRate(uint utilization) override public view returns (uint64) {
    if (utilization <= borrowKink) {
        return safe64(borrowPerSecondInterestRateBase + 
                     mulFactor(borrowPerSecondInterestRateSlopeLow, utilization));
    } else {
        return safe64(borrowPerSecondInterestRateBase + 
                     mulFactor(borrowPerSecondInterestRateSlopeLow, borrowKink) + 
                     mulFactor(borrowPerSecondInterestRateSlopeHigh, (utilization - borrowKink)));
    }
}
```

### 3.2 åˆ©æ¯ç´¯ç§¯æœºåˆ¶

#### æŒ‡æ•°ç´¯ç§¯åŸç†

Comet ä½¿ç”¨**æŒ‡æ•°ç´¯ç§¯**æ–¹å¼è®¡ç®—åˆ©æ¯ï¼Œè€Œä¸æ˜¯ç®€å•çš„çº¿æ€§ç´¯åŠ ï¼š

**æ ¸å¿ƒå…¬å¼**ï¼š

```
æ–°æŒ‡æ•° = æ—§æŒ‡æ•° Ã— (1 + åˆ©ç‡ Ã— æ—¶é—´é—´éš”)

ç”¨æˆ·å½“å‰ä»·å€¼ = ç”¨æˆ·æœ¬é‡‘ Ã— å½“å‰æŒ‡æ•° / åŸºç¡€æŒ‡æ•°
```

**ä¼˜åŠ¿**ï¼š

- å¤åˆ©è®¡ç®—è‡ªåŠ¨å®Œæˆ
- ä¸éœ€è¦éå†æ‰€æœ‰ç”¨æˆ·
- Gas æˆæœ¬å›ºå®šï¼Œä¸éšç”¨æˆ·æ•°å¢åŠ 

#### åˆ©æ¯ç´¯ç§¯ä»£ç 

**æŒ‡æ•°è®¡ç®—** ([ğŸ“„ Comet.sol:403-414](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L403-L414)):

```solidity
function accruedInterestIndices(uint timeElapsed) internal view returns (uint64, uint64) {
    uint64 baseSupplyIndex_ = baseSupplyIndex;
    uint64 baseBorrowIndex_ = baseBorrowIndex;
    
    if (timeElapsed > 0) {
        // 1. è·å–å½“å‰åˆ©ç”¨ç‡
        uint utilization = getUtilization();
        
        // 2. è®¡ç®—ä¾›åº”å’Œå€Ÿè´·åˆ©ç‡
        uint supplyRate = getSupplyRate(utilization);
        uint borrowRate = getBorrowRate(utilization);
        
        // 3. æ›´æ–°æŒ‡æ•°
        baseSupplyIndex_ += safe64(mulFactor(baseSupplyIndex_, supplyRate * timeElapsed));
        baseBorrowIndex_ += safe64(mulFactor(baseBorrowIndex_, borrowRate * timeElapsed));
    }
    
    return (baseSupplyIndex_, baseBorrowIndex_);
}
```

**å…¨å±€ç´¯ç§¯** ([ğŸ“„ Comet.sol:419-432](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L419-L432)):

```solidity
function accrueInternal() internal {
    uint40 now_ = getNowInternal();
    uint timeElapsed = uint256(now_ - lastAccrualTime);
    
    if (timeElapsed > 0) {
        // 1. æ›´æ–°åˆ©æ¯æŒ‡æ•°
        (baseSupplyIndex, baseBorrowIndex) = accruedInterestIndices(timeElapsed);
        
        // 2. æ›´æ–°å¥–åŠ±è¿½è¸ªæŒ‡æ•°ï¼ˆå¦‚æœè¾¾åˆ°æœ€å°è¦æ±‚ï¼‰
        if (totalSupplyBase >= baseMinForRewards) {
            trackingSupplyIndex += safe64(divBaseWei(
                baseTrackingSupplySpeed * timeElapsed, 
                totalSupplyBase
            ));
        }
        if (totalBorrowBase >= baseMinForRewards) {
            trackingBorrowIndex += safe64(divBaseWei(
                baseTrackingBorrowSpeed * timeElapsed, 
                totalBorrowBase
            ));
        }
        
        // 3. æ›´æ–°æ—¶é—´æˆ³
        lastAccrualTime = now_;
    }
}
```

**ç”¨æˆ·å¥–åŠ±æ›´æ–°** ([ğŸ“„ Comet.sol:761-780](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L761-L780)):

```solidity
function updateBasePrincipal(address account, UserBasic memory basic, int104 principalNew) internal {
    int104 principal = basic.principal;
    basic.principal = principalNew;

    // è®¡ç®—å¥–åŠ±å¢é‡
    if (principal >= 0) {
        // ä¾›åº”å¥–åŠ±
        uint indexDelta = uint256(trackingSupplyIndex - basic.baseTrackingIndex);
        basic.baseTrackingAccrued += safe64(
            uint104(principal) * indexDelta / trackingIndexScale / accrualDescaleFactor
        );
    } else {
        // å€Ÿè´·å¥–åŠ±
        uint indexDelta = uint256(trackingBorrowIndex - basic.baseTrackingIndex);
        basic.baseTrackingAccrued += safe64(
            uint104(-principal) * indexDelta / trackingIndexScale / accrualDescaleFactor
        );
    }

    // æ›´æ–°ç”¨æˆ·çš„è¿½è¸ªç´¢å¼•
    if (principalNew >= 0) {
        basic.baseTrackingIndex = trackingSupplyIndex;
    } else {
        basic.baseTrackingIndex = trackingBorrowIndex;
    }

    userBasic[account] = basic;
}
```

### 3.3 æœ¬é‡‘ä¸å½“å‰ä»·å€¼è½¬æ¢

#### è½¬æ¢åŸç†

```
å½“å‰ä»·å€¼ = æœ¬é‡‘ Ã— æŒ‡æ•° / BASE_INDEX_SCALE

æœ¬é‡‘ = å½“å‰ä»·å€¼ Ã— BASE_INDEX_SCALE / æŒ‡æ•°
```

**é‡è¦ç»†èŠ‚**ï¼š

- ä¾›åº”ï¼šå‘ä¸‹èˆå…¥ï¼ˆå¯¹åè®®æœ‰åˆ©ï¼‰
- å€Ÿè´·ï¼šå‘ä¸Šèˆå…¥ï¼ˆå¯¹åè®®æœ‰åˆ©ï¼‰

#### è½¬æ¢ä»£ç 

**æœ¬é‡‘ â†’ å½“å‰ä»·å€¼** ([ğŸ“„ CometCore.sol:79-99](https://github.com/compound-finance/comet/blob/main/contracts/CometCore.sol#L79-L99)):

```solidity
function presentValue(int104 principalValue_) internal view returns (int256) {
    if (principalValue_ >= 0) {
        // ä¾›åº”ä½™é¢
        return signed256(presentValueSupply(baseSupplyIndex, uint104(principalValue_)));
    } else {
        // å€Ÿè´·ä½™é¢
        return -signed256(presentValueBorrow(baseBorrowIndex, uint104(-principalValue_)));
    }
}

function presentValueSupply(uint64 baseSupplyIndex_, uint104 principalValue_) 
    internal pure returns (uint256) {
    return uint256(principalValue_) * baseSupplyIndex_ / BASE_INDEX_SCALE;
}

function presentValueBorrow(uint64 baseBorrowIndex_, uint104 principalValue_) 
    internal pure returns (uint256) {
    return uint256(principalValue_) * baseBorrowIndex_ / BASE_INDEX_SCALE;
}
```

**å½“å‰ä»·å€¼ â†’ æœ¬é‡‘** ([ğŸ“„ CometCore.sol:104-126](https://github.com/compound-finance/comet/blob/main/contracts/CometCore.sol#L104-L126)):

```solidity
function principalValue(int256 presentValue_) internal view returns (int104) {
    if (presentValue_ >= 0) {
        return signed104(principalValueSupply(baseSupplyIndex, uint256(presentValue_)));
    } else {
        return -signed104(principalValueBorrow(baseBorrowIndex, uint256(-presentValue_)));
    }
}

function principalValueSupply(uint64 baseSupplyIndex_, uint256 presentValue_) 
    internal pure returns (uint104) {
    // å‘ä¸‹èˆå…¥
    return safe104((presentValue_ * BASE_INDEX_SCALE) / baseSupplyIndex_);
}

function principalValueBorrow(uint64 baseBorrowIndex_, uint256 presentValue_) 
    internal pure returns (uint104) {
    // å‘ä¸Šèˆå…¥ï¼ˆ+baseBorrowIndex_ - 1ï¼‰
    return safe104((presentValue_ * BASE_INDEX_SCALE + baseBorrowIndex_ - 1) / baseBorrowIndex_);
}
```

### 3.4 è®¡æ¯ç¤ºä¾‹è®¡ç®—

#### ç¤ºä¾‹å‚æ•°

```
åˆå§‹çŠ¶æ€ï¼š
- baseSupplyIndex = 1e15 (BASE_INDEX_SCALE)
- baseBorrowIndex = 1e15
- supplyRate = 0.02 / year = 6.34e-10 / second (2% APY)
- borrowRate = 0.05 / year = 1.59e-9 / second (5% APY)
- ç”¨æˆ·ä¾›åº”æœ¬é‡‘ = 1000 USDC
- æ—¶é—´ç»è¿‡ = 30 å¤©
```

#### è®¡ç®—è¿‡ç¨‹

**æ­¥éª¤1ï¼šè®¡ç®—æ–°æŒ‡æ•°**

```
æ—¶é—´ç»è¿‡ = 30 Ã— 24 Ã— 3600 = 2,592,000 ç§’

æ–°ä¾›åº”æŒ‡æ•° = æ—§æŒ‡æ•° Ã— (1 + åˆ©ç‡ Ã— æ—¶é—´)
          = 1e15 Ã— (1 + 6.34e-10 Ã— 2,592,000)
          = 1e15 Ã— (1 + 0.001643)
          = 1e15 Ã— 1.001643
          = 1.001643e15

å®é™…è®¡ç®—ï¼ˆæ•´æ•°è¿ç®—ï¼‰ï¼š
å¢é‡ = 1e15 Ã— 6.34e-10 Ã— 2,592,000 / 1e18
    â‰ˆ 1.643e12
æ–°æŒ‡æ•° = 1e15 + 1.643e12 = 1.001643e15
```

**æ­¥éª¤2ï¼šè®¡ç®—ç”¨æˆ·å½“å‰ä»·å€¼**

```
ç”¨æˆ·æœ¬é‡‘ = 1000e6 (1000 USDC, 6ä½å°æ•°)

å½“å‰ä»·å€¼ = principal Ã— newIndex / BASE_INDEX_SCALE
        = 1000e6 Ã— 1.001643e15 / 1e15
        = 1000e6 Ã— 1.001643
        = 1001.643e6
        = 1001.643 USDC

èµšå–åˆ©æ¯ = 1001.643 - 1000 = 1.643 USDC
```

#### è®¡æ¯æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor Anyone as ä»»ä½•äºº
    participant Contract as Cometåˆçº¦
    participant Storage as å­˜å‚¨å±‚
    participant Math as è®¡ç®—æ¨¡å—

    Note over Anyone,Math: === è‡ªåŠ¨è§¦å‘ç´¯ç§¯ï¼ˆæ¯æ¬¡æ“ä½œå‰ï¼‰===
    
    Anyone->>Contract: supply/withdraw/transferç­‰ä»»ä½•æ“ä½œ
    activate Contract
    
    Contract->>Contract: accrueInternal()
    activate Contract
    
    Contract->>Storage: è¯»å– lastAccrualTime
    Storage-->>Contract: ä¸Šæ¬¡ç´¯ç§¯æ—¶é—´
    
    Contract->>Contract: è®¡ç®—æ—¶é—´å·®
    Note over Contract: timeElapsed = now - lastAccrualTime
    
    alt æœ‰æ—¶é—´ç»è¿‡
        Contract->>Storage: è¯»å– totalSupplyBase, totalBorrowBase
        
        Contract->>Math: getUtilization()
        Note over Math: utilization = totalBorrow / totalSupply
        Math-->>Contract: åˆ©ç”¨ç‡
        
        Contract->>Math: getSupplyRate(utilization)
        activate Math
        alt utilization <= supplyKink
            Math->>Math: base + slopeLow Ã— utilization
        else utilization > supplyKink
            Math->>Math: base + slopeLow Ã— kink + slopeHigh Ã— (util - kink)
        end
        Math-->>Contract: supplyRate (æ¯ç§’)
        deactivate Math
        
        Contract->>Math: getBorrowRate(utilization)
        Math-->>Contract: borrowRate (æ¯ç§’)
        
        Contract->>Contract: æ›´æ–°æŒ‡æ•°
        Note over Contract: supplyIndex += supplyIndex Ã— supplyRate Ã— time<br/>borrowIndex += borrowIndex Ã— borrowRate Ã— time
        
        Contract->>Storage: ä¿å­˜æ–°æŒ‡æ•°
        Contract->>Storage: lastAccrualTime = now
        
        alt totalSupplyBase >= baseMinForRewards
            Contract->>Contract: æ›´æ–° trackingSupplyIndex
            Note over Contract: trackingIndex += speed Ã— time / totalSupply
            Contract->>Storage: ä¿å­˜ trackingSupplyIndex
        end
        
        alt totalBorrowBase >= baseMinForRewards
            Contract->>Contract: æ›´æ–° trackingBorrowIndex
            Contract->>Storage: ä¿å­˜ trackingBorrowIndex
        end
    end
    
    deactivate Contract
    
    Note over Anyone,Math: === ç”¨æˆ·æ“ä½œè§¦å‘ä¸ªäººå¥–åŠ±æ›´æ–° ===
    
    Contract->>Storage: è¯»å–ç”¨æˆ·æ•°æ®
    Storage-->>Contract: principal, baseTrackingIndex, baseTrackingAccrued
    
    Contract->>Contract: updateBasePrincipal()
    activate Contract
    
    alt principal >= 0 (ä¾›åº”è€…)
        Contract->>Contract: è®¡ç®—ä¾›åº”å¥–åŠ±
        Note over Contract: indexDelta = trackingSupplyIndex - user.trackingIndex<br/>reward = principal Ã— indexDelta / trackingIndexScale
        
        Contract->>Contract: user.baseTrackingAccrued += reward
        Contract->>Contract: user.baseTrackingIndex = trackingSupplyIndex
        
    else principal < 0 (å€Ÿæ¬¾è€…)
        Contract->>Contract: è®¡ç®—å€Ÿè´·å¥–åŠ±
        Note over Contract: indexDelta = trackingBorrowIndex - user.trackingIndex<br/>reward = |principal| Ã— indexDelta / trackingIndexScale
        
        Contract->>Contract: user.baseTrackingAccrued += reward
        Contract->>Contract: user.baseTrackingIndex = trackingBorrowIndex
    end
    
    Contract->>Storage: ä¿å­˜æ›´æ–°åçš„ç”¨æˆ·æ•°æ®
    deactivate Contract
    
    Contract->>Contract: ç»§ç»­æ‰§è¡ŒåŸæ“ä½œ...
    deactivate Contract
```

---

## å››ã€æ¸…ç®—æµç¨‹

### 4.1 æ¸…ç®—è§¦å‘æ¡ä»¶

#### æ¸…ç®—åˆ¤æ–­

ç”¨æˆ·å¯è¢«æ¸…ç®—å½“ä¸”ä»…å½“ï¼š

```
æŠµæŠ¼å“ä»·å€¼ Ã— liquidateCollateralFactor < å€ºåŠ¡ä»·å€¼
```

å…¶ä¸­ï¼š

- `borrowCollateralFactor < liquidateCollateralFactor`
- é€šå¸¸ï¼š`borrowCF = 0.80`, `liquidateCF = 0.85`
- è¿™ 5% çš„å·®è·æ˜¯å®‰å…¨ç¼“å†²åŒº

#### æ¸…ç®—æ£€æŸ¥æµç¨‹å›¾

```
isLiquidatable(account) å®Œæ•´åˆ¤æ–­æµç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ­¥éª¤ 1: è¯»å–ç”¨æˆ·æœ¬é‡‘
â”œâ”€ int104 principal = userBasic[account].principal;
â”‚
â–¼
æ­¥éª¤ 2: å‰ç½®æ£€æŸ¥ï¼ˆå…³é”®ï¼ï¼‰
â”œâ”€ if (principal >= 0)
â”‚   â”‚
â”‚   â”œâ”€ principal > 0 (ä¾›åº”è€…ï¼Œæœ‰å­˜æ¬¾)
â”‚   â”‚   â””â”€â†’ return false âŒ ä¸èƒ½æ¸…ç®—
â”‚   â”‚
â”‚   â”œâ”€ principal = 0 (é›¶ä½™é¢è´¦æˆ·)
â”‚   â”‚   â””â”€â†’ return false âŒ ä¸èƒ½æ¸…ç®—
â”‚   â”‚
â”‚   â””â”€ principal < 0 (å€Ÿæ¬¾äººï¼Œæœ‰å€ºåŠ¡)
â”‚       â””â”€â†’ ç»§ç»­æ£€æŸ¥ âœ…
â”‚
â–¼
æ­¥éª¤ 3: è®¡ç®—å€ºåŠ¡ä»·å€¼
â”œâ”€ liquidity = signedMulPrice(presentValue(principal), basePrice, baseScale)
â”œâ”€ ç”±äº principal < 0ï¼Œæ‰€ä»¥ liquidity < 0ï¼ˆè´Ÿå€¼è¡¨ç¤ºå€ºåŠ¡ï¼‰
â”‚
â–¼
æ­¥éª¤ 4: éå†æŠµæŠ¼å“ï¼Œç´¯åŠ ä»·å€¼
â”œâ”€ for (i = 0; i < numAssets; i++)
â”‚   â”‚
â”‚   â”œâ”€ if (liquidity >= 0)
â”‚   â”‚   â””â”€â†’ return false âŒ æŠµæŠ¼å……è¶³ï¼Œæå‰é€€å‡º
â”‚   â”‚
â”‚   â””â”€ liquidity += collateralValue Ã— liquidateCollateralFactor
â”‚
â–¼
æ­¥éª¤ 5: æœ€ç»ˆåˆ¤æ–­
â””â”€ return (liquidity < 0)
    â”‚
    â”œâ”€ liquidity < 0 â†’ return true âœ… å¯æ¸…ç®—
    â”‚   æŠµæŠ¼ä¸è¶³ï¼ŒæŠµæŠ¼ä»·å€¼ < å€ºåŠ¡ä»·å€¼
    â”‚
    â””â”€ liquidity >= 0 â†’ return false âŒ ä¸èƒ½æ¸…ç®—
        æŠµæŠ¼å……è¶³ï¼ŒæŠµæŠ¼ä»·å€¼ >= å€ºåŠ¡ä»·å€¼
```

**å…³é”®è¦ç‚¹**ï¼š

1. âš ï¸ **æ­¥éª¤ 2 æ˜¯ç¬¬ä¸€é“é˜²çº¿**ï¼šåªæœ‰å€Ÿæ¬¾äººæ‰èƒ½è¢«æ¸…ç®—
2. ğŸ“Š **æ­¥éª¤ 4 æ˜¯ç¬¬äºŒé“é˜²çº¿**ï¼šæŠµæŠ¼å“ä»·å€¼å¿…é¡»ä½äºå€ºåŠ¡ä»·å€¼
3. ğŸ” **liquidateCollateralFactor > borrowCollateralFactor**ï¼š5% å®‰å…¨ç¼“å†²

#### æ¸…ç®—æ£€æŸ¥ä»£ç 

**æ¸…ç®—åˆ¤æ–­** ([ğŸ“„ Comet.sol:566-601](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L566-L601)):

```solidity
/**
    * @notice æ£€æŸ¥è´¦æˆ·æ˜¯å¦å¯è¢«æ¸…ç®—
    * @dev ä½¿ç”¨ liquidateCollateralFactorï¼ˆè¾ƒé«˜é˜ˆå€¼ï¼‰æ£€æŸ¥
    * @dev liquidateCollateralFactor > borrowCollateralFactorï¼Œæä¾›å®‰å…¨ç¼“å†²
    * 
    * æ¸…ç®—åˆ¤æ–­å…¬å¼ï¼š
    * ===============================================
    * 
    * 0. **å‰ç½®æ£€æŸ¥ï¼ˆå…³é”®ï¼ï¼‰**ï¼š
    *    if (principal >= 0) return false;
    *    
    *    åªæœ‰å€Ÿæ¬¾äººï¼ˆprincipal < 0ï¼‰æ‰å¯èƒ½è¢«æ¸…ç®—
    *    - principal > 0ï¼šä¾›åº”è€…ï¼ˆæœ‰å­˜æ¬¾ï¼‰â†’ ä¸èƒ½æ¸…ç®—
    *    - principal = 0ï¼šé›¶ä½™é¢è´¦æˆ· â†’ ä¸èƒ½æ¸…ç®—
    *    - principal < 0ï¼šå€Ÿæ¬¾äººï¼ˆæœ‰å€ºåŠ¡ï¼‰â†’ ç»§ç»­æ£€æŸ¥
    * 
    * 1. å€ºåŠ¡ä»·å€¼è®¡ç®—ï¼š
    *    debtValue = |presentValue(principal)| Ã— basePrice / baseScale
    *    å…¶ä¸­ï¼š
    *    - presentValue(principal) < 0 ï¼ˆæœ¬é‡‘ä¸ºè´Ÿæ•°è¡¨ç¤ºå€ºåŠ¡ï¼‰
    *    - basePriceï¼šåŸºç¡€èµ„äº§ä»·æ ¼ï¼ˆä¾‹å¦‚ USDC = 1.0ï¼‰
    *    - baseScaleï¼šåŸºç¡€èµ„äº§ç²¾åº¦ç¼©æ”¾ï¼ˆ10^baseDecimalsï¼‰
    * 
    * 2. æŠµæŠ¼å“ä»·å€¼è®¡ç®—ï¼ˆåº”ç”¨æ¸…ç®—å› å­ï¼‰ï¼š
    *    collateralValue = Î£ (collateralBalance_i Ã— collateralPrice_i / collateralScale_i Ã— liquidateCollateralFactor_i)
    *    å¯¹æ‰€æœ‰æŠµæŠ¼å“ iï¼š
    *    - collateralBalance_iï¼šç”¨æˆ·æŠµæŠ¼çš„ç¬¬ i ç§èµ„äº§æ•°é‡
    *    - collateralPrice_iï¼šç¬¬ i ç§èµ„äº§çš„ä»·æ ¼ï¼ˆå¦‚ ETH = $3000ï¼‰
    *    - collateralScale_iï¼šç¬¬ i ç§èµ„äº§çš„ç²¾åº¦ç¼©æ”¾ï¼ˆ10^decimalsï¼‰
    *    - liquidateCollateralFactor_iï¼šæ¸…ç®—æŠµæŠ¼ç‡ï¼ˆå¦‚ 0.85 = 85%ï¼‰
    * 
    * 3. æµåŠ¨æ€§è®¡ç®—ï¼ˆLiquidityï¼‰ï¼š
    *    liquidity = -debtValue + collateralValue
    *              = -|principal| Ã— basePrice / baseScale 
    *                + Î£ (balance_i Ã— price_i / scale_i Ã— liquidateFactor_i)
    * 
    * 4. æ¸…ç®—æ¡ä»¶ï¼š
    *    å¯æ¸…ç®— âŸº liquidity < 0
    *    å³ï¼šcollateralValue < debtValue
    *    å³ï¼šå®é™…æŠµæŠ¼ä»·å€¼ < å€ºåŠ¡ä»·å€¼
    * 
    * æ¸…ç®—é˜ˆå€¼ç¤ºä¾‹ï¼š
    * ===============================================
    * å‡è®¾ï¼š
    * - å€Ÿæ¬¾ï¼š$1000 USDCï¼ˆå€ºåŠ¡ï¼‰
    * - æŠµæŠ¼ï¼š1 ETHï¼Œä»·æ ¼ $3000
    * - liquidateCollateralFactor = 0.85ï¼ˆ85%ï¼‰
    * 
    * è®¡ç®—ï¼š
    * - debtValue = $1000
    * - collateralValue = 1 ETH Ã— $3000 Ã— 0.85 = $2550
    * - liquidity = -$1000 + $2550 = $1550 > 0
    * - ç»“æœï¼šä¸å¯æ¸…ç®—ï¼ˆæŠµæŠ¼å……è¶³ï¼‰
    * 
    * å¦‚æœ ETH ä»·æ ¼è·Œè‡³ $1200ï¼š
    * - collateralValue = 1 ETH Ã— $1200 Ã— 0.85 = $1020
    * - liquidity = -$1000 + $1020 = $20 > 0
    * - ç»“æœï¼šä»ä¸å¯æ¸…ç®—ï¼ˆåˆšå¥½å®‰å…¨ï¼‰
    * 
    * å¦‚æœ ETH ä»·æ ¼è·Œè‡³ $1100ï¼š
    * - collateralValue = 1 ETH Ã— $1100 Ã— 0.85 = $935
    * - liquidity = -$1000 + $935 = -$65 < 0
    * - ç»“æœï¼šå¯æ¸…ç®—ï¼ˆæŠµæŠ¼ä¸è¶³ï¼‰
    * 
    * æ¸…ç®—é˜ˆå€¼ä»·æ ¼ï¼š
    * - liquidationPrice = debtValue / (collateralAmount Ã— liquidateFactor)
    *                    = $1000 / (1 ETH Ã— 0.85)
    *                    = $1176.47
    * 
    * ä¸å€Ÿè´·èƒ½åŠ›çš„å…³ç³»ï¼š
    * ===============================================
    * - borrowCollateralFactor = 0.80 (80%) â†’ å€Ÿè´·èƒ½åŠ›
    * - liquidateCollateralFactor = 0.85 (85%) â†’ æ¸…ç®—é˜ˆå€¼
    * - å·®è· = 5% â†’ å®‰å…¨ç¼“å†²åŒº
    * 
    * è¿™æ„å‘³ç€ï¼š
    * 1. ç”¨æˆ·æœ€å¤šå¯å€Ÿï¼š$3000 Ã— 0.80 = $2400
    * 2. æ¸…ç®—è§¦å‘äºï¼š$3000 Ã— 0.85 = $2550 å€ºåŠ¡æ°´å¹³
    * 3. ä»·æ ¼ä¸‹è·Œåˆ° $2550/$0.85 = $3000 æ—¶è§¦å‘æ¸…ç®—
    * 
    * @param account è¦æ£€æŸ¥çš„è´¦æˆ·åœ°å€
    * @return å¦‚æœå¯è¢«æ¸…ç®—è¿”å› trueï¼Œå¦åˆ™è¿”å› false
    */
function isLiquidatable(address account) override public view returns (bool) {
    // æ­¥éª¤ 1: è¯»å–ç”¨æˆ·æœ¬é‡‘
    int104 principal = userBasic[account].principal;

    // æ­¥éª¤ 2: å¦‚æœæœ¬é‡‘ â‰¥ 0ï¼ˆæ²¡æœ‰å€Ÿè´·ï¼‰ï¼Œåˆ™ä¸èƒ½è¢«æ¸…ç®—
    if (principal >= 0) {
        return false;
    }

    // æ­¥éª¤ 3: åˆå§‹åŒ–æµåŠ¨æ€§ï¼ˆè´Ÿå€¼ï¼Œè¡¨ç¤ºå€ºåŠ¡çš„ç¾å…ƒä»·å€¼ï¼‰
    // å…¬å¼ï¼šliquidity = presentValue(principal) Ã— basePrice / baseScale
    // ç”±äº principal < 0ï¼Œæ‰€ä»¥ liquidity < 0
    uint16 assetsIn = userBasic[account].assetsIn;
    int liquidity = signedMulPrice(
        presentValue(principal),  // è´Ÿå€¼ï¼Œå½“å‰å€ºåŠ¡é‡‘é¢ï¼ˆå·²è€ƒè™‘åˆ©æ¯ç´¯ç§¯ï¼‰
        getPrice(baseTokenPriceFeed),  // åŸºç¡€èµ„äº§ä»·æ ¼ï¼ˆå¦‚ USDC = 1.0ï¼‰
        uint64(baseScale)  // ç¼©æ”¾å› å­ï¼ˆå¦‚ 10^6 for USDCï¼‰
    );  // liquidity < 0ï¼Œè¡¨ç¤ºéœ€è¦æŠµæŠ¼å“æ¥è¦†ç›–çš„å€ºåŠ¡ä»·å€¼ï¼ˆç¾å…ƒï¼‰

    // æ­¥éª¤ 4: éå†ç”¨æˆ·çš„æ‰€æœ‰æŠµæŠ¼èµ„äº§ï¼Œç´¯åŠ æŠµæŠ¼ä»·å€¼
    // å…¬å¼ï¼šliquidity += Î£ (balance_i Ã— price_i / scale_i Ã— liquidateFactor_i)
    for (uint8 i = 0; i < numAssets; ) {
        if (isInAsset(assetsIn, i)) {
            // æå‰é€€å‡ºï¼šå¦‚æœæµåŠ¨æ€§å·²ç» â‰¥ 0ï¼Œè¯´æ˜æŠµæŠ¼å……è¶³ï¼Œä¸èƒ½æ¸…ç®—
            if (liquidity >= 0) {
                return false;
            }

            // 4.1: è·å–è¯¥æŠµæŠ¼èµ„äº§çš„é…ç½®
            AssetInfo memory asset = getAssetInfo(i);
            
            // 4.2: è®¡ç®—æŠµæŠ¼å“çš„ç¾å…ƒä»·å€¼
            // å…¬å¼ï¼šcollateralValue = balance Ã— price / scale
            uint newAmount = mulPrice(
                userCollateral[account][asset.asset].balance,  // æŠµæŠ¼å“æ•°é‡ï¼ˆåŸå§‹å•ä½ï¼‰
                getPrice(asset.priceFeed),  // æŠµæŠ¼å“ä»·æ ¼ï¼ˆç¾å…ƒï¼Œå¦‚ ETH = $3000ï¼‰
                asset.scale  // ç¼©æ”¾å› å­ï¼ˆ10^decimalsï¼‰
            );  // ç»“æœï¼šæŠµæŠ¼å“çš„ç¾å…ƒä»·å€¼ï¼ˆæ— å› å­è°ƒæ•´ï¼‰
            
            // 4.3: åº”ç”¨æ¸…ç®—æŠµæŠ¼ç‡ï¼Œç´¯åŠ åˆ°æµåŠ¨æ€§
            // å…¬å¼ï¼šadjustedValue = collateralValue Ã— liquidateCollateralFactor
            // liquidateCollateralFactor é€šå¸¸ä¸º 0.85-0.95ï¼ˆ85%-95%ï¼‰
            // æ¯” borrowCollateralFactor é«˜ 5-10%ï¼Œæä¾›å®‰å…¨ç¼“å†²åŒº
            // ä¾‹å¦‚ï¼š
            //   - $100 çš„ ETH Ã— 0.85 = $85 çš„æ¸…ç®—é˜ˆå€¼
            //   - å½“å€ºåŠ¡è¾¾åˆ° $85 æ—¶è§¦å‘æ¸…ç®—
            //   - è€Œå€Ÿè´·èƒ½åŠ›åªæœ‰ $80ï¼ˆborrowCollateralFactor = 0.80ï¼‰
            liquidity += signed256(mulFactor(
                newAmount,
                asset.liquidateCollateralFactor
            ));
        }
        unchecked { i++; }
    }

    // æ­¥éª¤ 5: è¿”å›æµåŠ¨æ€§æ˜¯å¦ < 0
    // liquidity < 0 è¡¨ç¤º adjustedCollateralValue < debtValueï¼Œå¯ä»¥æ¸…ç®—
    // æ³¨æ„ï¼šè¿™é‡Œä¸ isBorrowCollateralized çš„è¿”å›å€¼ç›¸å
    //   - isBorrowCollateralized: liquidity >= 0 â†’ true (å¯å€Ÿè´·)
    //   - isLiquidatable: liquidity < 0 â†’ true (å¯æ¸…ç®—)
    return liquidity < 0;
}
```

### 4.2 æ¸…ç®—æ‰§è¡Œæµç¨‹

#### Absorb æœºåˆ¶

Comet ä½¿ç”¨**åè®®å¸æ”¶**æ¨¡å¼ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„æ¸…ç®—äººå¿è¿˜æ¨¡å¼ï¼š

1. æ¸…ç®—äººè°ƒç”¨ `absorb()`
2. åè®®å¸æ”¶è´¦æˆ·çš„æ‰€æœ‰æŠµæŠ¼å“å’Œå€ºåŠ¡
3. æŠµæŠ¼å“è¿›å…¥åè®®å‚¨å¤‡
4. æ¸…ç®—äººç¨åå¯ä»¥æŠ˜ä»·è´­ä¹°è¿™äº›æŠµæŠ¼å“

#### æ¸…ç®—æ ¸å¿ƒä»£ç 

**æ¸…ç®—å…¥å£** ([ğŸ“„ Comet.sol:1158-1178](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L1158-L1178)):

```solidity
function absorb(address absorber, address[] calldata accounts) override external {
    if (isAbsorbPaused()) revert Paused();

    uint startGas = gasleft();
    
    // å…ˆç´¯ç§¯åˆ©æ¯
    accrueInternal();
    
    // æ‰¹é‡æ¸…ç®—å¤šä¸ªè´¦æˆ·
    for (uint i = 0; i < accounts.length; ) {
        absorbInternal(absorber, accounts[i]);
        unchecked { i++; }
    }
    
    uint gasUsed = startGas - gasleft();

    // è®°å½•æ¸…ç®—äººç§¯åˆ†ï¼ˆç”¨äºæ¿€åŠ±ï¼‰
    LiquidatorPoints memory points = liquidatorPoints[absorber];
    points.numAbsorbs++;
    points.numAbsorbed += safe64(accounts.length);
    points.approxSpend += safe128(gasUsed * block.basefee);
    liquidatorPoints[absorber] = points;
}
```

**æ¸…ç®—å•ä¸ªè´¦æˆ·** ([ğŸ“„ Comet.sol:1183-1238](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L1183-L1238)):

```solidity
function absorbInternal(address absorber, address account) internal {
    if (!isLiquidatable(account)) revert NotLiquidatable();

    UserBasic memory accountUser = userBasic[account];
    int104 oldPrincipal = accountUser.principal;
    int256 oldBalance = presentValue(oldPrincipal);
    uint16 assetsIn = accountUser.assetsIn;

    uint256 basePrice = getPrice(baseTokenPriceFeed);
    uint256 deltaValue = 0;

    // 1. å¸æ”¶æ‰€æœ‰æŠµæŠ¼å“
    for (uint8 i = 0; i < numAssets; ) {
        if (isInAsset(assetsIn, i)) {
            AssetInfo memory assetInfo = getAssetInfo(i);
            address asset = assetInfo.asset;
            
            // æ¸…ç©ºç”¨æˆ·æŠµæŠ¼å“
            uint128 seizeAmount = userCollateral[account][asset].balance;
            userCollateral[account][asset].balance = 0;
            totalsCollateral[asset].totalSupplyAsset -= seizeAmount;

            // è®¡ç®—æŠµæŠ¼å“ä»·å€¼ï¼ˆåº”ç”¨æ¸…ç®—å› å­ï¼‰
            uint256 value = mulPrice(seizeAmount, getPrice(assetInfo.priceFeed), assetInfo.scale);
            deltaValue += mulFactor(value, assetInfo.liquidationFactor);

            emit AbsorbCollateral(absorber, account, asset, seizeAmount, value);
        }
        unchecked { i++; }
    }

    // 2. å°†æŠµæŠ¼å“ä»·å€¼è½¬æ¢ä¸ºåŸºç¡€èµ„äº§æ•°é‡
    uint256 deltaBalance = divPrice(deltaValue, basePrice, uint64(baseScale));
    int256 newBalance = oldBalance + signed256(deltaBalance);
    
    // å¦‚æœæŠµæŠ¼å“ä¸è¶³ä»¥è¦†ç›–å€ºåŠ¡ï¼Œå‰©ä½™ç”±åè®®å‚¨å¤‡å¸æ”¶
    if (newBalance < 0) {
        newBalance = 0;
    }

    // 3. æ›´æ–°ç”¨æˆ·çŠ¶æ€
    int104 newPrincipal = principalValue(newBalance);
    updateBasePrincipal(account, accountUser, newPrincipal);

    // æ¸…ç©ºç”¨æˆ·çš„èµ„äº§æ ‡å¿—
    userBasic[account].assetsIn = 0;

    // 4. æ›´æ–°å…¨å±€çŠ¶æ€
    (uint104 repayAmount, uint104 supplyAmount) = repayAndSupplyAmount(oldPrincipal, newPrincipal);
    
    // åè®®å‚¨å¤‡å‡å°‘ï¼ˆå› ä¸ºç”¨æŠµæŠ¼å“å¿è¿˜äº†å€ºåŠ¡ï¼‰
    totalSupplyBase += supplyAmount;
    totalBorrowBase -= repayAmount;

    emit AbsorbDebt(absorber, account, basePaidOut, deltaValue);
}
```

### 4.3 è´­ä¹°æŠµæŠ¼å“

#### è´­ä¹°æœºåˆ¶

æ¸…ç®—åï¼ŒæŠµæŠ¼å“è¿›å…¥åè®®å‚¨å¤‡ï¼Œä»»ä½•äººå¯ä»¥æŠ˜ä»·è´­ä¹°ï¼š

- è´­ä¹°ä»·æ ¼ = é¢„è¨€æœºä»·æ ¼ Ã— `storeFrontPriceFactor`
- `storeFrontPriceFactor` é€šå¸¸ä¸º 0.93 (7% æŠ˜æ‰£)
- åªèƒ½ç”¨åŸºç¡€èµ„äº§ï¼ˆUSDCï¼‰è´­ä¹°
- å¿…é¡»æ»¡è¶³ `å‚¨å¤‡é‡‘ > targetReserves` æ‰èƒ½è´­ä¹°

#### è´­ä¹°ä»£ç 

**è´­ä¹°å…¥å£** ([ğŸ“„ Comet.sol:1260-1261](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L1260-L1261)):

```solidity
function buyCollateral(address asset, uint minAmount, uint baseAmount, address recipient) 
    override external {
    if (isBuyPaused()) revert Paused();

    // è®¡ç®—å¯è´­ä¹°çš„æŠµæŠ¼å“æ•°é‡
    uint collateralAmount = quoteCollateral(asset, baseAmount);
    
    // æ»‘ç‚¹ä¿æŠ¤
    if (collateralAmount < minAmount) {
        revert TooMuchSlippage();
    }
    
    // æ£€æŸ¥æŠµæŠ¼å“å‚¨å¤‡
    if (collateralAmount > getCollateralReserves(asset)) {
        revert NotForSale();
    }

    // è½¬å…¥åŸºç¡€èµ„äº§
    doTransferIn(baseToken, msg.sender, baseAmount);

    // è½¬å‡ºæŠµæŠ¼å“
    doTransferOut(asset, recipient, collateralAmount);

    emit BuyCollateral(msg.sender, asset, baseAmount, collateralAmount);
}
```

**ä»·æ ¼è®¡ç®—** ([ğŸ“„ Comet.sol:1240-1258](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L1240-L1258)):

```solidity
function quoteCollateral(address asset, uint baseAmount) override public view returns (uint) {
    AssetInfo memory assetInfo = getAssetInfoByAddress(asset);
    
    // è·å–ä»·æ ¼
    uint256 assetPrice = getPrice(assetInfo.priceFeed);
    uint256 basePrice = getPrice(baseTokenPriceFeed);

    // æ£€æŸ¥å‚¨å¤‡
    uint256 reserves = getReserves();
    if (reserves < 0 || uint(reserves) < targetReserves) {
        revert NotForSale();
    }

    // è®¡ç®—æŠµæŠ¼å“æ•°é‡ï¼ˆåº”ç”¨æŠ˜æ‰£ï¼‰
    return divPrice(
        mulFactor(mulPrice(baseAmount, basePrice, uint64(baseScale)), storeFrontPriceFactor),
        assetPrice,
        assetInfo.scale
    );
}
```

### 4.4 æ¸…ç®—ç¤ºä¾‹åœºæ™¯

#### æ‰¹é‡æ¸…ç®—æœºåˆ¶è¯´æ˜

âš ï¸ **é‡è¦**ï¼š`absorb` å‡½æ•°æ”¯æŒæ‰¹é‡æ¸…ç®—ï¼Œå…·æœ‰**åŒå±‚å¾ªç¯ç»“æ„**ï¼š

```solidity
function absorb(address absorber, address[] calldata accounts) {
    // å¤–å±‚å¾ªç¯ï¼šéå†è¦æ¸…ç®—çš„è´¦æˆ·åˆ—è¡¨
    for (uint i = 0; i < accounts.length; ) {
        absorbInternal(absorber, accounts[i]);
        
        // å†…å±‚å¾ªç¯ï¼ˆåœ¨ absorbInternal ä¸­ï¼‰ï¼šéå†æ¯ä¸ªè´¦æˆ·çš„æŠµæŠ¼å“
        for (uint8 j = 0; j < numAssets; ) {
            // æ²¡æ”¶è¯¥è´¦æˆ·çš„æ¯ä¸ªæŠµæŠ¼å“
            ...
        }
    }
    // è®°å½•æ¸…ç®—ç§¯åˆ†ï¼ˆæ‰¹é‡æ“ä½œçš„æ€» Gas æ¶ˆè€—ï¼‰
}
```

**æ‰¹é‡æ¸…ç®—ä¼˜åŠ¿**ï¼š

- âœ… Gas æ•ˆç‡æ›´é«˜ï¼ˆå•æ¬¡äº¤æ˜“æ¸…ç®—å¤šä¸ªè´¦æˆ·ï¼‰
- âœ… å‡å°‘åŒºå—ç©ºé—´å ç”¨
- âœ… æé«˜æ¸…ç®—å“åº”é€Ÿåº¦
- âœ… é™ä½æ¸…ç®—è€…çš„äº¤æ˜“æˆæœ¬

**ç¤ºä¾‹**ï¼š

- å•è´¦æˆ·æ¸…ç®—ï¼š`absorb(liquidator, [alice])`
- æ‰¹é‡æ¸…ç®—ï¼š`absorb(liquidator, [alice, bob, carol])` â† ä¸€æ¬¡æ¸…ç®— 3 ä¸ªè´¦æˆ·

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤º**å•ä¸ªè´¦æˆ·**çš„æ¸…ç®—è¿‡ç¨‹ï¼š

#### åœºæ™¯å‚æ•°

```
ç”¨æˆ·è´¦æˆ·ï¼š
- å€ºåŠ¡ï¼š10,000 USDC
- æŠµæŠ¼å“ï¼š5 ETH @ $2,100 = $10,500

ä»·æ ¼å˜åŠ¨ï¼š
- ETH ä»·æ ¼è·Œè‡³ $2,000
- æ–°æŠµæŠ¼å“ä»·å€¼ = 5 Ã— $2,000 = $10,000

æŠµæŠ¼ç‡é…ç½®ï¼š
- borrowCollateralFactor = 0.80 (80%)
- liquidateCollateralFactor = 0.85 (85%)
- liquidationFactor = 0.95 (95%, 5%æƒ©ç½š)
- storeFrontPriceFactor = 0.93 (7% æŠ˜æ‰£)
```

#### æ¸…ç®—åˆ¤æ–­

**æ­¥éª¤ 1: æ£€æŸ¥æ˜¯å¦æœ‰å€Ÿè´·**

```
principal = -10,000 USDC (è´Ÿå€¼è¡¨ç¤ºå€ºåŠ¡)

æ£€æŸ¥: principal >= 0?
âŒ å¦ï¼ˆprincipal = -10,000 < 0ï¼‰
â†’ ç»§ç»­æ¸…ç®—åˆ¤æ–­æµç¨‹

æ³¨æ„ï¼š
- å¦‚æœ principal >= 0ï¼ˆä¾›åº”è€…æˆ–é›¶ä½™é¢ï¼‰ï¼Œç›´æ¥è¿”å› falseï¼ˆä¸èƒ½æ¸…ç®—ï¼‰
- åªæœ‰å€Ÿæ¬¾äººï¼ˆprincipal < 0ï¼‰æ‰å¯èƒ½è¢«æ¸…ç®—
```

**æ­¥éª¤ 2-5: è®¡ç®—æŠµæŠ¼ç‡å’ŒæµåŠ¨æ€§**

```
å€Ÿè´·èƒ½åŠ› = $10,000 Ã— 0.80 = $8,000
æ¸…ç®—é˜ˆå€¼ = $10,000 Ã— 0.85 = $8,500
å½“å‰å€ºåŠ¡ = $10,000

æ£€æŸ¥: æ¸…ç®—é˜ˆå€¼ < å€ºåŠ¡?
âœ… æ˜¯ï¼ˆ$8,500 < $10,000ï¼‰
â†’ å¯è¢«æ¸…ç®— âœ…
```

#### æ¸…ç®—æ‰§è¡Œ

```
æ­¥éª¤ 1-4: å¸æ”¶æŠµæŠ¼å“
   - æ²¡æ”¶ç”¨æˆ·çš„ 5 ETHï¼ˆå…¨éƒ¨ä½™é¢æ¸…é›¶ï¼‰
   - æŠµæŠ¼å“åŸå§‹ä»·å€¼ = 5 ETH Ã— $2,000 = $10,000
   - åº”ç”¨ liquidationFactor(0.95)ï¼šdeltaValue = $10,000 Ã— 0.95 = $9,500
   - totalsCollateral[ETH].totalSupplyAsset -= 5 ETH

æ­¥éª¤ 5-6: è®¡ç®—æ–°ä½™é¢
   - oldBalance = presentValue(-10,000) = -10,000 USDC
   - deltaBalance = $9,500 / $1.00 = 9,500 USDC
   - newBalance = -10,000 + 9,500 = -500 USDC
   - ç”±äº newBalance < 0ï¼Œåè®®å¸æ”¶åè´¦ï¼Œè®¾ä¸º 0

æ­¥éª¤ 7-8: æ›´æ–°ç”¨æˆ·çŠ¶æ€
   - newPrincipal = principalValue(0) = 0
   - updateBasePrincipal(user, 0) - æ›´æ–°ç”¨æˆ·æœ¬é‡‘
   - userBasic[user].assetsIn = 0 - æ¸…ç©ºæ‰€æœ‰æŠµæŠ¼å“æ ‡å¿—

æ­¥éª¤ 9-10: æ›´æ–°å…¨å±€æ€»é‡
   - (repayAmount, supplyAmount) = repayAndSupplyAmount(-10,000, 0)
   - repayAmount = 10,000, supplyAmount = 0
   - totalBorrowBase -= 10,000ï¼ˆå€ºåŠ¡æ¸…é›¶ï¼‰
   - totalSupplyBase += 0ï¼ˆæ— æ–°å¢ä¾›åº”ï¼‰

æ­¥éª¤ 11: è§¦å‘äº‹ä»¶
   - basePaidOut = 0 - (-10,000) = 10,000 USDC
   - valueOfBasePaidOut = 10,000 Ã— $1.00 = $10,000
   - emit AbsorbDebt(absorber, user, 10,000, $10,000)

åè®®æœ€ç»ˆçŠ¶æ€ï¼š
   - è·å¾—ï¼š5 ETHï¼ˆåè®®å‚¨å¤‡ï¼‰
   - æ”¯ä»˜ï¼š10,000 USDCï¼ˆæŠµæŠ¼å“ä»·å€¼ $9,500 + åè´¦ $500ï¼‰
   - å®é™…åè´¦ï¼š$500ï¼ˆç”±åè®®å‚¨å¤‡é‡‘æ‰¿æ‹…ï¼‰
```

#### è´­ä¹°æŠµæŠ¼å“

```
æ¸…ç®—äººè´­ä¹°ï¼š
- æ”¯ä»˜ï¼š9,500 USDCï¼ˆæƒ³ä¹°å…¨éƒ¨ï¼‰
- æŠ˜æ‰£ä»·æ ¼ï¼š$2,000 Ã— 0.93 = $1,860 / ETH
- è·å¾—ï¼š9,500 / 1,860 â‰ˆ 5.11 ETHï¼ˆä½†åªæœ‰ 5 ETHï¼‰
- å®é™…ï¼šæ”¯ä»˜ 5 Ã— 1,860 = 9,300 USDCï¼Œè·å¾— 5 ETH

æ¸…ç®—äººåˆ©æ¶¦ï¼š
- å¸‚åœºä»·å€¼ï¼š5 Ã— $2,000 = $10,000
- è´­ä¹°æˆæœ¬ï¼š$9,300
- å³æ—¶åˆ©æ¶¦ï¼š$10,000 - $9,300 = $700
```

### 4.5 æ¸…ç®—å®Œæ•´æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor Liquidator as æ¸…ç®—äºº
    actor User as è¢«æ¸…ç®—ç”¨æˆ·
    participant Contract as Cometåˆçº¦
    participant PriceFeed as ä»·æ ¼é¢„è¨€æœº
    participant Storage as å­˜å‚¨å±‚
    participant Token as ä»£å¸åˆçº¦

    Note over Liquidator,Token: === é˜¶æ®µ1ï¼šç›‘æ§å’Œè§¦å‘ ===
    
    Liquidator->>Contract: isLiquidatable(user)
    activate Contract
    
    Contract->>Storage: æ­¥éª¤ 1: è¯»å– principal = userBasic[account].principal
    Storage-->>Contract: principal = -10,000 USDC (å€ºåŠ¡)
    
    Contract->>Contract: æ­¥éª¤ 2: æ£€æŸ¥æ˜¯å¦æœ‰å€Ÿè´·
    Note over Contract: if (principal >= 0)
    
    alt principal >= 0 (æ— å€ºåŠ¡æˆ–æœ‰å­˜æ¬¾)
        Contract-->>Liquidator: æ­¥éª¤ 2a: return false (ä¸èƒ½æ¸…ç®—)
        Note over Contract: åªæœ‰å€Ÿæ¬¾äººæ‰èƒ½è¢«æ¸…ç®—<br/>ä¾›åº”è€…å’Œé›¶ä½™é¢è´¦æˆ·ä¸èƒ½è¢«æ¸…ç®—
        deactivate Contract
    else principal < 0 (æœ‰å€ºåŠ¡)
        Note over Contract: æ­¥éª¤ 2b: ç»§ç»­æ¸…ç®—åˆ¤æ–­æµç¨‹
        
        Note over Contract: === æ­¥éª¤ 3: åˆå§‹åŒ–æµåŠ¨æ€§ï¼ˆè´Ÿå€¼ï¼‰===
        
        Contract->>Storage: è¯»å– assetsIn = userBasic[account].assetsIn
        Storage-->>Contract: assetsIn = 0b0001 (æŒæœ‰èµ„äº§0)
        
        Contract->>PriceFeed: getPrice(baseTokenPriceFeed)
        PriceFeed-->>Contract: USDC price = $1.00
        
        Contract->>Contract: è®¡ç®—åˆå§‹æµåŠ¨æ€§ï¼ˆè´Ÿå€¼ï¼‰
        Note over Contract: liquidity = signedMulPrice(<br/>presentValue(principal),<br/>basePrice, baseScale)<br/>= -10,000 Ã— $1.00 = -$10,000
        
        Note over Contract: === æ­¥éª¤ 4: éå†æŠµæŠ¼å“ï¼Œç´¯åŠ ä»·å€¼ ===
        
        loop éå†ç”¨æˆ·çš„æ‰€æœ‰æŠµæŠ¼èµ„äº§ (i = 0 to numAssets)
            
            Contract->>Contract: æ£€æŸ¥: isInAsset(assetsIn, i)?
            Note over Contract: æ£€æŸ¥è¯¥èµ„äº§æ˜¯å¦åœ¨ç”¨æˆ·çš„æŠµæŠ¼åˆ—è¡¨ä¸­
            
            Contract->>Contract: æå‰é€€å‡ºæ£€æŸ¥
            Note over Contract: if (liquidity >= 0)<br/>return false
            
            Note over Contract: å¦‚æœ liquidity >= 0ï¼Œæå‰è¿”å› false<br/>ï¼ˆæœ¬ä¾‹ä¸­ç»§ç»­å¤„ç†ï¼‰
            
            Contract->>Contract: æ­¥éª¤ 4.1: è·å–èµ„äº§é…ç½®
            Note over Contract: AssetInfo asset = getAssetInfo(i)
            
            Contract->>Storage: æ­¥éª¤ 4.2: è¯»å–æŠµæŠ¼å“ä½™é¢
            Storage-->>Contract: userCollateral[account][ETH].balance = 5 ETH
            
            Contract->>PriceFeed: æ­¥éª¤ 4.2: è·å–æŠµæŠ¼å“ä»·æ ¼
            PriceFeed-->>Contract: getPrice(asset.priceFeed) = $2,000
            
            Contract->>Contract: æ­¥éª¤ 4.2: è®¡ç®—æŠµæŠ¼å“åŸå§‹ä»·å€¼
            Note over Contract: newAmount = mulPrice(<br/>balance, price, scale)<br/>= 5 ETH Ã— $2,000 = $10,000
            
            Contract->>Contract: æ­¥éª¤ 4.3: åº”ç”¨æ¸…ç®—å› å­å¹¶ç´¯åŠ 
            Note over Contract: liquidity += signed256(<br/>mulFactor(newAmount,<br/>liquidateCollateralFactor))<br/><br/>liquidity = -$10,000 + ($10,000 Ã— 0.85)<br/>= -$10,000 + $8,500<br/>= -$1,500
            
        end
        
        Note over Contract: === æ­¥éª¤ 5: æœ€ç»ˆåˆ¤æ–­ ===
        
        Contract->>Contract: è¿”å› liquidity < 0
        Note over Contract: liquidity = -$1,500 less than 0?<br/>âœ… æ˜¯
        
        Contract-->>Liquidator: return true (å¯æ¸…ç®—)
        Note over Contract: æŠµæŠ¼ä¸è¶³ï¼Œå¯ä»¥è¢«æ¸…ç®—
        deactivate Contract
    end
    
    Note over Liquidator,Token: === é˜¶æ®µ2ï¼šæ‰§è¡Œæ¸…ç®— ===
    
    Liquidator->>Contract: absorb(liquidator, [user])
    activate Contract
    
    Contract->>Contract: æ£€æŸ¥æ˜¯å¦æš‚åœ: isAbsorbPaused()
    
    Contract->>Contract: startGas = gasleft()
    Note over Contract: è®°å½•èµ·å§‹ Gas
    
    Contract->>Contract: accrueInternal()
    Note over Contract: æ›´æ–°åˆ©æ¯æŒ‡æ•°
    
    Note over Contract: === æ‰¹é‡æ¸…ç®—å¾ªç¯ ===
    
    loop éå†æ¯ä¸ªè¦æ¸…ç®—çš„è´¦æˆ· (accountsæ•°ç»„)
        
        Contract->>Contract: absorbInternal(liquidator, accounts[i])
        activate Contract
        
        Note over Contract: === æ­¥éª¤ 1: éªŒè¯å¯æ¸…ç®— ===
        
        Contract->>Contract: isLiquidatable(accounts[i])
        Note over Contract: å†æ¬¡éªŒè¯è¯¥è´¦æˆ·æ˜¯å¦å¯æ¸…ç®—
        
        Note over Contract: === æ­¥éª¤ 2-3: è¯»å–è´¦æˆ·çŠ¶æ€å’Œä»·æ ¼ ===
        
        Contract->>Storage: è¯»å–ç”¨æˆ·åŸºç¡€æ•°æ®
        Storage-->>Contract: oldPrincipal=-10,000, assetsIn=0b0001
        
        Contract->>Contract: oldBalance = presentValue(oldPrincipal)
        Note over Contract: oldBalance = -10,000 USDC
        
        Contract->>PriceFeed: getPrice(baseTokenPriceFeed)
        PriceFeed-->>Contract: basePrice = $1.00
        
        Contract->>Contract: deltaValue = 0
        Note over Contract: åˆå§‹åŒ–ç´¯ç§¯ä»·å€¼
        
        Note over Contract: === æ­¥éª¤ 4: å¸æ”¶æŠµæŠ¼å“ ===
        
        loop éå†è¯¥è´¦æˆ·çš„æ¯ä¸ªæŠµæŠ¼å“
            
            Contract->>Contract: æ£€æŸ¥: isInAsset(assetsIn, i)?
            
            Contract->>Storage: seizeAmount = userCollateral[user][ETH].balance
            Storage-->>Contract: 5 ETH
            
            Contract->>Storage: userCollateral[user][ETH].balance = 0
            Note over Contract: æ¸…ç©ºç”¨æˆ·æŠµæŠ¼å“ä½™é¢
            
            Contract->>Storage: totalsCollateral[ETH].totalSupplyAsset -= 5
            Note over Contract: ä»æ€»ä¾›åº”ä¸­æ‰£é™¤
            
            Contract->>PriceFeed: getPrice(assetInfo.priceFeed)
            PriceFeed-->>Contract: ETH price = $2,000
            
            Contract->>Contract: è®¡ç®—æŠµæŠ¼å“ä»·å€¼
            Note over Contract: value = 5 Ã— $2,000 = $10,000<br/>deltaValue += $10,000 Ã— liquidationFactor(0.95)<br/>deltaValue = $9,500
            
            Contract->>Liquidator: emit AbsorbCollateral(liquidator, user, ETH, 5, $10,000)
            
        end
        
        Note over Contract: === æ­¥éª¤ 5-6: è®¡ç®—æ–°ä½™é¢ ===
        
        Contract->>Contract: è½¬æ¢ä¸ºåŸºç¡€èµ„äº§é‡‘é¢
        Note over Contract: deltaBalance = $9,500 / $1.00 = 9,500 USDC
        
        Contract->>Contract: è®¡ç®—æ–°ä½™é¢
        Note over Contract: newBalance = oldBalance + deltaBalance<br/>= -10,000 + 9,500 = -500 USDC
        
        Contract->>Contract: å¤„ç†åè´¦
        Note over Contract: if (newBalance less than 0) newBalance = 0<br/>åè®®å¸æ”¶ $500 åè´¦
        
        Note over Contract: === æ­¥éª¤ 7-8: æ›´æ–°ç”¨æˆ·çŠ¶æ€ ===
        
        Contract->>Contract: è®¡ç®—æ–°æœ¬é‡‘
        Note over Contract: newPrincipal = principalValue(0) = 0
        
        Contract->>Storage: updateBasePrincipal(user, newPrincipal)
        Note over Contract: æ›´æ–°ç”¨æˆ·æœ¬é‡‘å’Œå¥–åŠ±è¿½è¸ª
        
        Contract->>Storage: userBasic[user].assetsIn = 0
        Note over Contract: æ¸…ç©ºæ‰€æœ‰æŠµæŠ¼å“æ ‡å¿—<br/>ï¼ˆç”¨æˆ·ä¸å†æŒæœ‰ä»»ä½•èµ„äº§ï¼‰
        
        Note over Contract: === æ­¥éª¤ 9-10: æ›´æ–°å…¨å±€æ€»é‡ ===
        
        Contract->>Contract: åˆ†è§£è¿˜æ¬¾å’Œä¾›åº”
        Note over Contract: (repayAmount, supplyAmount)<br/>= repayAndSupplyAmount(-10,000, 0)<br/>repayAmount = 10,000, supplyAmount = 0
        
        Contract->>Storage: totalSupplyBase += 0
        Contract->>Storage: totalBorrowBase -= 10,000
        Note over Contract: å€ºåŠ¡å‡å°‘ 10,000 USDC<br/>åè®®å‚¨å¤‡é‡‘æ‰¿æ‹… $500 åè´¦
        
        Note over Contract: === æ­¥éª¤ 11: è§¦å‘å€ºåŠ¡äº‹ä»¶ ===
        
        Contract->>Contract: è®¡ç®—åè®®æ”¯ä»˜é‡‘é¢
        Note over Contract: basePaidOut = 0 - (-10,000) = 10,000<br/>valueOfBasePaidOut = 10,000 Ã— $1.00 = $10,000
        
        Contract->>Liquidator: emit AbsorbDebt(liquidator, user, 10,000, $10,000)
        
        Note over Contract: === æ­¥éª¤ 12: æ£€æŸ¥å‰©ä½™ä½™é¢ ===
        
        Contract->>Contract: if (newPrincipal > 0)?
        Note over Contract: newPrincipal = 0<br/>ä¸è§¦å‘ Transfer äº‹ä»¶
        
        deactivate Contract
        Note over Contract: absorbInternal å®Œæˆ
        
    end
    
    Note over Contract: === æ‰¹é‡æ¸…ç®—å¾ªç¯ç»“æŸ ===
    
    Note over Contract: === è®°å½•æ¸…ç®—ç§¯åˆ†ï¼ˆæ‰€æœ‰è´¦æˆ·æ¸…ç®—å®Œæˆåï¼‰===
    
    Contract->>Contract: è®¡ç®—æ€» Gas æ¶ˆè€—
    Note over Contract: gasUsed = startGas - gasleft()<br/>ï¼ˆåŒ…å«æ‰€æœ‰è´¦æˆ·çš„ Gasï¼‰
    
    Contract->>Storage: è¯»å– liquidatorPoints[absorber]
    Storage-->>Contract: å½“å‰ç§¯åˆ†è®°å½•
    
    Contract->>Contract: æ›´æ–°ç§¯åˆ†æ•°æ®
    Note over Contract: points.numAbsorbs++<br/>ï¼ˆæ¸…ç®—æ“ä½œæ¬¡æ•° +1ï¼‰<br/><br/>points.numAbsorbed += accounts.length<br/>ï¼ˆæ¸…ç®—è´¦æˆ·æ€»æ•° +Nï¼‰<br/><br/>points.approxSpend += gasUsed Ã— block.basefee<br/>ï¼ˆç´¯ç§¯ Gas èŠ±è´¹ï¼‰
    
    Contract->>Storage: liquidatorPoints[absorber] = points
    Note over Contract: ä¿å­˜æ›´æ–°åçš„ç§¯åˆ†<br/>ç”¨äºæ²»ç†è¯„ä¼°æ¸…ç®—è€…è´¡çŒ®
    
    Contract-->>Liquidator: æ¸…ç®—å®Œæˆ
    deactivate Contract
    
    Note over Liquidator,Token: === é˜¶æ®µ3ï¼šè´­ä¹°æŠµæŠ¼å“ ===
    
    Liquidator->>Contract: quoteCollateral(ETH, 9,300 USDC)
    activate Contract
    
    Contract->>Contract: æ£€æŸ¥å‚¨å¤‡é‡‘
    Note over Contract: reserves greater than targetReserves?
    
    Contract->>PriceFeed: è·å–ä»·æ ¼
    PriceFeed-->>Contract: ETH=$2,000, USDC=$1.00
    
    Contract->>Contract: è®¡ç®—å¯ä¹°æ•°é‡
    Note over Contract: amount = 9,300 Ã— $1.00 Ã— 0.93 / $2,000<br/>= 9,300 Ã— 0.93 / 2,000<br/>â‰ˆ 4.32 ETH
    
    Contract-->>Liquidator: 4.32 ETH
    deactivate Contract
    
    Liquidator->>Contract: buyCollateral(ETH, 4.3, 9300, liquidator)
    activate Contract
    
    Contract->>Contract: å†æ¬¡è®¡ç®—å¹¶éªŒè¯
    Contract->>Contract: æ£€æŸ¥æ»‘ç‚¹: 4.32 >= 4.3? âœ…
    Contract->>Contract: æ£€æŸ¥å‚¨å¤‡: 4.32 <= 5? âœ…
    
    Contract->>Token: transferFrom(liquidator, comet, 9300 USDC)
    activate Token
    Token-->>Contract: è½¬è´¦æˆåŠŸ
    deactivate Token
    
    Contract->>Token: transfer(liquidator, 4.32 ETH)
    activate Token
    Token-->>Contract: è½¬è´¦æˆåŠŸ
    deactivate Token
    
    Contract->>Liquidator: emit BuyCollateral(liquidator, ETH, 9300, 4.32)
    deactivate Contract
    
    Note over Liquidator: æ¸…ç®—äººåˆ©æ¶¦åˆ†æï¼š<br/>è´­ä¹°æˆæœ¬ï¼š$9,300<br/>å¸‚åœºä»·å€¼ï¼š4.32 Ã— $2,000 = $8,640<br/>å®é™…åˆ©æ¶¦ï¼š$8,640 - $9,300 = -$660<br/>ï¼ˆæ­¤ä¾‹ä¸­ç”±äºæŠ˜æ‰£ä¸å¤Ÿï¼Œæ¸…ç®—äººå¯èƒ½äºæŸï¼‰
```

---

---

## äº”ã€è½¬è´¦æµç¨‹

### 5.1 æ ¸å¿ƒæ¦‚å¿µ

Comet å®ç°äº† **ERC20 å…¼å®¹çš„è½¬è´¦åŠŸèƒ½**ï¼Œä½†æœ‰ç‹¬ç‰¹çš„ç‰¹æ€§ï¼š

- è½¬è´¦åŸºç¡€èµ„äº§æ—¶ï¼Œå¯èƒ½è§¦å‘å€Ÿè´·
- è½¬è´¦æŠµæŠ¼å“æ—¶ï¼Œéœ€è¦æ£€æŸ¥æŠµæŠ¼ç‡
- æ”¯æŒ `uint256.max` ä¸€é”®è½¬ç§»å…¨éƒ¨ä½™é¢

**å…³é”®ç‰¹æ€§**ï¼š

- å‘é€æ–¹ä½™é¢ä¸è¶³æ—¶ï¼Œè‡ªåŠ¨è¿›å…¥å€Ÿè´·æ¨¡å¼
- æ¥æ”¶æ–¹æœ‰å€ºåŠ¡æ—¶ï¼Œè½¬è´¦è‡ªåŠ¨è¿˜æ¬¾
- ä¸å…è®¸è‡ªå·±è½¬ç»™è‡ªå·±

### 5.2 è½¬è´¦æ ¸å¿ƒä»£ç 

#### ERC20 æ ‡å‡†è½¬è´¦

**å…¥å£å‡½æ•°** ([ğŸ“„ Comet.sol:933-948](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L933-L948)):

```solidity
// ERC20 æ ‡å‡†è½¬è´¦ï¼ˆåªèƒ½è½¬åŸºç¡€èµ„äº§ï¼‰
function transfer(address dst, uint amount) override external returns (bool) {
    transferInternal(msg.sender, msg.sender, dst, baseToken, amount);
    return true;
}

// ERC20 æ ‡å‡†æˆæƒè½¬è´¦
function transferFrom(address src, address dst, uint amount) override external returns (bool) {
    transferInternal(msg.sender, src, dst, baseToken, amount);
    return true;
}
```

#### é€šç”¨è½¬è´¦æ¥å£

**è½¬è´¦ä»»æ„èµ„äº§** ([ğŸ“„ Comet.sol:956-988](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L956-L988)):

```solidity
// è½¬è´¦ä»»æ„èµ„äº§ï¼ˆåŸºç¡€èµ„äº§æˆ–æŠµæŠ¼å“ï¼‰
function transferAsset(address dst, address asset, uint amount) override external {
    return transferInternal(msg.sender, msg.sender, dst, asset, amount);
}

// ä»£ç†è½¬è´¦
function transferAssetFrom(address src, address dst, address asset, uint amount) override external {
    return transferInternal(msg.sender, src, dst, asset, amount);
}

// å†…éƒ¨è½¬è´¦é€»è¾‘
function transferInternal(address operator, address src, address dst, address asset, uint amount) 
    internal nonReentrant {
    // 1. æ£€æŸ¥æš‚åœçŠ¶æ€
    if (isTransferPaused()) revert Paused();
    
    // 2. æ£€æŸ¥æƒé™
    if (!hasPermission(src, operator)) revert Unauthorized();
    
    // 3. ä¸å…è®¸è‡ªè½¬
    if (src == dst) revert NoSelfTransfer();

    // 4. æ ¹æ®èµ„äº§ç±»å‹åˆ†å‘
    if (asset == baseToken) {
        if (amount == type(uint256).max) {
            amount = balanceOf(src);  // è½¬ç§»å…¨éƒ¨ä½™é¢
        }
        return transferBase(src, dst, amount);
    } else {
        return transferCollateral(src, dst, asset, safe128(amount));
    }
}
```

#### åŸºç¡€èµ„äº§è½¬è´¦ï¼ˆå¯èƒ½è§¦å‘å€Ÿè´·ï¼‰

**æ ¸å¿ƒé€»è¾‘** ([ğŸ“„ Comet.sol:993-1028](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L993-L1028)):

```solidity
function transferBase(address src, address dst, uint256 amount) internal {
    // 1. ç´¯ç§¯åˆ©æ¯
    accrueInternal();

    // 2. è¯»å–åŒæ–¹è´¦æˆ·æ•°æ®
    UserBasic memory srcUser = userBasic[src];
    UserBasic memory dstUser = userBasic[dst];
    
    int104 srcPrincipal = srcUser.principal;
    int104 dstPrincipal = dstUser.principal;

    // 3. è®¡ç®—è½¬è´¦åçš„æ–°ä½™é¢
    int256 srcBalance = presentValue(srcPrincipal) - signed256(amount);  // å‘é€æ–¹å‡å°‘
    int256 dstBalance = presentValue(dstPrincipal) + signed256(amount);  // æ¥æ”¶æ–¹å¢åŠ 
    
    int104 srcPrincipalNew = principalValue(srcBalance);
    int104 dstPrincipalNew = principalValue(dstBalance);

    // 4. åˆ†æå‘é€æ–¹ï¼šå–æ¬¾è¿˜æ˜¯å€Ÿè´·ï¼Ÿ
    (uint104 withdrawAmount, uint104 borrowAmount) = withdrawAndBorrowAmount(srcPrincipal, srcPrincipalNew);
    
    // 5. åˆ†ææ¥æ”¶æ–¹ï¼šè¿˜æ¬¾è¿˜æ˜¯ä¾›åº”ï¼Ÿ
    (uint104 repayAmount, uint104 supplyAmount) = repayAndSupplyAmount(dstPrincipal, dstPrincipalNew);

    // 6. æ›´æ–°å…¨å±€çŠ¶æ€ï¼ˆé¿å…ä¸‹æº¢ï¼‰
    totalSupplyBase = totalSupplyBase + supplyAmount - withdrawAmount;
    totalBorrowBase = totalBorrowBase + borrowAmount - repayAmount;

    // 7. æ›´æ–°åŒæ–¹è´¦æˆ·çŠ¶æ€
    updateBasePrincipal(src, srcUser, srcPrincipalNew);
    updateBasePrincipal(dst, dstUser, dstPrincipalNew);

    // 8. å¦‚æœå‘é€æ–¹è¿›å…¥å€Ÿè´·ï¼Œæ£€æŸ¥æŠµæŠ¼ç‡
    if (srcBalance < 0) {
        if (uint256(-srcBalance) < baseBorrowMin) revert BorrowTooSmall();
        if (!isBorrowCollateralized(src)) revert NotCollateralized();
    }

    // 9. å‘å‡º ERC20 æ ‡å‡†äº‹ä»¶
    if (withdrawAmount > 0) {
        emit Transfer(src, address(0), presentValueSupply(baseSupplyIndex, withdrawAmount));
    }
    if (supplyAmount > 0) {
        emit Transfer(address(0), dst, presentValueSupply(baseSupplyIndex, supplyAmount));
    }
}
```

#### æŠµæŠ¼å“è½¬è´¦

**æ ¸å¿ƒé€»è¾‘** ([ğŸ“„ Comet.sol:1033-1050](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L1033-L1050)):

```solidity
function transferCollateral(address src, address dst, address asset, uint128 amount) internal {
    // 1. è¯»å–åŒæ–¹æŠµæŠ¼å“ä½™é¢
    uint128 srcCollateral = userCollateral[src][asset].balance;
    uint128 dstCollateral = userCollateral[dst][asset].balance;
    
    // 2. è®¡ç®—æ–°ä½™é¢
    uint128 srcCollateralNew = srcCollateral - amount;
    uint128 dstCollateralNew = dstCollateral + amount;

    // 3. æ›´æ–°æŠµæŠ¼å“ä½™é¢
    userCollateral[src][asset].balance = srcCollateralNew;
    userCollateral[dst][asset].balance = dstCollateralNew;

    // 4. è·å–èµ„äº§ä¿¡æ¯å¹¶æ›´æ–°èµ„äº§æ ‡å¿—ä½
    AssetInfo memory assetInfo = getAssetInfoByAddress(asset);
    updateAssetsIn(src, assetInfo, srcCollateral, srcCollateralNew);
    updateAssetsIn(dst, assetInfo, dstCollateral, dstCollateralNew);

    // 5. æ£€æŸ¥å‘é€æ–¹æŠµæŠ¼ç‡ï¼ˆä¸ç´¯ç§¯åˆ©æ¯ï¼ŒBorrowCF < LiquidationCF æä¾›ç¼“å†²ï¼‰
    if (!isBorrowCollateralized(src)) revert NotCollateralized();

    emit TransferCollateral(src, dst, asset, amount);
}
```

### 5.3 è½¬è´¦åœºæ™¯ç¤ºä¾‹

#### åœºæ™¯1ï¼šæ™®é€šè½¬è´¦ï¼ˆåŒæ–¹éƒ½æœ‰ä¾›åº”ï¼‰

```
å‘é€æ–¹ï¼šprincipal = +10,000 USDC
æ¥æ”¶æ–¹ï¼šprincipal = +5,000 USDC
è½¬è´¦ï¼š3,000 USDC

ç»“æœï¼š
å‘é€æ–¹ï¼šprincipal = +7,000 USDCï¼ˆå‡å°‘ä¾›åº”ï¼‰
æ¥æ”¶æ–¹ï¼šprincipal = +8,000 USDCï¼ˆå¢åŠ ä¾›åº”ï¼‰
```

#### åœºæ™¯2ï¼šè½¬è´¦è§¦å‘å€Ÿè´·

```
å‘é€æ–¹ï¼šprincipal = +2,000 USDCï¼ŒæŠµæŠ¼å“ = 5 ETH
æ¥æ”¶æ–¹ï¼šprincipal = +5,000 USDC
è½¬è´¦ï¼š5,000 USDC

è¿‡ç¨‹ï¼š
1. å‘é€æ–¹å…ˆå–å‡º 2,000 USDC ä¾›åº”
2. å†å€Ÿå…¥ 3,000 USDC
3. è½¬ç»™æ¥æ”¶æ–¹ 5,000 USDC
4. æ¥æ”¶æ–¹å¢åŠ  5,000 ä¾›åº”

ç»“æœï¼š
å‘é€æ–¹ï¼šprincipal = -3,000 USDCï¼ˆè¿›å…¥å€Ÿè´·ï¼‰
æ¥æ”¶æ–¹ï¼šprincipal = +10,000 USDC
```

#### åœºæ™¯3ï¼šè½¬è´¦è‡ªåŠ¨è¿˜æ¬¾

```
å‘é€æ–¹ï¼šprincipal = +10,000 USDC
æ¥æ”¶æ–¹ï¼šprincipal = -5,000 USDCï¼ˆæœ‰å€ºåŠ¡ï¼‰
è½¬è´¦ï¼š8,000 USDC

è¿‡ç¨‹ï¼š
1. å‘é€æ–¹å‡å°‘ 8,000 ä¾›åº”
2. æ¥æ”¶æ–¹å…ˆè¿˜ 5,000 å€ºåŠ¡
3. å‰©ä½™ 3,000 æˆä¸ºä¾›åº”

ç»“æœï¼š
å‘é€æ–¹ï¼šprincipal = +2,000 USDC
æ¥æ”¶æ–¹ï¼šprincipal = +3,000 USDC
```

### 5.4 è½¬è´¦æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor Sender as å‘é€æ–¹
    actor Receiver as æ¥æ”¶æ–¹
    participant Contract as Cometåˆçº¦
    participant Storage as å­˜å‚¨å±‚

    Sender->>Contract: transfer(receiver, 5000)
    activate Contract
    
    Contract->>Contract: æ£€æŸ¥æ˜¯å¦æš‚åœ
    Contract->>Contract: æ£€æŸ¥æƒé™
    Contract->>Contract: æ£€æŸ¥ä¸æ˜¯è‡ªè½¬
    
    Contract->>Contract: accrueInternal()
    Note over Contract: ç´¯ç§¯åˆ©æ¯å’Œå¥–åŠ±
    
    Contract->>Storage: è¯»å–åŒæ–¹è´¦æˆ·
    Storage-->>Contract: srcPrincipal, dstPrincipal
    
    Contract->>Contract: è®¡ç®—æ–°ä½™é¢
    Note over Contract: srcBalance = presentValue(srcPrincipal) - 5000<br/>dstBalance = presentValue(dstPrincipal) + 5000
    
    alt å‘é€æ–¹ä½™é¢å……è¶³
        Contract->>Contract: withdrawAmount = å‡å°‘çš„ä¾›åº”
        Note over Contract: æ™®é€šè½¬è´¦
    else å‘é€æ–¹ä½™é¢ä¸è¶³
        Contract->>Contract: withdrawAmount + borrowAmount
        Note over Contract: å…ˆå–å…‰ä¾›åº”ï¼Œå†å€Ÿè´·
        
        Contract->>Contract: isBorrowCollateralized(sender)
        alt æŠµæŠ¼ä¸è¶³
            Contract-->>Sender: revert NotCollateralized()
        end
    end
    
    alt æ¥æ”¶æ–¹æœ‰å€ºåŠ¡
        Contract->>Contract: repayAmount + supplyAmount
        Note over Contract: å…ˆè¿˜å€ºï¼Œå‰©ä½™æˆä¸ºä¾›åº”
    else æ¥æ”¶æ–¹æ— å€ºåŠ¡
        Contract->>Contract: supplyAmount = å¢åŠ çš„ä¾›åº”
    end
    
    Contract->>Storage: totalSupplyBase è°ƒæ•´
    Contract->>Storage: totalBorrowBase è°ƒæ•´
    Contract->>Storage: æ›´æ–°åŒæ–¹ principal
    
    Contract->>Receiver: emit Transfer(sender, receiver, 5000)
    
    alt æœ‰ä¾›åº”å˜åŠ¨
        Contract->>Receiver: emit Transfer(sender, address(0), withdraw)
        Contract->>Receiver: emit Transfer(address(0), receiver, supply)
    end
    
    deactivate Contract
```

---

## å…­ã€æˆæƒæœºåˆ¶

### 6.1 æˆæƒç±»å‹

Comet æä¾›ä¸¤ç§æˆæƒæ–¹å¼ï¼š

#### 1. **é“¾ä¸Šæˆæƒï¼ˆapprove/allowï¼‰**

- éœ€è¦å‘é€äº¤æ˜“
- æ¶ˆè€— gas
- ç«‹å³ç”Ÿæ•ˆ

#### 2. **ç­¾åæˆæƒï¼ˆallowBySigï¼‰**

- é“¾ä¸‹ç­¾åï¼Œç¬¬ä¸‰æ–¹æäº¤
- ç”¨æˆ·æ— éœ€æ”¯ä»˜ gas
- æ”¯æŒæ‰¹é‡å’Œè‡ªåŠ¨åŒ–
- ä½¿ç”¨ EIP-712 æ ‡å‡†

### 6.2 æˆæƒæ ¸å¿ƒä»£ç 

#### ERC20 å…¼å®¹çš„ approve

**äºŒå…ƒæˆæƒ** ([ğŸ“„ CometExt.sol:186-198](https://github.com/compound-finance/comet/blob/main/contracts/CometExt.sol#L186-L198)):

```solidity
function approve(address spender, uint256 amount) override external returns (bool) {
    // æ³¨æ„ï¼šComet ä½¿ç”¨äºŒå…ƒæˆæƒï¼Œä¸åŒäºä¼ ç»Ÿ ERC20
    if (amount == type(uint256).max) {
        // æˆæƒï¼šspender å¯ä»¥ç®¡ç†æ‰€æœ‰èµ„äº§
        allowInternal(msg.sender, spender, true);
    } else if (amount == 0) {
        // å–æ¶ˆæˆæƒ
        allowInternal(msg.sender, spender, false);
    } else {
        // ä¸æ¥å—å…¶ä»–é‡‘é¢
        revert BadAmount();
    }
    return true;
}

function allowance(address owner, address spender) override external view returns (uint256) {
    // è¿”å› uint256.max æˆ– 0
    return hasPermission(owner, spender) ? type(uint256).max : 0;
}
```

#### Comet ç‰¹æœ‰çš„ allow

**ç®€å•æˆæƒ** ([ğŸ“„ CometExt.sol:219-235](https://github.com/compound-finance/comet/blob/main/contracts/CometExt.sol#L219-L235)):

```solidity
function allow(address manager, bool isAllowed_) override external {
    allowInternal(msg.sender, manager, isAllowed_);
}

function allowInternal(address owner, address manager, bool isAllowed_) internal {
    // æ›´æ–°æˆæƒçŠ¶æ€
    isAllowed[owner][manager] = isAllowed_;
    
    // å‘å‡º ERC20 å…¼å®¹äº‹ä»¶
    emit Approval(owner, manager, isAllowed_ ? type(uint256).max : 0);
}
```

#### EIP-712 ç­¾åæˆæƒ

**æ—  gas æˆæƒ** ([ğŸ“„ CometExt.sol:257-311](https://github.com/compound-finance/comet/blob/main/contracts/CometExt.sol#L257-L311)):

```solidity
function allowBySig(
    address owner,
    address manager,
    bool isAllowed_,
    uint256 nonce,
    uint256 expiry,
    uint8 v,
    bytes32 r,
    bytes32 s
) override external {
    // 1. éªŒè¯ç­¾åçš„ s å€¼ï¼ˆé˜²æ­¢ç­¾åå»¶å±•æ€§æ”»å‡»ï¼‰
    if (uint256(s) > MAX_VALID_ECDSA_S) revert InvalidValueS();
    
    // 2. éªŒè¯ç­¾åçš„ v å€¼
    if (v != 27 && v != 28) revert InvalidValueV();
    
    // 3. æ„é€  EIP-712 åŸŸåˆ†éš”ç¬¦
    bytes32 domainSeparator = keccak256(abi.encode(
        DOMAIN_TYPEHASH, 
        keccak256(bytes(name())),
        keccak256(bytes(version)),
        block.chainid,
        address(this)
    ));
    
    // 4. æ„é€ ç»“æ„åŒ–æ•°æ®å“ˆå¸Œ
    bytes32 structHash = keccak256(abi.encode(
        AUTHORIZATION_TYPEHASH,
        owner,
        manager,
        isAllowed_,
        nonce,
        expiry
    ));
    
    // 5. è®¡ç®—æœ€ç»ˆæ¶ˆæ¯æ‘˜è¦
    bytes32 digest = keccak256(abi.encodePacked("\x19\x01", domainSeparator, structHash));
    
    // 6. æ¢å¤ç­¾åè€…åœ°å€
    address signatory = ecrecover(digest, v, r, s);
    
    // 7. éªŒè¯ç­¾å
    if (signatory == address(0)) revert BadSignatory();
    if (owner != signatory) revert BadSignatory();
    if (nonce != userNonce[signatory]++) revert BadNonce();
    if (block.timestamp >= expiry) revert SignatureExpired();
    
    // 8. æ‰§è¡Œæˆæƒ
    allowInternal(signatory, manager, isAllowed_);
}
```

### 6.3 EIP-712 ç­¾åæµç¨‹

#### ç­¾åæ¶ˆæ¯ç»“æ„

```typescript
// EIP-712 Domain
const domain = {
    name: "Compound Comet",
    version: "0",
    chainId: 1,  // Mainnet
    verifyingContract: "0x..."  // Comet åœ°å€
};

// Authorization ç»“æ„
const types = {
    Authorization: [
        { name: "owner", type: "address" },
        { name: "manager", type: "address" },
        { name: "isAllowed", type: "bool" },
        { name: "nonce", type: "uint256" },
        { name: "expiry", type: "uint256" }
    ]
};

// å¾…ç­¾åçš„å€¼
const value = {
    owner: "0xUser...",
    manager: "0xManager...",
    isAllowed: true,
    nonce: 0,
    expiry: 1234567890
};

// ç”¨æˆ·ç­¾å
const signature = await signer._signTypedData(domain, types, value);
const { v, r, s } = ethers.utils.splitSignature(signature);

// ç¬¬ä¸‰æ–¹æäº¤
await comet.allowBySig(owner, manager, isAllowed, nonce, expiry, v, r, s);
```

### 6.4 æˆæƒæ—¶åºå›¾

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    actor Relayer as ä¸­ç»§è€…ï¼ˆå¯é€‰ï¼‰
    participant Contract as Cometåˆçº¦
    participant Storage as å­˜å‚¨å±‚

    Note over User,Storage: === æ–¹å¼1ï¼šé“¾ä¸Šæˆæƒ ===
    
    User->>Contract: approve(manager, uint256.max)
    activate Contract
    
    Contract->>Contract: éªŒè¯é‡‘é¢
    alt amount == uint256.max
        Contract->>Storage: isAllowed[user][manager] = true
    else amount == 0
        Contract->>Storage: isAllowed[user][manager] = false
    else å…¶ä»–é‡‘é¢
        Contract-->>User: revert BadAmount()
    end
    
    Contract->>User: emit Approval(user, manager, uint256.max)
    deactivate Contract
    
    Note over User,Storage: === æ–¹å¼2ï¼šç­¾åæˆæƒï¼ˆEIP-712ï¼‰===
    
    User->>User: é“¾ä¸‹ç”Ÿæˆç­¾å
    Note over User: 1. æ„é€ æ¶ˆæ¯<br/>2. ä½¿ç”¨ç§é’¥ç­¾å<br/>3. è·å¾— v, r, s
    
    User->>Relayer: ä¼ é€’ç­¾åå‚æ•°
    Note over User,Relayer: owner, manager, isAllowed<br/>nonce, expiry, v, r, s
    
    Relayer->>Contract: allowBySig(...)
    activate Contract
    
    Contract->>Contract: éªŒè¯ç­¾åæ ¼å¼
    Note over Contract: æ£€æŸ¥ v âˆˆ {27,28}<br/>æ£€æŸ¥ s â‰¤ MAX_VALID_S
    
    Contract->>Contract: æ„é€  EIP-712 æ¶ˆæ¯
    Note over Contract: 1. Domain Separator<br/>2. Struct Hash<br/>3. Final Digest
    
    Contract->>Contract: ecrecover(digest, v, r, s)
    Note over Contract: æ¢å¤ç­¾åè€…åœ°å€
    
    alt ç­¾åéªŒè¯å¤±è´¥
        Contract-->>Relayer: revert BadSignatory/BadNonce/Expired
    end
    
    Contract->>Storage: userNonce[owner]++
    Note over Storage: é˜²æ­¢é‡æ”¾æ”»å‡»
    
    Contract->>Storage: isAllowed[owner][manager] = isAllowed
    
    Contract->>Relayer: emit Approval(owner, manager, ...)
    deactivate Contract
    
    Relayer->>User: é€šçŸ¥æˆæƒæˆåŠŸ
```

---

---

## ä¸ƒã€å¥–åŠ±é¢†å–æµç¨‹

### 7.1 å¥–åŠ±æœºåˆ¶æ¦‚è¿°

Comet çš„å¥–åŠ±ç³»ç»Ÿï¼š

- **ç‹¬ç«‹åˆçº¦**ï¼šCometRewards.sol
- **å¥–åŠ±ä»£å¸**ï¼šé€šå¸¸æ˜¯ COMP
- **å¥–åŠ±æ¥æº**ï¼šä¾›åº”å’Œå€Ÿè´·éƒ½å¯è·å¾—å¥–åŠ±
- **ç´¯ç§¯æ–¹å¼**ï¼šè‡ªåŠ¨ç´¯ç§¯ï¼Œæ‰‹åŠ¨é¢†å–

### 7.2 å¥–åŠ±é…ç½®

**è®¾ç½®å¥–åŠ±** ([ğŸ“„ CometRewards.sol:67-89](https://github.com/compound-finance/comet/blob/main/contracts/CometRewards.sol#L67-L89)):

```solidity
function setRewardConfigWithMultiplier(address comet, address token, uint256 multiplier) public {
    if (msg.sender != governor) revert NotPermitted(msg.sender);
    if (rewardConfig[comet].token != address(0)) revert AlreadyConfigured(comet);

    // è·å– Comet çš„ç´¯ç§¯ç¼©æ”¾å› å­
    uint64 accrualScale = CometInterface(comet).baseAccrualScale();
    // è·å–å¥–åŠ±ä»£å¸çš„å°æ•°ä½æ•°
    uint8 tokenDecimals = ERC20(token).decimals();
    uint64 tokenScale = safe64(10 ** tokenDecimals);
    
    // è®¡ç®—ç¼©æ”¾å› å­
    if (accrualScale > tokenScale) {
        // éœ€è¦ç¼©å°
        rewardConfig[comet] = RewardConfig({
            token: token,
            rescaleFactor: accrualScale / tokenScale,
            shouldUpscale: false,
            multiplier: multiplier
        });
    } else {
        // éœ€è¦æ”¾å¤§
        rewardConfig[comet] = RewardConfig({
            token: token,
            rescaleFactor: tokenScale / accrualScale,
            shouldUpscale: true,
            multiplier: multiplier
        });
    }
}
```

### 7.3 å¥–åŠ±è®¡ç®—

**å¥–åŠ±å…¬å¼** ([ğŸ“„ CometRewards.sol:326-343](https://github.com/compound-finance/comet/blob/main/contracts/CometRewards.sol#L326-L343)):

```solidity
function getRewardAccrued(address comet, address account, RewardConfig memory config) 
    internal view returns (uint) {
    // 1. ä» Comet è·å–åŸå§‹ç´¯ç§¯å€¼
    uint accrued = CometInterface(comet).baseTrackingAccrued(account);

    // 2. ç²¾åº¦è½¬æ¢
    if (config.shouldUpscale) {
        // ç´¯ç§¯ç²¾åº¦ < ä»£å¸ç²¾åº¦ï¼Œéœ€è¦æ”¾å¤§
        accrued *= config.rescaleFactor;
    } else {
        // ç´¯ç§¯ç²¾åº¦ > ä»£å¸ç²¾åº¦ï¼Œéœ€è¦ç¼©å°
        accrued /= config.rescaleFactor;
    }
    
    // 3. åº”ç”¨å¥–åŠ±å€æ•°
    // multiplier = 1e18 è¡¨ç¤º 100% (1.0)
    return accrued * config.multiplier / FACTOR_SCALE;
}
```

### 7.4 å¥–åŠ±é¢†å–

**é¢†å–å‡½æ•°** ([ğŸ“„ CometRewards.sol:277-301](https://github.com/compound-finance/comet/blob/main/contracts/CometRewards.sol#L277-L301)):

```solidity
function claimInternal(address comet, address src, address to, bool shouldAccrue) internal {
    RewardConfig memory config = rewardConfig[comet];
    if (config.token == address(0)) revert NotSupported(comet);

    // 1. å¯é€‰åœ°è§¦å‘ç´¯ç§¯
    if (shouldAccrue) {
        CometInterface(comet).accrueAccount(src);
    }

    // 2. è®¡ç®—åº”å¾—å¥–åŠ±
    uint claimed = rewardsClaimed[comet][src];
    uint accrued = getRewardAccrued(comet, src, config);

    // 3. å¦‚æœæœ‰æœªé¢†å–çš„å¥–åŠ±
    if (accrued > claimed) {
        uint owed = accrued - claimed;
        
        // æ›´æ–°å·²é¢†å–è®°å½•
        rewardsClaimed[comet][src] = accrued;
        
        // è½¬è´¦å¥–åŠ±ä»£å¸
        doTransferOut(config.token, to, owed);

        emit RewardClaimed(src, to, config.token, owed);
    }
}
```

### 7.5 å¥–åŠ±é¢†å–æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant Rewards as CometRewardsåˆçº¦
    participant Comet as Cometåˆçº¦
    participant Token as COMPä»£å¸

    User->>Rewards: claim(comet, user, true)
    activate Rewards
    
    Rewards->>Rewards: æ£€æŸ¥å¥–åŠ±é…ç½®
    
    alt shouldAccrue == true
        Rewards->>Comet: accrueAccount(user)
        activate Comet
        Comet->>Comet: æ›´æ–°å¥–åŠ±ç´¯ç§¯
        Comet-->>Rewards: ç´¯ç§¯å®Œæˆ
        deactivate Comet
    end
    
    Rewards->>Comet: baseTrackingAccrued(user)
    Comet-->>Rewards: ç´¯ç§¯çš„åŸå§‹å€¼
    
    Rewards->>Rewards: getRewardAccrued()
    Note over Rewards: 1. ç²¾åº¦è½¬æ¢ï¼ˆæ”¾å¤§æˆ–ç¼©å°ï¼‰<br/>2. åº”ç”¨å€æ•°<br/>accrued Ã— rescaleFactor Ã— multiplier
    
    Rewards->>Rewards: è¯»å–å·²é¢†å–è®°å½•
    Note over Rewards: claimed = rewardsClaimed[comet][user]
    
    Rewards->>Rewards: è®¡ç®—åº”å¾—
    Note over Rewards: owed = accrued - claimed
    
    alt owed > 0
        Rewards->>Rewards: æ›´æ–°å·²é¢†å–è®°å½•
        Note over Rewards: rewardsClaimed[comet][user] = accrued
        
        Rewards->>Token: transfer(user, owed)
        activate Token
        Token-->>Rewards: è½¬è´¦æˆåŠŸ
        deactivate Token
        
        Rewards->>User: emit RewardClaimed(user, user, COMP, owed)
    else owed == 0
        Note over Rewards: æ— å¥–åŠ±å¯é¢†
    end
    
    deactivate Rewards
```

---

---

## å…«ã€å‚¨å¤‡é‡‘æå–æµç¨‹

### 8.1 å‚¨å¤‡é‡‘æœºåˆ¶

**å‚¨å¤‡é‡‘æ¥æº**ï¼š

- å€Ÿè´·åˆ©æ¯æ”¶å…¥ > ä¾›åº”åˆ©æ¯æ”¯å‡ºçš„å·®é¢
- æ¸…ç®—æƒ©ç½š
- åè®®è¿è¥æ”¶ç›Š

**å‚¨å¤‡é‡‘å…¬å¼** ([ğŸ“„ Comet.sol:511-517](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L511-L517)):

```solidity
function getReserves() override public view returns (int) {
    (uint64 baseSupplyIndex_, uint64 baseBorrowIndex_) = accruedInterestIndices(getNowInternal() - lastAccrualTime);
    
    uint balance = IERC20NonStandard(baseToken).balanceOf(address(this));  // åˆçº¦æŒæœ‰çš„åŸºç¡€èµ„äº§
    uint totalSupply_ = presentValueSupply(baseSupplyIndex_, totalSupplyBase);  // åº”ä»˜ç»™ä¾›åº”è€…
    uint totalBorrow_ = presentValueBorrow(baseBorrowIndex_, totalBorrowBase);  // å€Ÿæ¬¾è€…åº”è¿˜
    
    // å‚¨å¤‡é‡‘ = å®é™…ä½™é¢ - åº”ä»˜ä¾›åº”è€… + åº”æ”¶å€Ÿæ¬¾è€…
    return signed256(balance) - signed256(totalSupply_) + signed256(totalBorrow_);
}
```

### 8.2 æå–å‚¨å¤‡é‡‘

**åªæœ‰æ²»ç†å¯è°ƒç”¨** ([ğŸ“„ Comet.sol:1293-1302](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L1293-L1302)):

```solidity
function withdrawReserves(address to, uint amount) override external {
    // 1. æƒé™æ£€æŸ¥
    if (msg.sender != governor) revert Unauthorized();

    // 2. è®¡ç®—å½“å‰å‚¨å¤‡é‡‘
    int reserves = getReserves();
    
    // 3. æ£€æŸ¥å‚¨å¤‡é‡‘å……è¶³
    if (reserves < 0 || amount > unsigned256(reserves)) {
        revert InsufficientReserves();
    }

    // 4. è½¬å‡ºå‚¨å¤‡é‡‘
    doTransferOut(baseToken, to, amount);

    emit WithdrawReserves(to, amount);
}
```

### 8.3 å‚¨å¤‡é‡‘ç¤ºä¾‹

```
å‡è®¾ï¼š
- åˆçº¦æŒæœ‰ï¼š1,000,000 USDC
- æ€»ä¾›åº”ï¼ˆåº”ä»˜ï¼‰ï¼š900,000 USDC
- æ€»å€Ÿè´·ï¼ˆåº”æ”¶ï¼‰ï¼š850,000 USDC

å‚¨å¤‡é‡‘ = 1,000,000 - 900,000 + 850,000 = 950,000 USDC

è¿™ä¸å¯¹ï¼è®©æˆ‘é‡æ–°è®¡ç®—...

å‚¨å¤‡é‡‘ = å®é™…ä½™é¢ - åº”ä»˜ + åº”æ”¶

å¦‚æœå€Ÿæ¬¾äººæ¬  850,000ï¼Œä¾›åº”è€…è¦å– 900,000ï¼š
- æ”¶å›å€Ÿæ¬¾ï¼š+850,000
- æ”¯ä»˜ä¾›åº”è€…ï¼š-900,000
- éœ€è¦ä»å‚¨å¤‡æ‹¿ï¼š50,000

æ‰€ä»¥å‚¨å¤‡é‡‘ = 1,000,000 - 900,000 + 850,000 = 950,000?

ä¸å¯¹ï¼Œåº”è¯¥æ˜¯ï¼š
å‚¨å¤‡é‡‘ = balance - (totalSupply - totalBorrow)
       = 1,000,000 - (900,000 - 850,000)
       = 1,000,000 - 50,000
       = 950,000 USDC

æ²»ç†å¯ä»¥æå–æœ€å¤š 950,000 USDC
```

### 8.4 å‚¨å¤‡é‡‘æå–æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor Governor as æ²»ç†åœ°å€
    participant Contract as Cometåˆçº¦
    participant Token as åŸºç¡€èµ„äº§

    Governor->>Contract: withdrawReserves(treasury, 10000)
    activate Contract
    
    Contract->>Contract: æƒé™æ£€æŸ¥
    alt msg.sender != governor
        Contract-->>Governor: revert Unauthorized()
    end
    
    Contract->>Contract: getReserves()
    activate Contract
    Note over Contract: 1. ç´¯ç§¯åˆ©æ¯<br/>2. è·å–åˆçº¦ä½™é¢<br/>3. è®¡ç®—åº”ä»˜ä¾›åº”<br/>4. è®¡ç®—åº”æ”¶å€Ÿæ¬¾
    
    Contract->>Contract: è®¡ç®—å‚¨å¤‡é‡‘
    Note over Contract: reserves = balance - totalSupply + totalBorrow
    
    Contract-->>Contract: è¿”å›å‚¨å¤‡é‡‘
    deactivate Contract
    
    alt reserves < 0 æˆ– amount > reserves
        Contract-->>Governor: revert InsufficientReserves()
    end
    
    Contract->>Token: transfer(treasury, 10000)
    activate Token
    Token-->>Contract: è½¬è´¦æˆåŠŸ
    deactivate Token
    
    Contract->>Governor: emit WithdrawReserves(treasury, 10000)
    
    deactivate Contract
```

---

---

## ä¹ã€æš‚åœä¸æ¢å¤æœºåˆ¶

### 9.1 æš‚åœæœºåˆ¶è®¾è®¡

Comet ä½¿ç”¨**ä½æ ‡å¿—**ï¼ˆbit flagsï¼‰é«˜æ•ˆå­˜å‚¨ 5 ç§æš‚åœçŠ¶æ€ï¼š

```solidity
// æš‚åœæ ‡å¿—ä½
uint8 internal constant PAUSE_SUPPLY_OFFSET = 0;      // ä¾›åº”
uint8 internal constant PAUSE_TRANSFER_OFFSET = 1;    // è½¬è´¦
uint8 internal constant PAUSE_WITHDRAW_OFFSET = 2;    // å–æ¬¾
uint8 internal constant PAUSE_ABSORB_OFFSET = 3;      // æ¸…ç®—
uint8 internal constant PAUSE_BUY_OFFSET = 4;         // è´­ä¹°æŠµæŠ¼å“

// å•ä¸ª uint8 å­˜å‚¨æ‰€æœ‰æš‚åœçŠ¶æ€
// ç¤ºä¾‹ï¼š0b00010110 è¡¨ç¤ºè½¬è´¦ã€å–æ¬¾ã€è´­ä¹°è¢«æš‚åœ
```

### 9.2 æš‚åœ/æ¢å¤æ“ä½œ

**è®¾ç½®æš‚åœ** ([ğŸ“„ Comet.sol:643-661](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L643-L661)):

```solidity
function pause(
    bool supplyPaused,
    bool transferPaused,
    bool withdrawPaused,
    bool absorbPaused,
    bool buyPaused
) override external {
    // 1. æƒé™æ£€æŸ¥ï¼šgovernor æˆ– pauseGuardian
    if (msg.sender != governor && msg.sender != pauseGuardian) {
        revert Unauthorized();
    }

    // 2. æ„é€ æš‚åœæ ‡å¿—ä½
    pauseFlags =
        uint8(0) |
        (toUInt8(supplyPaused) << PAUSE_SUPPLY_OFFSET) |
        (toUInt8(transferPaused) << PAUSE_TRANSFER_OFFSET) |
        (toUInt8(withdrawPaused) << PAUSE_WITHDRAW_OFFSET) |
        (toUInt8(absorbPaused) << PAUSE_ABSORB_OFFSET) |
        (toUInt8(buyPaused) << PAUSE_BUY_OFFSET);

    emit PauseAction(supplyPaused, transferPaused, withdrawPaused, absorbPaused, buyPaused);
}
```

**æ£€æŸ¥æš‚åœçŠ¶æ€** ([ğŸ“„ Comet.sol:666-696](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L666-L696)):

```solidity
function isSupplyPaused() override public view returns (bool) {
    return toBool(pauseFlags & (uint8(1) << PAUSE_SUPPLY_OFFSET));
}

function isTransferPaused() override public view returns (bool) {
    return toBool(pauseFlags & (uint8(1) << PAUSE_TRANSFER_OFFSET));
}

// ... å…¶ä»–æ£€æŸ¥å‡½æ•°ç±»ä¼¼
```

### 9.3 æš‚åœåœºæ™¯

#### åº”æ€¥æš‚åœåœºæ™¯

1. **å‘ç°å®‰å…¨æ¼æ´**ï¼šæš‚åœæ‰€æœ‰æ“ä½œ
2. **ä»·æ ¼é¢„è¨€æœºå¼‚å¸¸**ï¼šæš‚åœä¾›åº”å’Œå€Ÿè´·
3. **æ¸…ç®—å¼‚å¸¸**ï¼šæš‚åœæ¸…ç®—åŠŸèƒ½
4. **å¸‚åœºæç«¯æ³¢åŠ¨**ï¼šæš‚åœå–æ¬¾

#### æƒé™è®¾è®¡

- **pauseGuardian**ï¼š
  - åªèƒ½æš‚åœï¼Œä¸èƒ½æ¢å¤
  - å¿«é€Ÿå“åº”ç´§æ€¥æƒ…å†µ
  - é˜²æ­¢å®ˆæŠ¤è€…æ»¥ç”¨æƒåŠ›

- **governor**ï¼š
  - å¯ä»¥æš‚åœå’Œæ¢å¤
  - éœ€è¦æ²»ç†æŠ•ç¥¨
  - å“åº”æ—¶é—´è¾ƒæ…¢ä½†æ›´å®‰å…¨

### 9.4 æš‚åœæ—¶åºå›¾

```mermaid
sequenceDiagram
    actor Guardian as pauseGuardian
    actor Governor as governor
    participant Contract as Cometåˆçº¦
    participant User as ç”¨æˆ·

    Note over Guardian,User: === åº”æ€¥æš‚åœ ===
    
    Guardian->>Contract: pause(true, true, true, true, true)
    activate Contract
    
    Contract->>Contract: æƒé™æ£€æŸ¥
    Note over Contract: guardian æˆ– governor
    
    Contract->>Contract: æ„é€ æš‚åœæ ‡å¿—
    Note over Contract: pauseFlags = 0b11111
    
    Contract->>Guardian: emit PauseAction(...)
    deactivate Contract
    
    Note over Guardian,User: === ç”¨æˆ·å°è¯•æ“ä½œ ===
    
    User->>Contract: supply(USDC, 1000)
    activate Contract
    
    Contract->>Contract: isSupplyPaused()
    Contract-->>User: revert Paused()
    deactivate Contract
    
    Note over Guardian,User: === æ²»ç†æ¢å¤ ===
    
    Governor->>Contract: pause(false, false, false, false, false)
    activate Contract
    
    Contract->>Contract: æƒé™æ£€æŸ¥ï¼ˆåªæœ‰ governorï¼‰
    Contract->>Contract: pauseFlags = 0b00000
    Contract->>Governor: emit PauseAction(...)
    deactivate Contract
    
    User->>Contract: supply(USDC, 1000)
    Contract-->>User: âœ… æˆåŠŸæ‰§è¡Œ
```

---

---

## åã€åˆå§‹åŒ–æµç¨‹

### 10.1 åˆå§‹åŒ–è®¾è®¡

Comet æ”¯æŒä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼š

1. **ç›´æ¥éƒ¨ç½²**ï¼šæ„é€ å‡½æ•° + initializeStorage
2. **ä»£ç†éƒ¨ç½²**ï¼šProxy + å®ç°åˆçº¦

### 10.2 æ„é€ å‡½æ•°

**è®¾ç½®ä¸å¯å˜å‚æ•°** ([ğŸ“„ Comet.sol:134-193](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L134-L193)):

```solidity
constructor(Configuration memory config) {
    // 1. å‚æ•°æ ¡éªŒ
    uint8 decimals_ = IERC20NonStandard(config.baseToken).decimals();
    if (decimals_ > MAX_BASE_DECIMALS) revert BadDecimals();
    if (config.storeFrontPriceFactor > FACTOR_SCALE) revert BadDiscount();
    if (config.assetConfigs.length > MAX_ASSETS) revert TooManyAssets();
    if (config.baseMinForRewards == 0) revert BadMinimum();
    if (IPriceFeed(config.baseTokenPriceFeed).decimals() != PRICE_FEED_DECIMALS) revert BadDecimals();

    // 2. å¤åˆ¶åŸºæœ¬é…ç½®ï¼ˆä¸å¯å˜å˜é‡ï¼‰
    governor = config.governor;
    pauseGuardian = config.pauseGuardian;
    baseToken = config.baseToken;
    baseTokenPriceFeed = config.baseTokenPriceFeed;
    extensionDelegate = config.extensionDelegate;
    storeFrontPriceFactor = config.storeFrontPriceFactor;

    decimals = decimals_;
    baseScale = uint64(10 ** decimals_);
    trackingIndexScale = config.trackingIndexScale;
    accrualDescaleFactor = baseScale / BASE_ACCRUAL_SCALE;

    baseMinForRewards = config.baseMinForRewards;
    baseTrackingSupplySpeed = config.baseTrackingSupplySpeed;
    baseTrackingBorrowSpeed = config.baseTrackingBorrowSpeed;
    baseBorrowMin = config.baseBorrowMin;
    targetReserves = config.targetReserves;

    // 3. è®¾ç½®åˆ©ç‡æ¨¡å‹å‚æ•°
    supplyKink = config.supplyKink;
    supplyPerSecondInterestRateBase = config.supplyPerYearInterestRateBase / SECONDS_PER_YEAR;
    supplyPerSecondInterestRateSlopeLow = config.supplyPerYearInterestRateSlopeLow / SECONDS_PER_YEAR;
    supplyPerSecondInterestRateSlopeHigh = config.supplyPerYearInterestRateSlopeHigh / SECONDS_PER_YEAR;
    
    borrowKink = config.borrowKink;
    borrowPerSecondInterestRateBase = config.borrowPerYearInterestRateBase / SECONDS_PER_YEAR;
    borrowPerSecondInterestRateSlopeLow = config.borrowPerYearInterestRateSlopeLow / SECONDS_PER_YEAR;
    borrowPerSecondInterestRateSlopeHigh = config.borrowPerYearInterestRateSlopeHigh / SECONDS_PER_YEAR;

    // 4. è®¾ç½®èµ„äº§é…ç½®ï¼ˆç´§å‡‘å­˜å‚¨ï¼‰
    numAssets = safe8(config.assetConfigs.length);
    (asset00_a, asset00_b) = getPackedAssetInternal(config.assetConfigs, 0);
    (asset01_a, asset01_b) = getPackedAssetInternal(config.assetConfigs, 1);
    // ... æœ€å¤š 15 ä¸ªèµ„äº§
}
```

### 10.3 å­˜å‚¨åˆå§‹åŒ–

**åˆå§‹åŒ–å¯å˜çŠ¶æ€** ([ğŸ“„ Comet.sol:237-248](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L237-L248)):

```solidity
function initializeStorage() override external {
    // 1. é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if (lastAccrualTime != 0) revert AlreadyInitialized();

    // 2. åˆå§‹åŒ–ç´¯ç§¯æ—¶é—´
    lastAccrualTime = getNowInternal();
    
    // 3. åˆå§‹åŒ–æŒ‡æ•°ä¸ºåŸºå‡†å€¼
    baseSupplyIndex = BASE_INDEX_SCALE;  // 1e15
    baseBorrowIndex = BASE_INDEX_SCALE;  // 1e15

    // 4. éšå¼åˆå§‹åŒ–ï¼ˆä¸å¢åŠ åˆçº¦å¤§å°ï¼‰
    // trackingSupplyIndex = 0;
    // trackingBorrowIndex = 0;
}
```

### 10.4 åˆå§‹åŒ–æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor Deployer as éƒ¨ç½²è€…
    participant Factory as CometFactory
    participant Proxy as TransparentProxy
    participant Implementation as Cometå®ç°
    participant Contract as Cometåˆçº¦

    Note over Deployer,Contract: === éƒ¨ç½²é˜¶æ®µ ===
    
    Deployer->>Factory: deploy(configuration)
    activate Factory
    
    Factory->>Implementation: new Comet(config)
    activate Implementation
    
    Implementation->>Implementation: æ„é€ å‡½æ•°æ‰§è¡Œ
    Note over Implementation: 1. å‚æ•°æ ¡éªŒ<br/>2. è®¾ç½®ä¸å¯å˜å˜é‡<br/>3. è®¾ç½®åˆ©ç‡æ¨¡å‹<br/>4. æ‰“åŒ…èµ„äº§é…ç½®
    
    Implementation-->>Factory: å®ç°åˆçº¦åœ°å€
    deactivate Implementation
    
    Factory->>Proxy: new TransparentProxy(implementation, admin, "")
    activate Proxy
    Proxy-->>Factory: ä»£ç†åˆçº¦åœ°å€
    deactivate Proxy
    
    Factory-->>Deployer: ä»£ç†åœ°å€
    deactivate Factory
    
    Note over Deployer,Contract: === åˆå§‹åŒ–é˜¶æ®µ ===
    
    Deployer->>Proxy: initializeStorage()
    activate Proxy
    
    Proxy->>Implementation: delegatecall initializeStorage()
    activate Implementation
    
    Implementation->>Implementation: æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
    alt lastAccrualTime != 0
        Implementation-->>Deployer: revert AlreadyInitialized()
    end
    
    Implementation->>Implementation: åˆå§‹åŒ–æ—¶é—´æˆ³
    Note over Implementation: lastAccrualTime = now
    
    Implementation->>Implementation: åˆå§‹åŒ–æŒ‡æ•°
    Note over Implementation: baseSupplyIndex = 1e15<br/>baseBorrowIndex = 1e15
    
    Implementation-->>Proxy: åˆå§‹åŒ–å®Œæˆ
    deactivate Implementation
    
    Proxy-->>Deployer: âœ… åˆçº¦å¯ç”¨
    deactivate Proxy
```

---

---

## åä¸€ã€æ‰¹é‡æ“ä½œï¼ˆBulkerï¼‰

### 11.1 Bulker æ¦‚è¿°

**BaseBulker** åˆçº¦å…è®¸ç”¨æˆ·åœ¨å•ç¬”äº¤æ˜“ä¸­æ‰§è¡Œå¤šä¸ª Comet æ“ä½œï¼š

- ä¾›åº”å¤šç§èµ„äº§
- æå–å¤šç§èµ„äº§
- é¢†å–å¥–åŠ±
- åŸç”Ÿä»£å¸ï¼ˆETHï¼‰åŒ…è£…/è§£åŒ…è£…

**ä¼˜åŠ¿**ï¼š

- èŠ‚çœ gas
- åŸå­æ€§æ‰§è¡Œ
- æ”¹å–„ç”¨æˆ·ä½“éªŒ

### 11.2 Bulker æ ¸å¿ƒä»£ç 

**æ‰¹é‡æ‰§è¡Œ** (`BaseBulker.sol`):

```solidity
function invoke(bytes[] calldata actions) external payable {
    for (uint i = 0; i < actions.length; ) {
        bytes calldata action = actions[i];
        bytes32 actionType = bytes32(action[:32]);
        
        handleAction(actionType, action[32:]);
        
        unchecked { i++; }
    }
    
    // è¿”è¿˜å‰©ä½™ ETH
    uint256 remainingBalance = address(this).balance;
    if (remainingBalance > 0) {
        (bool success, ) = msg.sender.call{ value: remainingBalance }("");
        if (!success) revert FailedToSendNativeToken();
    }
}
```

**æ“ä½œå¤„ç†** (`BaseBulker.sol`):

```solidity
function handleAction(bytes32 action, bytes calldata data) internal virtual {
    if (action == ACTION_SUPPLY_ASSET) {
        // ä¾›åº”èµ„äº§
        (address comet, address to, address asset, uint amount) = abi.decode(data, (address, address, address, uint));
        supplyTo(comet, to, asset, amount);
        
    } else if (action == ACTION_SUPPLY_NATIVE_TOKEN) {
        // ä¾›åº”åŸç”Ÿä»£å¸ï¼ˆETHï¼‰
        (address comet, address to, uint amount) = abi.decode(data, (address, address, uint));
        supplyNativeTokenTo(comet, to, amount);
        
    } else if (action == ACTION_WITHDRAW_ASSET) {
        // æå–èµ„äº§
        (address comet, address to, address asset, uint amount) = abi.decode(data, (address, address, address, uint));
        withdrawTo(comet, to, asset, amount);
        
    } else if (action == ACTION_WITHDRAW_NATIVE_TOKEN) {
        // æå–åŸç”Ÿä»£å¸
        (address comet, address to, uint amount) = abi.decode(data, (address, address, uint));
        withdrawNativeTokenTo(comet, to, amount);
        
    } else if (action == ACTION_CLAIM_REWARD) {
        // é¢†å–å¥–åŠ±
        (address comet, address rewards, address src, bool shouldAccrue) = 
            abi.decode(data, (address, address, address, bool));
        claimReward(comet, rewards, src, shouldAccrue);
        
    } else {
        revert UnhandledAction();
    }
}
```

### 11.3 ä½¿ç”¨ç¤ºä¾‹

```typescript
// 1. å‡†å¤‡æ‰¹é‡æ“ä½œ
const actions = [
    // ä¾›åº” ETH
    encodeSupplyNativeToken(cometAddress, userAddress, ethers.utils.parseEther("1")),
    
    // ä¾›åº” USDC
    encodeSupplyAsset(cometAddress, userAddress, usdcAddress, 1000e6),
    
    // é¢†å–å¥–åŠ±
    encodeClaimReward(cometAddress, rewardsAddress, userAddress, true)
];

// 2. æ‰§è¡Œæ‰¹é‡æ“ä½œ
await bulker.invoke(actions, { value: ethers.utils.parseEther("1") });
```

### 11.4 Bulker æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant Bulker as BaseBulker
    participant WETH as WETHåˆçº¦
    participant Comet as Cometåˆçº¦
    participant Rewards as CometRewards

    User->>Bulker: invoke(actions) + 1 ETH
    activate Bulker
    
    Note over Bulker: === Action 1: ä¾›åº” ETH ===
    
    Bulker->>Bulker: handleAction(SUPPLY_NATIVE_TOKEN)
    
    Bulker->>WETH: deposit() + 1 ETH
    activate WETH
    WETH-->>Bulker: è·å¾— 1 WETH
    deactivate WETH
    
    Bulker->>WETH: approve(comet, 1 WETH)
    
    Bulker->>Comet: supplyFrom(user, user, WETH, 1)
    activate Comet
    Note over Comet: ä»£è¡¨ç”¨æˆ·ä¾›åº”
    Comet-->>Bulker: ä¾›åº”æˆåŠŸ
    deactivate Comet
    
    Note over Bulker: === Action 2: ä¾›åº” USDC ===
    
    Bulker->>Bulker: handleAction(SUPPLY_ASSET)
    
    Bulker->>Comet: supplyFrom(user, user, USDC, 1000)
    activate Comet
    Note over Comet: ä»ç”¨æˆ·è½¬å…¥å¹¶ä¾›åº”
    Comet-->>Bulker: ä¾›åº”æˆåŠŸ
    deactivate Comet
    
    Note over Bulker: === Action 3: é¢†å–å¥–åŠ± ===
    
    Bulker->>Bulker: handleAction(CLAIM_REWARD)
    
    Bulker->>Rewards: claim(comet, user, true)
    activate Rewards
    Rewards->>Comet: accrueAccount(user)
    Rewards->>User: è½¬è´¦ COMP å¥–åŠ±
    Rewards-->>Bulker: é¢†å–æˆåŠŸ
    deactivate Rewards
    
    Note over Bulker: === æ¸…ç†é˜¶æ®µ ===
    
    Bulker->>Bulker: æ£€æŸ¥å‰©ä½™ ETH
    alt æœ‰å‰©ä½™ ETH
        Bulker->>User: è¿”è¿˜å‰©ä½™ ETH
    end
    
    deactivate Bulker
```

---

---

## åäºŒã€æ ¸å¿ƒæµç¨‹æ€»ç»“

### 12.1 æ‰€æœ‰æ ¸å¿ƒæµç¨‹æ¦‚è§ˆ

| æµç¨‹ | ä¸»è¦åˆçº¦ | Gas æˆæœ¬ | é¢‘ç‡ | æƒé™è¦æ±‚ |
|------|---------|---------|------|---------|
| **å­˜æ¬¾** | Comet | ä¸­ | é«˜ | ç”¨æˆ· |
| **å–æ¬¾** | Comet | ä¸­ | é«˜ | ç”¨æˆ· |
| **å€Ÿè´·** | Comet | ä¸­ | é«˜ | ç”¨æˆ·ï¼ˆé€šè¿‡å–æ¬¾ï¼‰ |
| **è¿˜æ¬¾** | Comet | ä¸­ | é«˜ | ç”¨æˆ·ï¼ˆé€šè¿‡å­˜æ¬¾ï¼‰ |
| **è®¡æ¯** | Comet | ä½ | è‡ªåŠ¨ | æ—  |
| **æ¸…ç®—** | Comet | é«˜ | ä¸­ | ä»»ä½•äºº |
| **è½¬è´¦** | Comet | ä¸­ | ä¸­ | ç”¨æˆ·/æˆæƒè€… |
| **æˆæƒ** | CometExt | ä½ | ä½ | ç”¨æˆ· |
| **ç­¾åæˆæƒ** | CometExt | ä¸­ | ä½ | ä¸­ç»§è€… |
| **å¥–åŠ±é¢†å–** | CometRewards | ä¸­ | ä½ | ç”¨æˆ·/æˆæƒè€… |
| **å‚¨å¤‡é‡‘æå–** | Comet | ä½ | æä½ | æ²»ç† |
| **æš‚åœ** | Comet | ä½ | æä½ | æ²»ç†/å®ˆæŠ¤è€… |
| **åˆå§‹åŒ–** | Comet | ä¸­ | ä¸€æ¬¡ | éƒ¨ç½²è€… |
| **æ‰¹é‡æ“ä½œ** | Bulker | é«˜ | ä¸­ | ç”¨æˆ· |

### 12.2 æµç¨‹é—´å…³ç³»

```
ç”¨æˆ·æ ¸å¿ƒæ“ä½œï¼š
å­˜æ¬¾ â†â†’ è¿˜æ¬¾ï¼ˆè‡ªåŠ¨ï¼‰
å–æ¬¾ â†â†’ å€Ÿè´·ï¼ˆè‡ªåŠ¨ï¼‰
è½¬è´¦ â†’ å¯èƒ½è§¦å‘å€Ÿè´·/è¿˜æ¬¾

è¾…åŠ©åŠŸèƒ½ï¼š
æˆæƒ â†’ å¯ç”¨ä»£ç†æ“ä½œ
è®¡æ¯ â†’ è‡ªåŠ¨è§¦å‘ï¼ˆæ¯æ¬¡æ“ä½œå‰ï¼‰
å¥–åŠ±é¢†å– â†’ ç‹¬ç«‹äºä¸»æµç¨‹

æ²»ç†åŠŸèƒ½ï¼š
å‚¨å¤‡é‡‘æå– â†’ åè®®æ”¶ç›Š
æš‚åœ/æ¢å¤ â†’ ç´§æ€¥æ§åˆ¶

ä¼˜åŒ–åŠŸèƒ½ï¼š
æ‰¹é‡æ“ä½œ â†’ å¤šä¸ªæ“ä½œåŸå­æ‰§è¡Œ
ç­¾åæˆæƒ â†’ æ—  gas æˆæƒ
```

### 12.3 å…³é”®è®¾è®¡æ¨¡å¼

#### 1. **è‡ªåŠ¨è§¦å‘æ¨¡å¼**

- è®¡æ¯åœ¨æ¯æ¬¡æ“ä½œå‰è‡ªåŠ¨è§¦å‘
- å–æ¬¾å¯èƒ½è‡ªåŠ¨è§¦å‘å€Ÿè´·
- å­˜æ¬¾å¯èƒ½è‡ªåŠ¨è§¦å‘è¿˜æ¬¾

#### 2. **æƒé™åˆ†å±‚æ¨¡å¼**

- ç”¨æˆ·ï¼šæ“ä½œè‡ªå·±çš„è´¦æˆ·
- æˆæƒè€…ï¼šæ“ä½œè¢«æˆæƒè´¦æˆ·
- å®ˆæŠ¤è€…ï¼šåªèƒ½æš‚åœ
- æ²»ç†ï¼šå®Œå…¨æ§åˆ¶

#### 3. **ç´§å‡‘å­˜å‚¨æ¨¡å¼**

- ä½æ ‡å¿—å­˜å‚¨æš‚åœçŠ¶æ€
- èµ„äº§ä¿¡æ¯æ‰“åŒ…å­˜å‚¨
- ç”¨æˆ·æ•°æ®å•æ§½å­˜å‚¨

#### 4. **åŸå­æ‰¹é‡æ¨¡å¼**

- Bulker æ‰¹é‡æ‰§è¡Œ
- æ¸…ç®—æ‰¹é‡å¤„ç†
- å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥

### 12.4 å®‰å…¨æœºåˆ¶æ±‡æ€»

| å®‰å…¨æœºåˆ¶ | åº”ç”¨åœºæ™¯ | ä¿æŠ¤å¯¹è±¡ |
|---------|---------|---------|
| **é‡å…¥ä¿æŠ¤** | æ‰€æœ‰çŠ¶æ€ä¿®æ”¹æ“ä½œ | åè®®èµ„é‡‘ |
| **æƒé™æ£€æŸ¥** | ä»£ç†æ“ä½œã€æ²»ç†æ“ä½œ | ç”¨æˆ·èµ„äº§ã€åè®®æ§åˆ¶ |
| **æŠµæŠ¼ç‡æ£€æŸ¥** | å€Ÿè´·ã€å–æ¬¾ã€è½¬è´¦ | åè®®å¿ä»˜èƒ½åŠ› |
| **æš‚åœæœºåˆ¶** | ç´§æ€¥æƒ…å†µ | æ•´ä½“å®‰å…¨ |
| **ç­¾åéªŒè¯** | allowBySig | ç”¨æˆ·æˆæƒ |
| **Nonce æœºåˆ¶** | ç­¾åæˆæƒ | é˜²é‡æ”¾æ”»å‡» |
| **è¿‡æœŸæ—¶é—´** | ç­¾åæˆæƒ | é˜²è¿‡æœŸç­¾å |
| **æœ€å°å€¼æ£€æŸ¥** | å€Ÿè´·é‡‘é¢ | é˜²ç°å°˜æ”»å‡» |
| **ä¾›åº”ä¸Šé™** | æŠµæŠ¼å“ä¾›åº” | å•ä¸€èµ„äº§é£é™© |

---

## åä¸‰ã€å…³é”®ç‚¹æ€»ç»“

### 13.1 æ ¸å¿ƒæµç¨‹å…³é”®ç‚¹

#### å­˜æ¬¾/å–æ¬¾

- âœ… ä½¿ç”¨ **principalï¼ˆæœ¬é‡‘ï¼‰** å­˜å‚¨ï¼Œé€šè¿‡æŒ‡æ•°è®¡ç®—å½“å‰ä»·å€¼
- âœ… è‡ªåŠ¨åŒºåˆ†**ä¾›åº”/è¿˜æ¬¾**å’Œ**å–æ¬¾/å€Ÿè´·**
- âœ… æ”¯æŒ `uint256.max` ä¸€é”®è¿˜æ¸…æˆ–å–å…‰
- âœ… æ¯æ¬¡æ“ä½œå‰è‡ªåŠ¨ç´¯ç§¯åˆ©æ¯

#### è´·æ¬¾/è¿˜æ¬¾

- âœ… **æ²¡æœ‰ç‹¬ç«‹çš„å€Ÿè´·å‡½æ•°**ï¼Œé€šè¿‡å–æ¬¾è¶…é¢è‡ªåŠ¨è§¦å‘
- âœ… principal æ­£è´Ÿè¡¨ç¤ºä¾›åº”/å€Ÿè´·çŠ¶æ€
- âœ… å€Ÿè´·éœ€è¦æ£€æŸ¥æŠµæŠ¼ç‡å’Œæœ€å°å€Ÿè´·é‡
- âœ… è¿˜æ¬¾ä¼˜å…ˆå¿è¿˜å€ºåŠ¡ï¼Œå‰©ä½™è½¬ä¸ºä¾›åº”

#### è®¡æ¯

- âœ… ä½¿ç”¨**æŒ‡æ•°ç´¯ç§¯**è€Œéçº¿æ€§ç´¯åŠ 
- âœ… **åŒæ–œç‡ Kink æ¨¡å‹**ï¼Œé¼“åŠ±é€‚åº¦åˆ©ç”¨ç‡
- âœ… ä¾›åº”å’Œå€Ÿè´·ä½¿ç”¨ä¸åŒæŒ‡æ•°
- âœ… æ¯æ¬¡æ“ä½œè‡ªåŠ¨è§¦å‘å…¨å±€ç´¯ç§¯

#### æ¸…ç®—

- âœ… ä½¿ç”¨**åè®®å¸æ”¶**æ¨¡å¼ï¼Œè€Œéæ¸…ç®—äººç›´æ¥å¿è¿˜
- âœ… **æ‰¹é‡æ¸…ç®—**æ”¯æŒï¼Œæé«˜æ•ˆç‡
- âœ… æ¸…ç®—åæŠµæŠ¼å“å¯æŠ˜ä»·è´­ä¹°
- âœ… ä¸è¶³éƒ¨åˆ†ç”±åè®®å‚¨å¤‡å¸æ”¶

### 13.2 Gas ä¼˜åŒ–æŠ€å·§

1. **ç´§å‡‘å­˜å‚¨**ï¼šUserBasic åªå  1 ä¸ª slot
2. **ä½æ ‡å¿—**ï¼šassetsIn ç”¨ 16 ä½è¡¨ç¤ºæŒæœ‰çš„èµ„äº§
3. **Immutable é…ç½®**ï¼šæ‰€æœ‰å‚æ•°ç¼–è¯‘æ—¶å†…åµŒ
4. **æ‰¹é‡æ“ä½œ**ï¼šabsorb æ”¯æŒæ‰¹é‡æ¸…ç®—
5. **æƒ°æ€§ç´¯ç§¯**ï¼šåªåœ¨éœ€è¦æ—¶æ‰ç´¯ç§¯åˆ©æ¯

### 13.3 å®‰å…¨æœºåˆ¶

1. **é‡å…¥ä¿æŠ¤**ï¼šæ‰€æœ‰å…³é”®å‡½æ•°éƒ½æœ‰ `nonReentrant`
2. **æš‚åœæœºåˆ¶**ï¼š5 ç§æ“ä½œå¯ä»¥ç‹¬ç«‹æš‚åœ
3. **æƒé™æ£€æŸ¥**ï¼š`hasPermission` éªŒè¯æ“ä½œæƒé™
4. **ä»·æ ¼éªŒè¯**ï¼šé¢„è¨€æœºä»·æ ¼å¿…é¡» > 0
5. **æº¢å‡ºæ£€æŸ¥**ï¼šè‡ªå®šä¹‰ safe å‡½æ•°é˜²æ­¢æº¢å‡º

### 13.4 æ•°å­¦ç²¾åº¦

- `BASE_INDEX_SCALE = 1e15`ï¼šæŒ‡æ•°ç²¾åº¦
- `FACTOR_SCALE = 1e18`ï¼šå› å­ç²¾åº¦ï¼ˆ100%ï¼‰
- `PRICE_SCALE = 1e8`ï¼šä»·æ ¼ç²¾åº¦
- `BASE_ACCRUAL_SCALE = 1e6`ï¼šå¥–åŠ±ç²¾åº¦

---

---

## åå››ã€å®é™…åº”ç”¨å»ºè®®

### 14.1 ç”¨æˆ·æ“ä½œå»ºè®®

**å­˜æ¬¾**ï¼š

```solidity
// å­˜å…¥åŸºç¡€èµ„äº§èµšå–åˆ©æ¯
comet.supply(USDC, 10000e6);

// å­˜å…¥æŠµæŠ¼å“ç”¨äºå€Ÿè´·
comet.supply(WETH, 5 ether);
```

**å€Ÿè´·**ï¼š

```solidity
// é€šè¿‡å–æ¬¾è§¦å‘å€Ÿè´·
comet.withdraw(USDC, 8000e6);  // è¶…è¿‡ä¾›åº”é‡å³å€Ÿè´·
```

**è¿˜æ¬¾**ï¼š

```solidity
// å­˜å…¥åŸºç¡€èµ„äº§è‡ªåŠ¨è¿˜æ¬¾
comet.supply(USDC, 3000e6);  // ä¼˜å…ˆè¿˜å€º

// ä¸€é”®è¿˜æ¸…
comet.supply(USDC, type(uint256).max);
```

### 14.2 æ¸…ç®—æœºå™¨äººå»ºè®®

**ç›‘æ§é€»è¾‘**ï¼š

```javascript
// å®šæœŸæ£€æŸ¥æ‰€æœ‰å€Ÿæ¬¾äºº
for (const borrower of borrowers) {
    const isLiquidatable = await comet.isLiquidatable(borrower);
    if (isLiquidatable) {
        // è®¡ç®—æ¸…ç®—åˆ©æ¶¦
        const profit = await estimateProfit(borrower);
        if (profit > gasĞ¡ost) {
            await comet.absorb(liquidator, [borrower]);
        }
    }
}
```

**è´­ä¹°ç­–ç•¥**ï¼š

```javascript
// ç­‰å¾…æœ€ä½³æŠ˜æ‰£
const reserves = await comet.getCollateralReserves(ETH);
if (reserves > threshold) {
    const amount = await comet.quoteCollateral(ETH, maxUSDC);
    await comet.buyCollateral(ETH, minAmount, maxUSDC, recipient);
}
```

---

## ğŸ’¡ å¦‚ä½•ä½¿ç”¨æœ¬æ–‡æ¡£

### ä»£ç é“¾æ¥å¯¼èˆª

æœ¬æ–‡æ¡£ä¸­çš„æ‰€æœ‰ä»£ç ç‰‡æ®µéƒ½åŒ…å« **å¯ç‚¹å‡»çš„æºç é“¾æ¥**ï¼ˆæ ‡è®°ä¸º ğŸ“„ï¼‰ï¼Œç‚¹å‡»åå¯ä»¥ç›´æ¥è·³è½¬åˆ° GitHub ä¸Šçš„ç›¸åº”ä»£ç ä½ç½®ã€‚

**ç¤ºä¾‹**ï¼š[ğŸ“„ Comet.sol:835-876](https://github.com/compound-finance/comet/blob/main/contracts/Comet.sol#L835-L876)

- ğŸ“„ å›¾æ ‡ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæºç é“¾æ¥
- é“¾æ¥æ ¼å¼ï¼š`æ–‡ä»¶å:èµ·å§‹è¡Œ-ç»“æŸè¡Œ`
- ç‚¹å‡»é“¾æ¥ï¼šè·³è½¬åˆ° GitHub æŸ¥çœ‹å®Œæ•´æºç å’Œä¸Šä¸‹æ–‡

### é˜…è¯»å»ºè®®

1. **è·Ÿéšé“¾æ¥æ·±å…¥é˜…è¯»**ï¼šé‡åˆ°å…³é”®ä»£ç ç‰‡æ®µæ—¶ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹å®Œæ•´å®ç°
2. **å¯¹æ¯”æ–‡æ¡£å’Œæºç **ï¼šæ–‡æ¡£æä¾›è§£é‡Šï¼Œæºç æä¾›ç»†èŠ‚
3. **æŸ¥çœ‹ä»£ç ä¸Šä¸‹æ–‡**ï¼šGitHub ä¸Šå¯ä»¥æŸ¥çœ‹å‡½æ•°çš„è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…
4. **æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬**ï¼šé“¾æ¥æŒ‡å‘ `main` åˆ†æ”¯ï¼Œå§‹ç»ˆæ˜¯æœ€æ–°ä»£ç 

---

## ç›¸å…³æ–‡æ¡£

- [ğŸ“š æ–‡æ¡£ç´¢å¼•](./INDEX.md) - æ‰€æœ‰æ–‡æ¡£çš„å¿«é€Ÿå¯¼èˆª
- [ğŸ”§ å¯å‡çº§ä»£ç†åˆçº¦åˆ†æ](./UPGRADEABLE_PROXY_ANALYSIS.md) - ä»£ç†æ¨¡å¼å’Œå‡çº§æœºåˆ¶
- [ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾ (Mermaid)](./SYSTEM_ARCHITECTURE_MERMAID.md) - å®Œæ•´çš„ç³»ç»Ÿæ¶æ„å¯è§†åŒ–
- [ğŸ” Market Admin æƒé™æ£€æŸ¥å™¨åˆ†æ](./MARKET_ADMIN_PERMISSION_CHECKER_ANALYSIS.md) - æƒé™ç®¡ç†å’Œæ²»ç†
- [ğŸš€ éƒ¨ç½²æµç¨‹åˆ†æ](../src/deploy/Network.ts) - Comet éƒ¨ç½²è„šæœ¬
- [ğŸ“– æ ¸å¿ƒç±»å›¾è¯¦è§£](./core_class_diagram.md) - è¯¦ç»†çš„ç±»ç»“æ„å’Œæ–¹æ³•è¯´æ˜
- [ğŸ“‹ å¿«é€Ÿå‚è€ƒæ‰‹å†Œ](./QUICK_REFERENCE.md) - å¸¸ç”¨æ¦‚å¿µå’Œå‘½ä»¤é€ŸæŸ¥

---

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£åç§°** | COMET_CORE_FLOWS_ANALYSIS.md |
| **æ–‡æ¡£ç±»å‹** | æŠ€æœ¯åˆ†ææ–‡æ¡£ |
| **æœ€åæ›´æ–°** | 2026å¹´1æœˆ16æ—¥ |
| **åè®®ç‰ˆæœ¬** | Compound V3 (Comet) |
| **Solidityç‰ˆæœ¬** | 0.8.15 |
| **GitHubä»“åº“** | [compound-finance/comet](https://github.com/compound-finance/comet) |
| **ä»£ç é“¾æ¥æ•°** | 37 ä¸ªæºç å¼•ç”¨é“¾æ¥ |

### ç‰¹è‰²åŠŸèƒ½

âœ… **14ä¸ªæ ¸å¿ƒæµç¨‹**å®Œæ•´è§£æ  
âœ… **37ä¸ªæºç é“¾æ¥**ç›´è¾¾ GitHub  
âœ… **13+æ—¶åºå›¾**å¯è§†åŒ–æµç¨‹  
âœ… **çœŸå®ä»£ç ç¤ºä¾‹**å’Œè¯¦ç»†æ³¨é‡Š  
âœ… **å®é™…åº”ç”¨å»ºè®®**å’Œæœ€ä½³å®è·µ
